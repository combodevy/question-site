<!--
  @file index.html
  @description È°πÁõÆ‰∏ªÂÖ•Âè£Êñá‰ª∂ (Main Entry Point)
  @author Engineer
  @date 2026-02-27
  
  Êû∂ÊûÑËØ¥Êòé (Architecture):
  ËøôÊòØ‰∏Ä‰∏™ÂçïÈ°µÂ∫îÁî® (SPA)Ôºå‰∏ç‰æùËµñÊûÑÂª∫Â∑•ÂÖ∑ (No-Build)ÔºåÁõ¥Êé•‰ΩøÁî®ÂéüÁîü ES6+ JavaScript ÁºñÂÜô„ÄÇ
  
  Ê†∏ÂøÉÊ®°Âùó (Core Modules):
  - App.auth: Â§ÑÁêÜ Supabase Ë∫´‰ªΩÈ™åËØÅ (Login/Logout)
  - App.data: ÁÆ°ÁêÜÈ¢òÂ∫ìÊï∞ÊçÆÁªìÊûÑ„ÄÅÊú¨Âú∞Â≠òÂÇ® (LocalStorage) Âíå‰∫ëÁ´ØÂêåÊ≠•
  - App.sync: Â§ÑÁêÜ‰∏éÂêéÁ´ØÁöÑÂÆûÊó∂ÂêåÊ≠•ÂíåÂÜ≤Á™ÅËß£ÂÜ≥
  - App.ai: ÈõÜÊàêÂ§ßÊ®°Âûã APIÔºåÁî®‰∫éÈ¢òÁõÆËß£ÊûêÂíåÊñáÊ°£ÂØºÂÖ•
  - App.ui: Â§ÑÁêÜÊâÄÊúâ DOM Êìç‰Ωú„ÄÅÂºπÁ™óÁÆ°ÁêÜÂíåËßÜÂõæÊ∏≤Êüì
  - App.router: ÁÆÄÂçïÁöÑ Hash Ë∑ØÁî±ÂÆûÁé∞È°µÈù¢ÂàáÊç¢
  
  ÊäÄÊúØÊ†à (Tech Stack):
  - Frontend: HTML5, Tailwind CSS (CDN), Alpine.js (Implicit via vanilla JS), Ably Realtime
  - Backend: Vercel Serverless Functions (/api/*)
  - Database: Supabase (PostgreSQL)
-->
<!DOCTYPE html>
<html lang="zh-CN" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LMS Genesis | ÁÅµÊ¥ªÈ¢òÂ∫ìÁâà (Flexible Edition)</title>

    <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3/dist/index.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Auth SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Ably Realtime SDK -->
    <script src="https://cdn.ably.com/lib/ably.min-2.js"></script>
    <!-- ÊñáÊ°£Ëß£ÊûêÂ∫ìÔºöDOCX ËΩ¨ÊñáÊú¨ -->
    <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
    <!-- ÊñáÊ°£Ëß£ÊûêÂ∫ìÔºöPDF ËΩ¨ÊñáÊú¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f0fdfa', 100: '#ccfbf1', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e' },
                        slate: { 850: '#1e293b', 900: '#0f172a' }
                    },
                    fontFamily: { sans: ['Inter', '-apple-system', 'sans-serif'] },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'pop': 'pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        pop: { '0%': { transform: 'scale(0.95)' }, '100%': { transform: 'scale(1)' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } }
                    }
                }
            }
        }
    </script>
    <script>
            (function () {
                const workerUrl = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                window.pdfjsReady = new Promise((resolve) => {
                    const check = () => {
                        if (window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions) {
                            window.pdfjsLib.GlobalWorkerOptions.workerSrc = workerUrl;
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            })();
    </script>
    <style>
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f172a;
            --sub: #64748b;
            --border: #e2e8f0;
            --accent: #0d9488;
        }

        html.dark {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --sub: #94a3b8;
            --border: #334155;
            --accent: #2dd4bf;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            transition: background 0.3s, color 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .card {
            background-color: var(--card);
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .card-interactive:active {
            transform: scale(0.98);
            background-color: var(--bg);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease-out;
            font-weight: 700;
            cursor: pointer;
            user-select: none;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        html.dark .custom-scroll::-webkit-scrollbar-thumb {
            background: #475569;
        }

        input[type="search"]::-webkit-search-cancel-button {
            display: none;
        }

        input[type="search"]::-ms-clear {
            display: none;
        }

        .opt-btn {
            transition: all 0.1s;
            border: 1px solid var(--border);
            background: var(--card);
            touch-action: manipulation;
        }

        .opt-btn:active {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .opt-btn.selected {
            border-color: var(--accent) !important;
            background-color: rgba(13, 148, 136, 0.1) !important;
            color: var(--accent) !important;
            font-weight: bold;
            box-shadow: inset 0 0 0 1px var(--accent);
        }

        .opt-btn.correct {
            border-color: #10b981 !important;
            background-color: #ecfdf5 !important;
            color: #047857 !important;
            box-shadow: none !important;
        }

        .opt-btn.wrong {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
            color: #b91c1c !important;
            box-shadow: none !important;
            animation: shake 0.4s;
        }

        .opt-btn.missed {
            border-color: #10b981 !important;
            border-style: dashed !important;
            background-color: rgba(16, 185, 129, 0.05) !important;
            color: #059669 !important;
        }

        html.dark .opt-btn.correct {
            background-color: rgba(16, 185, 129, 0.2) !important;
            color: #4ade80 !important;
        }

        html.dark .opt-btn.wrong {
            background-color: rgba(239, 68, 68, 0.2) !important;
            color: #f87171 !important;
        }

        html.dark .opt-btn.missed {
            background-color: rgba(16, 185, 129, 0.1) !important;
            color: #34d399 !important;
        }

        .hidden-panel {
            display: none;
        }

        .visible-panel {
            display: block;
            animation: fade-in 0.3s ease-out;
        }

        .rank-1 {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: white;
            border: none;
        }

        .rank-2 {
            background: linear-gradient(135deg, #e2e8f0, #94a3b8);
            color: white;
            border: none;
        }

        .rank-3 {
            background: linear-gradient(135deg, #ffedd5, #f97316);
            color: white;
            border: none;
        }

        .status-true {
            color: #10b981;
            font-weight: bold;
        }

        .status-false {
            color: #ef4444;
            font-weight: bold;
        }

        .dot-correct {
            background-color: #10b981;
        }

        .dot-wrong {
            background-color: #ef4444;
        }

        .dot-empty {
            background-color: var(--border);
        }
    </style>
</head>

<body
    class="h-screen flex flex-col overflow-hidden text-sm md:text-base selection:bg-primary-100 selection:text-primary-700">

    <!-- È°∂ÈÉ®ÂØºËà™ -->
    <header
        class="h-14 md:h-16 border-b border-[var(--border)] bg-[var(--card)] flex-none z-30 flex items-center justify-between px-4 md:px-6 shadow-sm sticky top-0 transition-colors">
        <div class="flex items-center gap-3 cursor-pointer active:opacity-70 transition-opacity"
            onclick="App.router.go('dashboard')">
            <div
                class="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-primary-500/30">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10.5L12 3l9 7.5M5 10.5V20h6v-4h2v4h6v-9.5" />
                </svg>
            </div>
            <button id="save-cloud-btn"
                class="ml-2 w-8 h-8 rounded-full border border-[var(--border)] flex items-center justify-center text-[var(--sub)] bg-[var(--card)] hover:bg-[var(--bg)] active:scale-95 transition-transform relative overflow-hidden">
                <span id="sync-indicator-icon"
                    class="w-6 h-6 rounded-full border border-[var(--border)] bg-[var(--card)] text-[10px] font-mono flex items-center justify-center select-none">0</span>
            </button>
            <div>
                <h1 class="font-bold text-sm md:text-base leading-none tracking-tight">v3.0</h1>
            </div>
        </div>
        <div class="flex gap-2 md:gap-3">
            <button onclick="App.ui.toggleTheme()"
                class="w-9 h-9 rounded-full hover:bg-[var(--border)] flex items-center justify-center text-[var(--sub)] transition-colors active:scale-90">
                <svg id="theme-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
            <button onclick="App.ui.openImportCenter('json')"
                class="w-9 h-9 rounded-full hover:bg-[var(--border)] flex items-center justify-center text-[var(--sub)] transition-colors active:scale-90"
                title="È¢òÂ∫ìÂØºÂÖ•‰∏≠ÂøÉ">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4h16v4H4zM4 12h16v8H4zM9 16h6" />
                </svg>
            </button>
            <button onclick="App.ui.openTrashModal()"
                class="w-9 h-9 rounded-full hover:bg-[var(--border)] flex items-center justify-center text-[var(--sub)] transition-colors active:scale-90"
                title="ÂõûÊî∂Á´ô">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 3h6m-7 4h8m-9 0h10l-1 13H7L6 7z" />
                </svg>
            </button>
            <button onclick="App.ui.toggleModal('config')"
                class="w-9 h-9 rounded-full hover:bg-[var(--border)] flex items-center justify-center text-[var(--sub)] transition-colors active:scale-90"
                title="ËÆæÁΩÆ">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 7h16M4 17h16M9 3v4M15 13v4" />
                </svg>
            </button>
            <button id="auth-btn"
                class="w-9 h-9 rounded-full hover:bg-[var(--border)] flex items-center justify-center text-[var(--sub)] transition-colors active:scale-90"
                title="ÁôªÂΩï">
                <svg id="auth-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM6 20c0-2.21 2.686-4 6-4s6 1.79 6 4" />
                </svg>
            </button>
        </div>
    </header>

    <main class="flex-grow overflow-y-auto p-4 md:p-6 pb-24 md:pb-6 relative custom-scroll">
        <div id="auth-overlay"
            class="fixed inset-0 z-40 flex items-center justify-center bg-black/40 backdrop-blur-sm text-xs md:text-sm">
            <div
                class="card rounded-2xl shadow-2xl bg-[var(--card)] border border-[var(--border)] px-6 py-5 flex flex-col items-center gap-3 max-w-xs text-center">
                <div
                    class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center mb-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zM6 20c0-2.21 2.686-4 6-4s6 1.79 6 4" />
                    </svg>
                </div>
                <div class="space-y-1">
                    <div class="font-bold text-[var(--text)] text-sm">ËØ∑ÂÖàÁôªÂΩï</div>
                    <div class="text-[10px] text-[var(--sub)] leading-relaxed">
                        ‰∏∫‰∫ÜÂú®ÊâÄÊúâËÆæÂ§áÈó¥ÂêåÊ≠•È¢òÂ∫ì‰∏éÂ≠¶‰π†Êï∞ÊçÆÔºå‰ΩøÁî®ÂâçÈúÄË¶ÅÂÖàÁôªÂΩïË¥¶Âè∑„ÄÇ
                    </div>
                </div>
                <button id="auth-overlay-login-btn"
                    class="mt-1 px-4 py-1.5 rounded-full bg-primary-600 text-white text-[11px] font-bold shadow-sm active:scale-95 transition-transform">
                    ÁôªÂΩï / Ê≥®ÂÜå
                </button>
            </div>
        </div>
        <div id="modal-auth"
            class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm hidden opacity-0 pointer-events-none">
            <div
                class="card w-full max-w-sm rounded-2xl shadow-2xl p-5 flex flex-col gap-4 bg-[var(--card)] border border-[var(--border)]">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-base">Ë¥¶Âè∑ÁôªÂΩï</h3>
                    <button onclick="App.ui.closeModal('auth')" class="text-[var(--sub)] hover:text-[var(--text)] p-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-[10px] text-[var(--sub)]">Áî®Êà∑Âêç</label>
                    <input id="auth-email" type="text"
                        class="px-3 py-2 rounded-lg border border-[var(--border)] bg-[var(--card)] text-xs outline-none"
                        placeholder="your_username">
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-[10px] text-[var(--sub)]">ÂØÜÁ†Å</label>
                    <input id="auth-password" type="password"
                        class="px-3 py-2 rounded-lg border border-[var(--border)] bg-[var(--card)] text-xs outline-none"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div class="flex items-center gap-2">
                    <button id="auth-login-btn"
                        class="flex-1 btn px-3 py-2.5 bg-primary-600 text-white rounded-xl text-xs font-bold active:scale-95">ÁôªÂΩï</button>
                    <button id="auth-signup-btn"
                        class="flex-1 btn px-3 py-2.5 bg-[var(--card)] border border-[var(--border)] text-[var(--text)] rounded-xl text-xs font-bold active:scale-95">Ê≥®ÂÜå</button>
                </div>
                <div id="auth-status" class="text-[10px] text-[var(--sub)]"></div>
            </div>
        </div>
        <div id="sync-toast"
            class="fixed left-4 top-16 z-40 pointer-events-none opacity-0 transition-opacity duration-300 text-xs md:text-sm">
        </div>
        <div class="max-w-6xl mx-auto flex flex-col gap-6 min-h-full">

            <!-- Dashboard View -->
            <div id="view-dashboard" class="view-section flex flex-col gap-6 md:gap-8 animate-slide-up">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
                    <div
                        class="p-3 md:p-6 rounded-xl md:rounded-2xl flex flex-col items-center justify-center bg-gradient-to-br from-primary-600 to-slate-800 text-white shadow-lg border-0">
                        <span class="text-2xl md:text-4xl font-bold mb-0.5 md:mb-1" id="dash-acc">0%</span>
                        <div class="flex flex-col items-center">
                            <span
                                class="text-[9px] md:text-[10px] uppercase opacity-70 tracking-widest text-center">ÁªºÂêàÊ≠£Á°ÆÁéá
                                (Accuracy)</span>
                            <span class="text-[9px] md:text-[10px] opacity-80 mt-1 font-mono text-primary-100"
                                id="last-practice-time">‰ªéÊú™ÁªÉ‰π†</span>
                        </div>
                    </div>
                    <div class="card card-interactive p-4 md:p-6 rounded-xl md:rounded-2xl flex flex-col justify-center relative overflow-hidden group cursor-pointer touch-manipulation"
                        onclick="App.ui.toggleModal('smart-practice')">
                        <div class="relative z-10 text-center md:text-left">
                            <h3 class="font-bold text-sm md:text-lg text-[var(--text)] mb-1">Êô∫ËÉΩÁªÉ‰π†</h3>
                            <p class="text-[10px] md:text-xs text-[var(--sub)]">AI Êé®Ëçê ‚Ä¢ È¢òÊï∞Ëá™ÈÄâ</p>
                        </div>
                        <div
                            class="hidden md:block absolute right-4 bottom-4 p-2 bg-primary-50 text-primary-600 rounded-lg group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="card card-interactive p-4 md:p-6 rounded-xl md:rounded-2xl flex flex-col justify-center relative overflow-hidden group cursor-pointer touch-manipulation"
                        onclick="App.router.go('setup')">
                        <div class="relative z-10 text-center md:text-left">
                            <h3 class="font-bold text-sm md:text-lg text-[var(--text)] mb-1">Ëá™ÂÆö‰πâ</h3>
                            <p class="text-[10px] md:text-xs text-[var(--sub)]">ÈÄâÁßëÈÄâÁ´† ‚Ä¢ ‰∏ìÈ°πÁ™ÅÁ†¥</p>
                        </div>
                        <div
                            class="hidden md:block absolute right-4 bottom-4 p-2 bg-blue-50 text-blue-600 rounded-lg group-hover:scale-110 transition-transform">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                                </path>
                            </svg>
                        </div>
                    </div>
                </div>

                <button onclick="App.router.go('analytics')"
                    class="w-full card card-interactive p-3 md:p-4 rounded-xl md:rounded-2xl flex items-center justify-between text-left active:scale-[0.99] transition-all">
                    <div class="flex items-center gap-3">
                        <span
                            class="p-2 bg-primary-50 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-lg"><svg
                                class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                </path>
                            </svg></span>
                        <div>
                            <div class="font-bold text-sm md:text-base text-[var(--text)]">Â≠¶‰π†ÂàÜÊûêÊä•Âëä (Analytics Report)
                            </div>
                            <div class="text-[10px] md:text-xs text-[var(--sub)]">ÂèØËßÜÂåñÊï∞ÊçÆÈù¢Êùø ¬∑ AI Ê∑±Â∫¶Ë°å‰∏∫Ëß£ËØª</div>
                        </div>
                    </div>
                    <svg class="w-4 h-4 md:w-5 md:h-5 text-[var(--sub)]" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                    <div class="lg:col-span-2 flex flex-col gap-3 md:gap-4">
                        <div class="flex items-center justify-between">
                            <h2 class="font-bold text-base md:text-lg flex items-center gap-2 text-[var(--text)]">
                                <svg class="w-4 h-4 md:w-5 md:h-5 text-red-500" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z">
                                    </path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"></path>
                                </svg>
                                È´òÈ¢ëÈîôÈ¢ò (Top Mistakes)
                            </h2>
                            <div class="flex items-center gap-2">
                                <label class="flex items-center gap-1.5 cursor-pointer select-none"
                                    title="ÂºÄÂêØÂêéÂ∞ÜÁî± AI ÂàÜÊûêÈîôÈ¢òÔºåÊåâÈÅóÂøòÊõ≤Á∫øÂíåËñÑÂº±Á®ãÂ∫¶Êô∫ËÉΩÊéíÂ∫è">
                                    <div class="relative">
                                        <input type="checkbox" id="ai-mode-toggle" class="sr-only peer">
                                        <div
                                            class="w-7 h-4 bg-[var(--border)] rounded-full peer-checked:bg-primary-500 transition-colors">
                                        </div>
                                        <div
                                            class="absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full shadow transition-transform peer-checked:translate-x-3">
                                        </div>
                                    </div>
                                    <span
                                        class="text-[10px] text-[var(--sub)] font-bold peer-checked:text-primary-600">üß†
                                        AI</span>
                                </label>
                                <button onclick="App.quiz.initWithAI()"
                                    class="text-[10px] md:text-xs font-bold text-red-500 bg-red-50 px-2.5 py-1 rounded-full active:bg-red-100 transition-colors whitespace-nowrap">ÈîôÈ¢òÁ™ÅÂáª
                                    ‚Üí</button>
                            </div>
                        </div>
                        <div
                            class="card flex-grow overflow-hidden rounded-xl md:rounded-2xl min-h-[300px] flex flex-col">
                            <div
                                class="grid grid-cols-12 gap-2 md:gap-4 px-4 md:px-6 py-2 md:py-3 bg-[var(--bg)] border-b border-[var(--border)] text-[9px] md:text-[10px] font-bold text-[var(--sub)] uppercase tracking-wider">
                                <div class="col-span-2">ÊéíÂêç</div>
                                <div class="col-span-8">È¢òÁõÆ‰∏éÊ≠£Á°ÆÁ≠îÊ°à</div>
                                <div class="col-span-2 text-right">ÈîôËØØÊ¨°Êï∞</div>
                            </div>
                            <div id="mistake-list" class="flex-grow overflow-y-auto custom-scroll p-0"></div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-4">
                        <div class="card p-4 md:p-5 rounded-xl md:rounded-2xl flex flex-col gap-4">
                            <!-- ‰øÆÂ§ç 2ÔºöÁªü‰∏ÄÊñáÊ°àÈÄªËæëÔºå‰∏ÉÊó•Ë∂ãÂäø‰∏éÈ¢òÂ∫ìÊÄªÈáèÊòéÁ°ÆÂå∫ÂàÜ -->
                            <div class="flex justify-between items-center border-b border-[var(--border)] pb-2 md:pb-3">
                                <span class="text-[10px] md:text-xs font-bold text-[var(--sub)] uppercase">‰∏ÉÊó•Ë∂ãÂäø (7-Day
                                    Trend)</span>
                                <div class="flex items-center gap-1.5">
                                    <span class="text-[9px] text-[var(--sub)] uppercase">È¢òÂ∫ìÊÄªÈáè</span>
                                    <span class="text-xs md:text-sm text-primary-600 font-bold" id="dash-total">0</span>
                                </div>
                            </div>
                            <div class="relative w-full h-32 md:h-40 flex items-center justify-center">
                                <div id="chart-wrapper" class="w-full h-full relative">
                                    <canvas id="dashboardChart" width="321" height="160"></canvas>
                                </div>
                                <div id="chart-empty"
                                    class="absolute inset-0 flex items-center justify-center text-xs text-[var(--sub)]">
                                    ÊöÇÊó†Êï∞ÊçÆ (No Data)</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 lg:grid-cols-1 gap-3 md:gap-4">
                            <div onclick="App.router.go('mistake_book')"
                                class="card card-interactive p-3 md:p-4 rounded-xl cursor-pointer flex flex-col md:flex-row items-center md:justify-between active:bg-[var(--bg-hover)] text-center md:text-left touch-manipulation">
                                <div class="flex flex-col md:flex-row items-center gap-2 md:gap-3">
                                    <span class="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-slate-500"><svg
                                            class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                                            </path>
                                        </svg></span>
                                    <span class="font-medium text-xs md:text-sm">ÈîôÈ¢òÊú¨</span>
                                </div>
                                <div class="text-sm md:text-xl font-bold text-red-500 mt-1 md:mt-0" id="dash-err">0
                                </div>
                            </div>
                            <div onclick="App.router.go('library')"
                                class="card card-interactive p-3 md:p-4 rounded-xl cursor-pointer flex flex-col md:flex-row items-center md:justify-between active:bg-[var(--bg-hover)] text-center md:text-left touch-manipulation">
                                <div class="flex flex-col md:flex-row items-center gap-2 md:gap-3">
                                    <span class="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-slate-500"><svg
                                            class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4">
                                            </path>
                                        </svg></span>
                                    <span class="font-medium text-xs md:text-sm">ÊÄªÈ¢òÂ∫ì</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Library View -->
            <div id="view-library" class="view-section flex flex-col h-full animate-slide-in hidden">
                <div class="card flex-grow flex flex-col rounded-xl md:rounded-2xl overflow-hidden shadow-sm relative">
                    <div
                        class="p-3 md:p-4 border-b border-[var(--border)] flex flex-col bg-[var(--bg)] sticky top-0 z-10 gap-3">
                        <div class="flex flex-wrap justify-between items-center gap-2">
                            <div class="flex items-center gap-2 md:gap-3">
                                <button onclick="App.router.go('dashboard')"
                                    class="text-[var(--sub)] active:text-primary-600"><svg class="w-5 h-5" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 19l-7-7 7-7"></path>
                                    </svg></button>
                                <h2 class="font-bold text-sm" id="lib-title">ÊÄªÈ¢òÂ∫ì</h2>
                                <span
                                    class="text-[10px] bg-primary-100 text-primary-700 px-2 py-0.5 rounded-full font-bold"
                                    id="lib-count">0</span>
                            </div>
                            <div class="flex flex-wrap items-center gap-2">
                                <select id="lib-filter" onchange="App.views.library.render()"
                                    class="text-xs bg-[var(--card)] border border-[var(--border)] rounded px-2 py-1.5 outline-none max-w-[100px]">
                                    <option value="all">ÂÖ®ÁßëÁõÆ</option>
                                </select>
                                <select id="lib-type" onchange="App.views.library.handleTypeChange()"
                                    class="text-xs bg-[var(--card)] border border-[var(--border)] rounded px-2 py-1.5 outline-none">
                                    <option value="all">ÂÖ®È¢òÂûã</option>
                                    <option value="mcq">ÂçïÈÄâ</option>
                                    <option value="tf">Âà§Êñ≠</option>
                                    <option value="multi">Â§öÈÄâ</option>
                                </select>
                                <select id="lib-sort" onchange="App.views.library.render()"
                                    class="text-xs bg-[var(--card)] border border-[var(--border)] rounded px-2 py-1.5 outline-none">
                                    <option value="default">ÈªòËÆ§</option>
                                    <option value="err_desc">ÈîôÁéá‚Üì</option>
                                    <option value="ans_asc">Á≠îÊ°àA-Z</option>
                                </select>
                                <button id="lib-toggle-expand" onclick="App.views.library.toggleExpandAll()"
                                    class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-[var(--border)] bg-[var(--card)] text-[var(--sub)] hover:bg-[var(--bg)] active:scale-95">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6h16M4 12h16M4 18h7" />
                                    </svg>
                                </button>
                                <button id="lib-manage-toggle" onclick="App.views.library.toggleManageMode()"
                                    class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-[var(--border)] bg-[var(--card)] text-[var(--sub)] hover:bg-[var(--bg)] active:scale-95">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15.232 5.232l3.536 3.536M4 20h4l9.536-9.536a2.5 2.5 0 00-3.536-3.536L8 16H4z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- ÁÆ°ÁêÜÊ®°ÂºèÂ∑•ÂÖ∑Êù° -->
                        <div id="lib-manage-bar"
                            class="hidden mt-2 flex items-center justify-between text-[10px] text-[var(--sub)]">
                            <div>Â∑≤ÈÄâ <span id="lib-selected-count" class="font-bold text-primary-600">0</span> È¢ò</div>
                            <div class="flex items-center gap-2">
                                <button onclick="App.views.library.bulkDeleteSelected()"
                                    class="px-2 py-1 rounded border border-red-200 bg-red-50 text-red-600 font-bold hover:bg-red-100 active:scale-95">Âà†Èô§</button>
                                <button onclick="App.views.library.exportSelected()"
                                    class="px-2 py-1 rounded border border-[var(--border)] bg-[var(--card)] text-[var(--sub)] hover:bg-[var(--bg)] active:scale-95">ÂØºÂá∫</button>
                            </div>
                        </div>

                        <div class="w-full relative">
                            <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-[var(--sub)] pointer-events-none"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input id="lib-search" type="search" placeholder="ÊêúÁ¥¢È¢òÁõÆ„ÄÅÈÄâÈ°π„ÄÅÁ´†ËäÇ... (Search)"
                                oninput="App.views.library.handleSearch(this.value)"
                                class="w-full text-xs bg-[var(--card)] border border-[var(--border)] rounded-lg pl-8 pr-8 py-2 outline-none focus:border-primary-500 transition-colors placeholder:text-[var(--sub)]">
                            <button id="lib-search-clear" onclick="App.views.library.clearSearch()"
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-[var(--sub)] hover:text-red-400 hidden p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div id="lib-list" class="flex-grow overflow-y-auto custom-scroll bg-[var(--card)] p-0"></div>

                    <button id="lib-back-top" onclick="App.views.library.backToTop()"
                        class="absolute bottom-4 right-4 w-9 h-9 bg-primary-600 text-white rounded-full shadow-lg flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-10 active:scale-95 hover:bg-primary-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Quiz View -->
            <div id="view-quiz"
                class="view-section hidden flex flex-col h-full max-w-3xl mx-auto w-full animate-slide-in">
                <div class="flex justify-between items-center mb-4 md:mb-6">
                    <button onclick="App.quiz.abort()"
                        class="text-xs text-[var(--sub)] hover:text-red-500 font-bold flex items-center gap-1 active:scale-95 transition-transform">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg> ÈÄÄÂá∫
                    </button>
                    <div class="text-xs md:text-sm font-mono font-bold text-primary-600 bg-primary-50 px-3 py-1 rounded-full border border-primary-100"
                        id="quiz-progress">1/10</div>
                </div>

                <div
                    class="card p-5 md:p-10 rounded-2xl md:rounded-3xl flex-grow flex flex-col relative shadow-lg border-t-4 border-t-primary-500">
                    <div class="mb-6 md:mb-8">
                        <div class="flex flex-wrap gap-2 mb-2 md:mb-3 items-center">
                            <span
                                class="px-2 py-0.5 rounded text-[9px] md:text-[10px] font-bold uppercase border border-[var(--border)] text-[var(--sub)]"
                                id="q-type">MCQ</span>
                            <span
                                class="text-[9px] md:text-[10px] font-bold text-primary-600 bg-primary-50 px-2 py-0.5 rounded truncate max-w-[120px]"
                                id="q-sub">Subject</span>
                            <span id="q-ai-tag" class="hidden text-[9px] font-bold px-2 py-0.5 rounded border"></span>
                        </div>
                        <h3 class="text-lg md:text-2xl font-medium leading-relaxed text-[var(--text)]" id="q-text">
                            Loading...</h3>
                        <div id="multi-hint"
                            class="hidden mt-2 text-xs font-bold text-primary-600 bg-primary-50 inline-block px-2 py-1 rounded border border-primary-100">
                            ‚ú® Â§öÈ°πÈÄâÊã© (ËØ∑ÈÄâÊã©ÊâÄÊúâÊ≠£Á°ÆÈÄâÈ°πÔºåÁ°ÆËÆ§Êó†ËØØÂêéÁÇπÂáª‰∏ãÊñπÊåâÈíÆ)
                        </div>
                    </div>

                    <div id="q-options" class="space-y-3 flex-grow overflow-y-auto custom-scroll pr-1 pb-4"></div>

                    <div id="multi-actions"
                        class="hidden mt-4 pt-4 border-t border-[var(--border)] text-center animate-slide-up">
                        <button onclick="App.quiz.submitMulti()"
                            class="btn w-full md:w-auto px-8 py-3 bg-primary-600 text-white rounded-xl shadow-lg shadow-primary-500/30 hover:bg-primary-700 font-bold text-sm tracking-wide active:scale-95 transition-all">
                            Á°ÆËÆ§Á≠îÊ°à (Submit)
                        </button>
                    </div>

                    <div id="quiz-feedback"
                        class="hidden mt-4 pt-4 md:pt-6 border-t border-[var(--border)] animate-fade-in">
                        <div class="flex gap-3 md:gap-4 items-start">
                            <div class="text-xl md:text-2xl mt-0.5" id="fb-icon"></div>
                            <div class="flex-grow">
                                <div class="font-bold text-sm md:text-base" id="fb-title"></div>
                                <div class="text-xs md:text-sm text-[var(--sub)] mt-1 leading-relaxed space-y-1"
                                    id="fb-desc"></div>
                            </div>
                            <button onclick="App.quiz.next()"
                                class="btn px-4 md:px-6 py-2 bg-primary-600 text-white rounded-lg text-xs md:text-sm shadow-lg active:bg-primary-700 min-w-[80px]">‰∏ã‰∏ÄÈ¢ò</button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 md:mt-6 text-center pb-4">
                    <button onclick="App.quiz.finish()"
                        class="text-xs text-red-400 hover:text-red-600 underline active:opacity-70">ÊèêÂâç‰∫§Âç∑</button>
                </div>
            </div>

            <!-- Setup View -->
            <div id="view-setup" class="view-section hidden flex flex-col h-full animate-slide-in">
                <div class="flex items-center gap-3 mb-4 md:mb-6">
                    <button onclick="App.router.go('dashboard')"
                        class="btn w-8 h-8 rounded-full bg-[var(--card)] border border-[var(--border)] text-[var(--sub)] active:text-primary-600"><svg
                            class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                            </path>
                        </svg></button>
                    <h2 class="text-lg md:text-xl font-bold">ÁªÉ‰π†ÈÖçÁΩÆ</h2>
                </div>
                <div class="card flex-grow rounded-xl md:rounded-2xl overflow-hidden flex flex-col">
                    <div class="p-4 md:p-6 overflow-y-auto custom-scroll flex-grow" id="setup-options">
                    </div>
                    <div
                        class="p-4 md:p-6 border-t border-[var(--border)] bg-[var(--bg)] flex justify-between items-center safe-pb flex-wrap gap-3">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-[var(--sub)]">È¢òÂûã:</span>
                            <select id="setup-type"
                                class="text-xs bg-[var(--card)] border border-[var(--border)] rounded px-2 py-1 outline-none">
                                <option value="all">ÂÖ®ÈÉ®</option>
                                <option value="mcq">ÂçïÈÄâ</option>
                                <option value="tf">Âà§Êñ≠</option>
                                <option value="multi">Â§öÈÄâ</option>
                            </select>
                        </div>

                        <div class="flex items-center gap-2">
                            <span class="text-xs text-[var(--sub)]">È¢òÊï∞:</span>
                            <select id="setup-limit"
                                class="text-xs bg-[var(--card)] border border-[var(--border)] rounded px-2 py-1 outline-none">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="all">Max</option>
                            </select>
                        </div>
                        <button onclick="App.quiz.init('custom')"
                            class="btn px-6 py-2.5 bg-primary-600 text-white rounded-lg shadow-md hover:bg-primary-700 text-xs md:text-sm ml-auto">ÂºÄÂßãÂà∑È¢ò</button>
                    </div>
                </div>
            </div>

            <!-- Result View -->
            <div id="view-result"
                class="view-section hidden h-full flex flex-col items-center justify-center animate-slide-in p-4">
                <div
                    class="card w-full max-w-sm p-6 md:p-8 rounded-3xl text-center shadow-2xl border-t-4 border-t-primary-500">
                    <div
                        class="w-14 h-14 md:w-16 md:h-16 mx-auto bg-primary-50 text-primary-600 rounded-full flex items-center justify-center mb-4 md:mb-6">
                        <svg class="w-7 h-7 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h2 class="text-xl md:text-2xl font-bold mb-1">ËØÑ‰º∞ÂÆåÊàê</h2>
                    <div class="text-5xl md:text-6xl font-bold text-primary-600 my-4 md:my-6 tracking-tighter"
                        id="res-score">0%</div>
                    <div class="grid grid-cols-2 gap-3 md:gap-4 text-sm mb-6 md:mb-8">
                        <div class="p-3 md:p-4 bg-green-50 text-green-700 rounded-xl border border-green-100">
                            <div class="font-bold text-[10px] uppercase opacity-70 mb-1">Correct</div>
                            <div class="text-xl md:text-2xl font-bold" id="res-correct">0</div>
                        </div>
                        <div class="p-3 md:p-4 bg-red-50 text-red-700 rounded-xl border border-red-100">
                            <div class="font-bold text-[10px] uppercase opacity-70 mb-1">Mistakes</div>
                            <div class="text-xl md:text-2xl font-bold" id="res-wrong">0</div>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="App.router.go('dashboard')"
                            class="flex-1 btn py-2.5 md:py-3 rounded-xl border border-[var(--border)] text-sm hover:bg-[var(--bg)]">ËøîÂõûÈ¶ñÈ°µ</button>
                        <button onclick="App.quiz.restart()"
                            class="flex-1 btn bg-primary-600 text-white py-2.5 md:py-3 rounded-xl text-sm active:bg-primary-700 shadow-lg">ÂÜçÁªÉ‰∏ÄÁªÑ</button>
                    </div>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="view-analytics" class="view-section hidden flex flex-col gap-6 animate-slide-up pb-8">
                <div class="flex items-center gap-3">
                    <button onclick="App.router.go('dashboard')"
                        class="btn w-8 h-8 rounded-full bg-[var(--card)] border border-[var(--border)] text-[var(--sub)] active:scale-95 transition-transform">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h2 class="text-lg font-bold">Â≠¶‰π†ÂàÜÊûê</h2>
                </div>

                <div
                    class="inline-flex mt-3 mb-1 rounded-xl border border-[var(--border)] bg-[var(--bg)] overflow-hidden text-[11px]">
                    <button id="an-tab-global" onclick="App.views.analytics.setMode('global')"
                        class="px-3 py-1.5 flex-1 text-center bg-[var(--card)] text-[var(--text)] font-bold transition-colors">ÊÄªËßà</button>
                    <button id="an-tab-subject" onclick="App.views.analytics.setMode('subject')"
                        class="px-3 py-1.5 flex-1 text-center bg-transparent text-[var(--sub)] font-bold transition-colors">ÂçïÁßëÂàÜÊûê</button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 an-global-block">
                    <div class="card p-4 rounded-xl flex flex-col gap-1">
                        <span class="text-[10px] text-[var(--sub)] uppercase font-bold">ÊÄª‰ΩúÁ≠îÊ¨°Êï∞</span>
                        <span class="text-2xl font-bold text-[var(--text)]" id="an-total-attempts">0</span>
                    </div>
                    <div class="card p-4 rounded-xl flex flex-col gap-1">
                        <span class="text-[10px] text-[var(--sub)] uppercase font-bold">ÁªºÂêàÊ≠£Á°ÆÁéá</span>
                        <span class="text-2xl font-bold text-primary-600" id="an-acc">0%</span>
                    </div>
                    <div class="card p-4 rounded-xl flex flex-col gap-1">
                        <span class="text-[10px] text-[var(--sub)] uppercase font-bold">ËøûÁª≠Â≠¶‰π†Â§©Êï∞</span>
                        <span class="text-2xl font-bold text-orange-500" id="an-streak">0Â§©</span>
                    </div>
                    <div class="card p-4 rounded-xl flex flex-col gap-1">
                        <span class="text-[10px] text-[var(--sub)] uppercase font-bold">Âπ≥Âùá‰ΩúÁ≠îÊó∂Èïø</span>
                        <span class="text-2xl font-bold text-blue-500" id="an-avg-dur">--</span>
                    </div>
                </div>

                <div class="card p-4 rounded-xl flex flex-col gap-3 an-subject-block hidden">
                    <div class="flex items-center justify-between gap-3">
                        <span class="text-xs font-bold text-[var(--sub)] uppercase">ÁßëÁõÆËßÜÂõæ</span>
                        <select id="an-subject-select"
                            class="text-[11px] bg-[var(--card)] border border-[var(--border)] rounded-lg px-2 py-1.5 outline-none min-w-[140px]">
                            <option value="all">ÂÖ®ÈÉ®ÁßëÁõÆ</option>
                        </select>
                    </div>
                    <div id="an-subject-detail"
                        class="grid grid-cols-2 md:grid-cols-4 gap-2 text-[11px] text-[var(--sub)]">
                    </div>
                </div>

                <div class="card p-4 rounded-xl md:rounded-2xl an-global-block">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-bold text-[var(--sub)] uppercase">30Â§©Â≠¶‰π†ÁÉ≠ÂäõÂõæ</span>
                    </div>
                    <div class="w-full relative h-[60px] md:h-[80px]">
                        <canvas id="heatmapChart"></canvas>
                    </div>
                    <div class="flex items-center gap-2 mt-2 justify-end">
                        <span class="text-[10px] text-[var(--sub)]">Â∞ë</span>
                        <div class="flex gap-1">
                            <div class="w-3 h-3 rounded-sm bg-slate-200 dark:bg-slate-700"></div>
                            <div class="w-3 h-3 rounded-sm bg-primary-200"></div>
                            <div class="w-3 h-3 rounded-sm bg-primary-400"></div>
                            <div class="w-3 h-3 rounded-sm bg-primary-600"></div>
                        </div>
                        <span class="text-[10px] text-[var(--sub)]">Â§ö</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 an-global-block">
                    <div class="card p-4 rounded-xl md:rounded-2xl">
                        <span class="text-xs font-bold text-[var(--sub)] uppercase block mb-3">ÂêÑÁßëÁõÆÊ≠£Á°ÆÁéá</span>
                        <div class="w-full relative min-h-[120px]"><canvas id="subjectChart"></canvas></div>
                    </div>
                    <div class="card p-4 rounded-xl md:rounded-2xl">
                        <span class="text-xs font-bold text-[var(--sub)] uppercase block mb-3">È¢òÂûãÊ≠£Á°ÆÁéáÂØπÊØî</span>
                        <div class="w-full relative min-h-[120px]"><canvas id="typeChart"></canvas></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 an-global-block">
                    <div class="card p-4 rounded-xl md:rounded-2xl flex flex-col gap-3">
                        <span class="text-xs font-bold text-[var(--sub)] uppercase">‰ΩúÁ≠îÊó∂ÈïøÂàÜÂ∏É</span>
                        <div class="flex items-center gap-4 py-2">
                            <div class="flex-shrink-0 w-[120px] h-[120px] relative"><canvas id="durChart"></canvas>
                            </div>
                            <div class="flex flex-col gap-2 text-xs flex-grow" id="dur-legend">
                            </div>
                        </div>
                    </div>
                    <div class="card p-4 rounded-xl md:rounded-2xl flex flex-col gap-3">
                        <span class="text-xs font-bold text-[var(--sub)] uppercase">ÁßëÁõÆÊ¶ÇÂÜµ</span>
                        <div class="flex flex-col gap-2 mt-2" id="an-sub-summary">
                        </div>
                    </div>
                </div>

                <div class="card p-4 rounded-xl md:rounded-2xl flex flex-col gap-3 an-subject-block hidden relative">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-bold text-[var(--sub)] uppercase">ÁßëÁõÆÁªÜËäÇÂàÜÊûê</span>
                        <span class="text-[10px] text-[var(--sub)]" id="an-subject-current-label">ÂΩìÂâçËßÜÂõæÔºöÂÖ®ÈÉ®ÁßëÁõÆ</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-1">
                        <div class="flex flex-col gap-2">
                            <div class="text-[11px] font-bold text-[var(--sub)]">ËÄóÊó∂È¢òÁõÆÊéíË°åÔºàÁÇπÂáªÈ¢òÁõÆÊü•ÁúãËØ¶ÊÉÖÔºâ</div>
                            <div id="an-sub-qtime"
                                class="space-y-1.5 text-[11px] text-[var(--sub)] max-h-56 overflow-y-auto custom-scroll">
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <div class="text-[11px] font-bold text-[var(--sub)]">ÈÅóÂøòÊõ≤Á∫øÔºà30 Â§©Ê≠£Á°ÆÁéáÔºâ</div>
                            <div class="w-full h-[80px] relative mb-1"><canvas id="anSubForgetChart"></canvas></div>
                            <div id="an-sub-forget" class="space-y-1.5 text-[11px] text-[var(--sub)]"></div>
                        </div>
                    </div>
                </div>

                <div id="an-q-popover-overlay" class="fixed inset-0 z-40 hidden"
                    onclick="App.views.analytics.hideQuestionPopover()">
                    <div id="an-q-popover"
                        class="absolute bg-[var(--card)] border border-[var(--border)] rounded-xl shadow-xl p-3 w-[min(340px,90vw)] text-[11px]"
                        onclick="event.stopPropagation()">
                    </div>
                </div>

            </div>

        </div>
        <button id="global-back-top" onclick="App.ui.scrollAllToTop()"
            class="fixed bottom-4 right-4 w-9 h-9 bg-primary-600 text-white rounded-full shadow-lg flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-40 active:scale-95 hover:bg-primary-700">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18">
                </path>
            </svg>
        </button>
    </main>

    <div id="drawer-backdrop" class="fixed inset-0 bg-black/40 z-40 hidden opacity-0 transition-opacity duration-300"
        onclick="App.ui.closeDrawer()"></div>
    <div id="insight-drawer"
        class="fixed right-0 top-0 h-full w-[85%] md:w-[400px] bg-[var(--card)] shadow-2xl z-50 transform translate-x-full transition-transform duration-300 flex flex-col">
        <div class="p-5 border-b border-[var(--border)] flex-none">
            <div class="text-[10px] text-[var(--sub)] font-bold uppercase mb-2" id="drawer-meta">Subject ‚Ä¢ Chapter</div>
            <div class="text-sm font-medium mb-4 leading-relaxed" id="drawer-q">Loading...</div>
            <div id="drawer-history" class="mb-1">
                <div class="text-xs font-bold text-[var(--sub)] mb-2 uppercase">Ëøë 5 Ê¨°‰ΩúÁ≠îËÆ∞ÂΩï (Last 5 Attempts)</div>
                <div class="flex gap-2" id="drawer-dots"></div>
            </div>
        </div>

        <div id="ai-chat-messages"
            class="flex-grow overflow-y-auto custom-scroll p-4 flex flex-col gap-3 bg-[var(--bg)]/50">
            <div id="ai-chat-welcome" class="text-xs text-[var(--sub)] text-center py-4">
                ‚ú® ÂØπËøôÈÅìÈ¢òÊúâÁñëÈóÆÔºüÂêë AI ÊèêÈóÆÂêß (Ask AI about this question)
            </div>
        </div>

        <div class="p-3 border-t border-[var(--border)] flex-none bg-[var(--card)]">
            <div class="flex gap-2 items-end">
                <textarea id="ai-chat-input" placeholder="ÈóÆÈóÆ AI... (Ask AI...)" rows="1"
                    oninput="App.ai.autoResize(this)" onkeydown="App.ai.handleKeydown(event)"
                    class="flex-grow text-xs bg-[var(--bg)] border border-[var(--border)] rounded-xl px-3 py-2 outline-none focus:border-primary-500 resize-none transition-colors max-h-24 custom-scroll shadow-sm"></textarea>
                <button onclick="App.ai.send()" id="ai-send-btn"
                    class="w-8 h-8 mb-0.5 flex-shrink-0 bg-primary-600 text-white rounded-xl flex items-center justify-center active:scale-90 transition-transform disabled:opacity-40 shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 12h14M12 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
            <div class="flex justify-between items-center mt-2 px-1">
                <button onclick="App.ai.clearChat()"
                    class="text-[10px] text-[var(--sub)] hover:text-red-400 transition-colors font-medium">Ê∏ÖÁ©∫ÂØπËØù (Clear
                    Chat)</button>
                <button onclick="App.ui.closeDrawer()"
                    class="text-[10px] text-[var(--sub)] hover:text-[var(--text)] transition-colors font-medium">ÂÖ≥Èó≠ÊäΩÂ±â
                    (Close Drawer)</button>
            </div>
        </div>
    </div>

    <!-- Á≥ªÁªüËÆæÁΩÆÂºπÁ™ó -->
    <div id="sync-log-modal"
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm opacity-0 pointer-events-none hidden">
        <div class="card w-full max-w-md rounded-2xl shadow-2xl p-0 flex flex-col max-h-[80vh] bg-[var(--card)]">
            <div class="p-4 border-b border-[var(--border)] flex justify-between items-center">
                <h3 class="font-bold text-base">‰∫ëÂêåÊ≠•ËÆ∞ÂΩï</h3>
                <button onclick="App.sync.closeLogPanel()" class="text-[var(--sub)] hover:text-[var(--text)] p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="sync-debug-panel"
                class="px-4 pt-3 pb-2 text-[11px] text-[var(--sub)] border-b border-[var(--border)]"></div>
            <div id="sync-log-list" class="p-3 overflow-y-auto custom-scroll text-xs"></div>
        </div>
    </div>

    <div id="modal-bank-manager"
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm opacity-0 pointer-events-none hidden">
        <div class="card w-full max-w-3xl rounded-2xl shadow-2xl p-0 flex flex-col max-h-[85vh] bg-[var(--card)]">
            <div class="p-4 border-b border-[var(--border)] flex justify-between items-center">
                <h3 class="font-bold text-base">ÁßëÁõÆ / Á´†ËäÇÁÆ°ÁêÜ</h3>
                <button onclick="App.ui.closeBankManager()" class="text-[var(--sub)] hover:text-[var(--text)] p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-4 md:p-5 grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] font-bold text-[var(--sub)] uppercase tracking-wider">ÁßëÁõÆ
                            (Subjects)</span>
                    </div>
                    <div id="bank-manager-subject-list" class="space-y-2 custom-scroll max-h-[60vh] pr-1"></div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] font-bold text-[var(--sub)] uppercase tracking-wider">Á´†ËäÇ
                            (Chapters)</span>
                        <span id="bank-manager-current-subject" class="text-[10px] text-primary-600 font-bold"></span>
                    </div>
                    <div id="bank-manager-chapter-list" class="space-y-2 custom-scroll max-h-[60vh] pr-1"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-smart-practice"
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm opacity-0 pointer-events-none hidden">
        <div class="card w-full max-w-sm rounded-2xl shadow-2xl p-0 flex flex-col max-h-[80vh]">
            <div
                class="p-4 border-b border-[var(--border)] flex justify-between items-center bg-[var(--bg-hover)] rounded-t-2xl">
                <h3 class="font-bold text-base">Êô∫ËÉΩÁªÉ‰π†ÈÖçÁΩÆ</h3>
                <button onclick="App.ui.closeModal('smart-practice')"
                    class="text-[var(--sub)] hover:text-[var(--text)] p-1"><svg class="w-6 h-6" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg></button>
            </div>
            <div class="p-4 overflow-y-auto custom-scroll">
                <div class="mb-4">
                    <label class="text-xs text-[var(--sub)] block mb-1 font-bold">ÈÄâÊã©È¢òÂûã (Question Type):</label>
                    <select id="smart-type"
                        class="w-full text-sm bg-[var(--card)] border border-[var(--border)] rounded-lg px-3 py-2 outline-none">
                        <option value="all">ÂÖ®ÈÉ® (All)</option>
                        <option value="mcq">ÂçïÈÄâÈ¢ò (Multiple Choice)</option>
                        <option value="tf">Âà§Êñ≠È¢ò (True/False)</option>
                        <option value="multi">Â§öÈÄâÈ¢ò (Multi-Select)</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="text-xs text-[var(--sub)] block mb-1 font-bold">È¢òÁõÆÊï∞Èáè (Question Limit):</label>
                    <select id="smart-limit"
                        class="w-full text-sm bg-[var(--card)] border border-[var(--border)] rounded-lg px-3 py-2 outline-none">
                        <option value="10">10 È¢ò</option>
                        <option value="20" selected>20 È¢ò</option>
                        <option value="50">50 È¢ò</option>
                        <option value="100">100 È¢ò</option>
                        <option value="all">ÂÖ®ÈÉ® (Max)</option>
                    </select>
                </div>
                <div class="text-xs text-[var(--sub)] mb-2 font-bold">ÈÄâÊã©ÁßëÁõÆ (Select Subjects):</div>
                <div id="smart-subjects-list" class="space-y-2"></div>
            </div>
            <div class="p-4 border-t border-[var(--border)]">
                <button onclick="if(App.quiz.init('random')) App.ui.closeModal('smart-practice')"
                    class="w-full btn py-3 bg-primary-600 text-white rounded-xl shadow-lg hover:bg-primary-700">ÂºÄÂßãÁªÉ‰π†</button>
            </div>
        </div>
    </div>

    <div id="modal-config"
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm hidden opacity-0 pointer-events-none">
        <div class="card w-full max-w-md md:max-w-lg rounded-2xl shadow-2xl p-0 flex flex-col max-h-[85vh]">
            <div
                class="p-4 md:p-5 border-b border-[var(--border)] flex justify-between items-center bg-[var(--bg-hover)] rounded-t-2xl">
                <h3 class="font-bold text-base">Á≥ªÁªüÈÖçÁΩÆ (Settings)</h3>
                <button onclick="App.ui.closeModal('config')"
                    class="text-[var(--sub)] hover:text-[var(--text)] p-1"><svg class="w-6 h-6" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg></button>
            </div>
            <div class="p-4 md:p-6 space-y-4 overflow-y-auto custom-scroll flex-grow">

                <div class="space-y-3">
                    <div class="text-xs font-bold text-[var(--sub)] uppercase tracking-wider">AI Ê®°ÂûãÈÖçÁΩÆ (AI Model Config)
                    </div>

                    <div>
                        <label class="text-[10px] text-[var(--sub)] mb-1 block">ÈÄâÊã©Ê®°ÂûãÊèê‰æõÂïÜ (Select Provider)</label>
                        <select id="config-provider-select" onchange="App.ai.onProviderChange(this.value)"
                            class="w-full text-xs bg-[var(--card)] border border-[var(--border)] rounded-xl px-3 py-2.5 outline-none focus:border-primary-500">
                            <option value="glm">üá®üá≥ GLM-4-FlashÔºàÊô∫Ë∞± AIÔºâ</option>
                            <option value="deepseek">üá®üá≥ DeepSeek-Chat</option>
                            <option value="openai">üåê GPT-4o-miniÔºàOpenAIÔºâ</option>
                            <option value="gemini">üåê Gemini 2.0 FlashÔºàGoogleÔºâ</option>
                            <option value="moonshot">üá®üá≥ Moonshot (Kimi)</option>
                            <option value="qwen">üá®üá≥ ÈÄö‰πâÂçÉÈóÆ (Qwen)</option>
                            <option value="baichuan">üá®üá≥ ÁôæÂ∑ù Baichuan</option>
                            <option value="minimax">üá®üá≥ MiniMax</option>
                            <option value="custom">üîß Ëá™ÂÆö‰πâ OpenAI ÂÖºÂÆπ API</option>
                        </select>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <label class="text-[10px] text-[var(--sub)]">API Key</label>
                            <a id="config-docs-link" href="#" target="_blank" rel="noopener"
                                class="text-[10px] text-primary-600 hover:underline">Ëé∑Âèñ Key ‚Üí</a>
                        </div>
                        <div class="flex gap-2">
                            <input type="password" id="config-api-key" placeholder="ËæìÂÖ• API KeyÔºåÂèØÊç¢Ë°åÂ°´ÂÜôÂ§ö‰∏™"
                                class="flex-grow text-xs bg-[var(--card)] border border-[var(--border)] rounded-xl px-3 py-2 outline-none focus:border-primary-500">
                            <button onclick="App.ai.saveApiKey()"
                                class="bg-primary-600 text-white px-4 py-2 rounded-xl text-xs font-bold active:scale-95 transition-transform whitespace-nowrap">‰øùÂ≠ò</button>
                        </div>
                        <div class="mt-1 text-[9px] text-[var(--sub)]">
                            Âçï‰∏™Êèê‰æõÂïÜÂèØÂ°´ÂÜôÂ§ö‰∏™ KeyÔºåÁî®Êç¢Ë°åÊàñÈÄóÂè∑ÂàÜÈöîÔºõÂè™Êúâ‰∏Ä‰∏™ Key Êó∂‰πüÂÆåÂÖ®ÊîØÊåÅ„ÄÇ
                        </div>
                    </div>

                    <div class="space-y-1">
                        <div class="flex items-center justify-between">
                            <label class="text-[10px] text-[var(--sub)]">Ëá™ÂÆö‰πâÊ®°ÂûãÂêçÁß∞ (ÂèØÈÄâ)</label>
                            <button onclick="App.ui.toggleAIAdvanced()"
                                class="text-[10px] text-[var(--sub)] hover:text-[var(--text)] px-2 py-0.5 rounded-lg border border-[var(--border)] bg-[var(--bg)]">
                                È´òÁ∫ßÂèÇÊï∞
                            </button>
                        </div>
                        <input id="config-model-name" placeholder="ÁïôÁ©∫Âàô‰ΩøÁî®ÈªòËÆ§Ê®°ÂûãÔºå‰æãÂ¶Ç glm-4-flash"
                            class="w-full text-xs bg-[var(--card)] border border-[var(--border)] rounded-xl px-3 py-2 outline-none focus:border-primary-500" />
                        <div class="mt-1 text-[9px] text-[var(--sub)]">
                            ÂèØÂ°´Âêå‰∏ÄÂéÇÂïÜ‰∏ãÁöÑ‰ªªÊÑèÂ∑≤ÂºÄÈÄöÊ®°ÂûãÂêçÁß∞ÔºåÂ¶Ç glm-4-flash„ÄÅglm-4-air Á≠â„ÄÇ
                        </div>
                    </div>

                    <div id="ai-advanced-panel"
                        class="mt-2 border border-[var(--border)] rounded-xl px-3 py-2 bg-[var(--bg)] space-y-2 hidden">
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] font-bold text-[var(--sub)]">È´òÁ∫ßÂèÇÊï∞ (Advanced Params)</span>
                            <span class="text-[9px] text-[var(--sub)]">ÂΩ±Âìç AI ÂõûÂ§çÈ£éÊ†ºÂíåÈïøÂ∫¶</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="space-y-1">
                                <div class="flex items-center gap-1">
                                    <span class="text-[10px] text-[var(--sub)]">Temperature</span>
                                    <button
                                        class="w-3 h-3 rounded-full bg-[var(--border)] flex items-center justify-center text-[8px] text-[var(--sub)]"
                                        onclick="App.ui.showAITooltip(event,'ai-tip-temperature')">?</button>
                                </div>
                                <input id="ai-param-temperature" type="number" step="0.1" min="0" max="2"
                                    class="w-full text-[10px] bg-[var(--card)] border border-[var(--border)] rounded px-2 py-1 outline-none"
                                    placeholder="0.7" />
                            </div>
                            <div class="space-y-1">
                                <div class="flex items-center gap-1">
                                    <span class="text-[10px] text-[var(--sub)]">Top P</span>
                                    <button
                                        class="w-3 h-3 rounded-full bg-[var(--border)] flex items-center justify-center text-[8px] text-[var(--sub)]"
                                        onclick="App.ui.showAITooltip(event,'ai-tip-top-p')">?</button>
                                </div>
                                <input id="ai-param-top-p" type="number" step="0.05" min="0" max="1"
                                    class="w-full text-[10px] bg-[var(--card)] border border-[var(--border)] rounded px-2 py-1 outline-none"
                                    placeholder="1.0" />
                            </div>
                            <div class="space-y-1">
                                <div class="flex items-center gap-1">
                                    <span class="text-[10px] text-[var(--sub)]">Max Tokens</span>
                                    <button
                                        class="w-3 h-3 rounded-full bg-[var(--border)] flex items-center justify-center text-[8px] text-[var(--sub)]"
                                        onclick="App.ui.showAITooltip(event,'ai-tip-max-tokens')">?</button>
                                </div>
                                <input id="ai-param-max-tokens" type="number" min="1"
                                    class="w-full text-[10px] bg-[var(--card)] border border-[var(--border)] rounded px-2 py-1 outline-none"
                                    placeholder="1024" />
                            </div>
                            <div class="space-y-1">
                                <div class="flex items-center gap-1">
                                    <span class="text-[10px] text-[var(--sub)]">Presence Penalty</span>
                                    <button
                                        class="w-3 h-3 rounded-full bg-[var(--border)] flex items-center justify-center text-[8px] text-[var(--sub)]"
                                        onclick="App.ui.showAITooltip(event,'ai-tip-presence')">?</button>
                                </div>
                                <input id="ai-param-presence" type="number" step="0.1" min="-2" max="2"
                                    class="w-full text-[10px] bg-[var(--card)] border border-[var(--border)] rounded px-2 py-1 outline-none"
                                    placeholder="0.0" />
                            </div>
                            <div class="space-y-1">
                                <div class="flex items-center gap-1">
                                    <span class="text-[10px] text-[var(--sub)]">Frequency Penalty</span>
                                    <button
                                        class="w-3 h-3 rounded-full bg-[var(--border)] flex items-center justify-center text-[8px] text-[var(--sub)]"
                                        onclick="App.ui.showAITooltip(event,'ai-tip-frequency')">?</button>
                                </div>
                                <input id="ai-param-frequency" type="number" step="0.1" min="-2" max="2"
                                    class="w-full text-[10px] bg-[var(--card)] border border-[var(--border)] rounded px-2 py-1 outline-none"
                                    placeholder="0.0" />
                            </div>
                            <div class="space-y-1">
                                <div class="flex items-center gap-1">
                                    <span class="text-[10px] text-[var(--sub)]">Timeout (ms)</span>
                                    <button
                                        class="w-3 h-3 rounded-full bg-[var(--border)] flex items-center justify-center text-[8px] text-[var(--sub)]"
                                        onclick="App.ui.showAITooltip(event,'ai-tip-timeout')">?</button>
                                </div>
                                <input id="ai-param-timeout" type="number" min="0"
                                    class="w-full text-[10px] bg-[var(--card)] border border-[var(--border)] rounded px-2 py-1 outline-none"
                                    placeholder="60000" />
                            </div>
                        </div>
                        <div class="flex items-center justify-between pt-1">
                            <span class="text-[9px] text-[var(--sub)]">Timeout Â°´ 0 Ë°®Á§∫‰∏çË∂ÖÊó∂</span>
                            <button onclick="App.ai.saveAdvancedParams()"
                                class="px-3 py-1.5 rounded-lg border border-[var(--border)] bg-[var(--card)] text-[10px] text-primary-600 font-bold hover:bg-[var(--bg)] active:scale-95">
                                ‰øùÂ≠òÈ´òÁ∫ßÂèÇÊï∞
                            </button>
                        </div>
                    </div>

                    <div class="text-[10px] text-[var(--sub)] bg-[var(--bg)] rounded-lg px-3 py-2 font-mono">
                        ÂΩìÂâçÊ®°Âûã (Current Model)Ôºö<span id="config-current-model"
                            class="text-primary-600 font-bold">--</span>
                    </div>
                </div>

                <div class="h-px bg-[var(--border)]"></div>

                <div class="space-y-2">
                    <div class="text-xs font-bold text-[var(--sub)] uppercase tracking-wider mb-2">È¢òÂ∫ìÁÆ°ÁêÜ (Data
                        Management)</div>
                    <input type="file" id="import-file" class="hidden" accept=".json"
                        onchange="App.ui.handleJsonPreviewUpload(event)">
                    <button onclick="App.ui.openBankManager()"
                        class="w-full flex items-center justify-between px-4 py-3 rounded-xl border border-primary-200 bg-primary-50 text-primary-700 active:bg-primary-100 transition-colors text-xs font-bold">
                        <span>ÁßëÁõÆ / Á´†ËäÇÁÆ°ÁêÜ (Subject / Chapter Manager)</span>
                        <svg class="w-4 h-4 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h10M4 18h7" />
                        </svg>
                    </button>
                    <button onclick="App.data.clearBank()"
                        class="w-full flex items-center justify-between px-4 py-3 rounded-xl border border-orange-200 bg-orange-50 text-orange-600 active:bg-orange-100 transition-colors text-xs font-bold">
                        <span>Ê∏ÖÁ©∫ÂΩìÂâçÈ¢òÂ∫ì (Clear Question Bank)</span>
                        <svg class="w-4 h-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                    </button>
                    <button onclick="App.ui.openSimilarReview()"
                        class="w-full flex items-center justify-between px-4 py-3 rounded-xl border border-amber-200 bg-amber-50 text-amber-700 active:bg-amber-100 transition-colors text-xs font-bold">
                        <span>Áñë‰ººÁõ∏‰ººÈ¢òÂÆ°Êü• (Duplicate Review)</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12h.01M9 12h.01M11.5 17.5c1.657 0 3-1.12 3-2.5h-6c0 1.38 1.343 2.5 3 2.5zm0-13C6.813 4.5 3.5 7.567 3.5 11.25c0 2.485 1.507 4.652 3.772 5.7l-.772 2.8 3.25-1.95a8 8 0 003.0.65c4.687 0 8-3.067 8-6.75S16.187 4.5 11.5 4.5z" />
                        </svg>
                    </button>
                </div>
                <div class="h-px bg-[var(--border)]"></div>
                <div class="space-y-2">
                    <button onclick="App.data.resetHistory()"
                        class="w-full flex items-center justify-between px-4 py-3 rounded-xl border border-red-200 bg-red-50 text-red-600 active:bg-red-100 transition-colors text-xs font-bold">
                        <span>ÈáçÁΩÆÂà∑È¢òËÆ∞ÂΩï (Reset Practice History)</span>
                        <svg class="w-4 h-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- È¢òÂ∫ìÂØºÂÖ•‰∏≠ÂøÉÂºπÁ™ó -->
    <div id="modal-import-center"
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm hidden opacity-0 pointer-events-none">
        <div class="card w-full max-w-4xl rounded-2xl shadow-2xl p-0 flex flex-col max-h-[85vh]">
            <div
                class="p-4 border-b border-[var(--border)] flex justify-between items-center bg-[var(--bg-hover)] rounded-t-2xl">
                <h3 class="font-bold text-base">È¢òÂ∫ìÂØºÂÖ•‰∏≠ÂøÉ (Import Center)</h3>
                <button onclick="App.ui.closeModal('import-center')"
                    class="text-[var(--sub)] hover:text-[var(--text)] p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="p-4 md:p-6 space-y-4 overflow-y-auto custom-scroll flex-grow text-xs">
                <div class="flex items-center justify-between gap-3">
                    <p class="text-[11px] text-[var(--sub)] leading-relaxed">
                        ÂÖàÂú®Ê≠§Â§ÑÈ¢ÑËßàÈ¢òÂ∫ìÁªìÊûÑÂíåÊØè‰∏ÄÈÅìÈ¢òÁöÑÂΩíÂ±ûÔºåÂÜçÂÜ≥ÂÆöÊòØÂê¶ÁúüÊ≠£ÂØºÂÖ•Âà∞ÂΩìÂâçÈ¢òÂ∫ì„ÄÇ
                    </p>
                    <div
                        class="inline-flex rounded-xl border border-[var(--border)] bg-[var(--bg)] overflow-hidden text-[11px]">
                        <button id="import-tab-btn-json" onclick="App.ui.switchImportTab('json')"
                            class="px-3 py-1.5 flex-1 text-center bg-[var(--card)] text-[var(--text)] font-bold transition-colors">JSON
                            Êñá‰ª∂</button>
                        <button id="import-tab-btn-ai" onclick="App.ui.switchImportTab('ai')"
                            class="px-3 py-1.5 flex-1 text-center bg-transparent text-[var(--sub)] font-bold transition-colors">AI
                            ÊñáÊ°£ÂØºÂÖ•</button>
                    </div>
                </div>

                <!-- JSON ÂØºÂÖ•È¢ÑËßà -->
                <div id="import-tab-json" class="space-y-3">
                    <div class="flex flex-wrap items-center justify-between gap-2">
                        <div class="flex flex-wrap items-center gap-2">
                            <button onclick="document.getElementById('import-file').click()"
                                class="px-3 py-2 rounded-xl border border-blue-200 bg-blue-50 text-blue-700 text-xs font-bold flex items-center gap-1.5 active:scale-95 transition-transform">
                                ÈÄâÊã© JSON Êñá‰ª∂‚Ä¶
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5-5m0 0l5 5m-5-5v12"></path>
                                </svg>
                            </button>
                            <button onclick="App.ui.downloadTemplate()"
                                class="px-3 py-2 rounded-xl border border-[var(--border)] bg-[var(--card)] text-[var(--text)] text-xs font-bold flex items-center gap-1.5 active:scale-95 transition-transform">
                                ‰∏ãËΩΩÊ†ºÂºèÊ®°Êùø
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                            </button>
                        </div>
                        <span id="import-json-status"
                            class="flex-1 text-[10px] text-right text-[var(--sub)] truncate min-w-[100px]">Â∞öÊú™ÈÄâÊã©Êñá‰ª∂</span>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
                        <div class="p-2 rounded-lg border border-[var(--border)] bg-[var(--card)]">
                            <div class="text-[9px] text-[var(--sub)] uppercase font-bold">Ê£ÄÊµãÂà∞È¢òÁõÆ</div>
                            <div id="import-json-total" class="text-lg font-bold text-[var(--text)] mt-0.5">0</div>
                        </div>
                        <div class="p-2 rounded-lg border border-[var(--border)] bg-[var(--card)]">
                            <div class="text-[9px] text-[var(--sub)] uppercase font-bold">ÁßëÁõÆÊï∞Èáè</div>
                            <div id="import-json-subjects" class="text-lg font-bold text-[var(--text)] mt-0.5">0</div>
                        </div>
                        <div class="p-2 rounded-lg border border-[var(--border)] bg-[var(--card)]">
                            <div class="text-[9px] text-[var(--sub)] uppercase font-bold">Á´†ËäÇÊï∞Èáè</div>
                            <div id="import-json-chapters" class="text-lg font-bold text-[var(--text)] mt-0.5">0</div>
                        </div>
                        <div class="p-2 rounded-lg border border-[var(--border)] bg-[var(--card)]">
                            <div class="text-[9px] text-[var(--sub)] uppercase font-bold">ÂçïÈÄâÈ¢ò (MCQ)</div>
                            <div id="import-json-mcq" class="text-lg font-bold text-[var(--text)] mt-0.5">0</div>
                        </div>
                        <div class="p-2 rounded-lg border border-[var(--border)] bg-[var(--card)]">
                            <div class="text-[9px] text-[var(--sub)] uppercase font-bold">Â§öÈÄâÈ¢ò (Multi)</div>
                            <div id="import-json-multi" class="text-lg font-bold text-[var(--text)] mt-0.5">0</div>
                        </div>
                        <div class="p-2 rounded-lg border border-[var(--border)] bg-[var(--card)]">
                            <div class="text-[9px] text-[var(--sub)] uppercase font-bold">Âà§Êñ≠È¢ò (TF)</div>
                            <div id="import-json-tf" class="text-lg font-bold text-[var(--text)] mt-0.5">0</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-[11px] font-bold text-[var(--sub)]">ÊåâÁßëÁõÆ / Á´†ËäÇÂàÜÂ∏É</span>
                            </div>
                            <div id="import-json-struct"
                                class="border border-[var(--border)] rounded-xl p-2 bg-[var(--bg)] max-h-56 overflow-y-auto custom-scroll text-[11px] text-[var(--sub)]">
                                <div class="text-[10px] text-[var(--sub)] italic">ËØ∑ÈÄâÊã© JSON Êñá‰ª∂ÂêéÊü•ÁúãÁßëÁõÆÂíåÁ´†ËäÇÂàÜÂ∏É„ÄÇ</div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-[11px] font-bold text-[var(--sub)]">È¢òÁõÆÈ¢ÑËßàÔºàÊúÄÂ§öÂ±ïÁ§∫Ââç 50 ÈÅìÔºâ</span>
                            </div>
                            <div id="import-json-list"
                                class="border border-[var(--border)] rounded-xl p-2 bg-[var(--bg)] max-h-56 overflow-y-auto custom-scroll text-[11px] text-[var(--sub)] space-y-1.5">
                                <div class="text-[10px] text-[var(--sub)] italic">ÊöÇÊó†È¢ÑËßàÔºåËØ∑ÂÖàÈÄâÊã© JSON Êñá‰ª∂„ÄÇ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI ÂØºÂÖ•ËØ¥Êòé -->
                <div id="import-tab-ai" class="space-y-3 hidden">
                    <div class="text-[11px] text-[var(--sub)] leading-relaxed">
                        AI ÂØºÂÖ•ÈÄÇÂêà‰ªé Word / PDF / ÊñáÊú¨‰∏≠Ëá™Âä®ÊäΩÂèñÈÄâÊã©È¢òÂíåÂà§Êñ≠È¢òÔºåÂπ∂ÁîüÊàê JSON È¢ÑËßàÂêéÂØºÂÖ•È¢òÂ∫ì„ÄÇ
                    </div>
                    <div
                        class="border border-dashed border-purple-200 rounded-xl p-3 bg-purple-50/40 flex flex-col gap-2">
                        <div class="text-[11px] text-purple-700 font-bold">AI ÊñáÊ°£ÂØºÂÖ•ÊµÅÁ®ã</div>
                        <ol class="list-decimal list-inside text-[11px] text-purple-700 space-y-0.5">
                            <li>‰∏ä‰º†ÂåÖÂê´ËØïÈ¢òÁöÑ .txt / .md / .docx / .pdf Êñá‰ª∂ÔºåÊàñÁ≤òË¥¥ÂéüÂßãËØïÈ¢òÊñáÊú¨„ÄÇ</li>
                            <li>ÁÇπÂáª„ÄåÁîüÊàê JSON È¢ÑËßà„ÄçÔºåÂú® AI ÂºπÁ™ó‰∏≠Ê£ÄÊü•È¢òÂ∫ìÁªìÊûÑÂíåÈ¢òÁõÆÂÜÖÂÆπ„ÄÇ</li>
                            <li>Á°ÆËÆ§Êó†ËØØÂêéÔºåÂÜçÁÇπÂáª„ÄåÂØºÂÖ•È¢ÑËßà JSON Âà∞È¢òÂ∫ì„Äç„ÄÇ</li>
                        </ol>
                        <div class="pt-1">
                            <button onclick="App.ui.toggleModal('ai-import')"
                                class="px-3 py-2 rounded-xl border border-purple-300 bg-white text-purple-700 text-xs font-bold flex items-center gap-1.5 active:scale-95 transition-transform">
                                ÊâìÂºÄ AI ÂØºÂÖ•Èù¢Êùø
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-[var(--border)] bg-[var(--bg)] flex justify-end gap-3 rounded-b-2xl">
                <button onclick="App.ui.closeModal('import-center')"
                    class="btn px-3 py-2.5 bg-[var(--card)] border border-[var(--border)] text-[var(--text)] rounded-xl text-[11px] shadow-sm hover:bg-[var(--bg-hover)] active:scale-95">
                    ÂÖ≥Èó≠
                </button>
                <button id="import-json-apply-btn" onclick="App.ui.applyJsonPreviewImport()"
                    class="btn px-4 py-2.5 bg-primary-600 text-white rounded-xl text-xs md:text-sm shadow-md hover:bg-primary-700 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed"
                    disabled>
                    ÂØºÂÖ•È¢ÑËßà‰∏≠ÁöÑÈ¢òÁõÆ
                </button>
            </div>
        </div>
    </div>

    <!-- AI ÊñáÊ°£ËØÜÂà´ÂØºÂÖ•È¢òÂ∫ìÂºπÁ™ó -->
    <div id="modal-ai-import"
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm hidden opacity-0 pointer-events-none">
        <div class="card w-full max-w-lg rounded-2xl shadow-2xl p-0 flex flex-col max-h-[85vh]">
            <div
                class="p-4 border-b border-[var(--border)] flex justify-between items-center bg-[var(--bg-hover)] rounded-t-2xl">
                <h3 class="font-bold text-base">AI ËØÜÂà´ÊñáÊ°£ÁîüÊàêÈ¢òÂ∫ì</h3>
                <button onclick="App.ui.closeModal('ai-import')" class="text-[var(--sub)] hover:text-[var(--text)] p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="p-4 md:p-5 space-y-3 overflow-y-auto custom-scroll">
                <p class="text-xs text-[var(--sub)] leading-relaxed">
                    1Ô∏è‚É£ ‰∏ä‰º†ÂåÖÂê´ËØïÈ¢òÁöÑÊñáÊ°£ÔºàÊîØÊåÅ <span class="font-mono">.txt / .md / .docx / .pdf</span>ÔºâÊàñÁõ¥Êé•Âú®‰∏ãÊñπÊñáÊú¨Ê°ÜÁ≤òË¥¥ËØïÈ¢òÂéüÊñá„ÄÇ<br>
                    2Ô∏è‚É£ ÁÇπÂáª„ÄåAI ËØÜÂà´Âπ∂ÂØºÂÖ•„ÄçÔºåÁ≥ªÁªü‰ºöË∞ÉÁî®Â∑≤ÈÖçÁΩÆÁöÑÂ§ßÊ®°ÂûãËá™Âä®ÊäΩÂèñÈÄâÊã©È¢ò / Âà§Êñ≠È¢òÂπ∂ÊéíÁâàÊàêÈ¢òÂ∫ì JSONÔºåÁõ¥Êé•ÂêàÂπ∂ËøõÂΩìÂâçÈ¢òÂ∫ì„ÄÇ
                </p>
                <div class="space-y-2">
                    <div class="flex items-center justify-between gap-2">
                        <button onclick="document.getElementById('ai-import-file').click()"
                            class="px-3 py-2 rounded-xl border border-purple-200 bg-purple-50 text-purple-700 text-xs font-bold flex items-center gap-1.5 active:scale-95 transition-transform">
                            ÈÄâÊã©ÊñáÊ°£Êñá‰ª∂‚Ä¶
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5-5m0 0l5 5m-5-5v12"></path>
                            </svg>
                        </button>
                        <span id="ai-import-file-name"
                            class="flex-1 text-[10px] text-right text-[var(--sub)] truncate">Êú™ÈÄâÊã©Êñá‰ª∂</span>
                    </div>
                    <input type="file" id="ai-import-file" class="hidden" accept=".txt,.md,.docx,.pdf"
                        onchange="App.ui.handleAIImportFile(event)">
                </div>
                <div class="space-y-1">
                    <label for="ai-import-raw" class="text-[11px] text-[var(--sub)] font-bold">ÂéüÂßãËØïÈ¢òÊñáÊú¨ÔºàÂèØÁºñËæëÔºåÂèØÁõ¥Êé•Á≤òË¥¥Ôºâ</label>
                    <textarea id="ai-import-raw" rows="6"
                        class="w-full text-xs bg-[var(--card)] border border-[var(--border)] rounded-xl px-3 py-2 outline-none focus:border-primary-500 custom-scroll leading-relaxed"
                        placeholder="Á§∫‰æãÔºö&#10;„ÄêÂçïÈÄâÈ¢ò„Äë‰ª•‰∏ãÂì™È°πÊòØ‚Ä¶‚Ä¶Ôºü&#10;A. ÈÄâÈ°π‰∏Ä&#10;B. ÈÄâÈ°π‰∫å&#10;C. ÈÄâÈ°π‰∏â&#10;D. ÈÄâÈ°πÂõõ&#10;Ê≠£Á°ÆÁ≠îÊ°àÔºöB&#10;&#10;„ÄêÂà§Êñ≠È¢ò„Äë‚Ä¶‚Ä¶ËØ¥Ê≥ïÊòØÂê¶Ê≠£Á°ÆÔºüÔºà   Ôºâ&#10;Ê≠£Á°ÆÁ≠îÊ°àÔºöT / F"></textarea>
                </div>
                <div class="space-y-1">
                    <label for="ai-import-preview"
                        class="text-[11px] text-[var(--sub)] font-bold flex items-center justify-between">
                        <span>AI ËæìÂá∫ JSON È¢ÑËßàÔºàÂè™ËØªÔºâ</span>
                        <span class="text-[10px] opacity-70">ËØ∑Á°ÆËÆ§ÁªìÊûÑÊ≠£Á°ÆÂÜçÂØºÂÖ•</span>
                    </label>
                    <textarea id="ai-import-preview" rows="8"
                        class="w-full text-[11px] font-mono bg-[var(--card)] border border-[var(--border)] rounded-xl px-3 py-2 outline-none custom-scroll leading-relaxed"
                        readonly placeholder="ÁÇπÂáª‰∏ãÊñπ„ÄåÁîüÊàê JSON È¢ÑËßà„ÄçÂêéÔºå‰ºöÂú®ËøôÈáåÊòæÁ§∫ AI ÁîüÊàêÁöÑÈ¢òÂ∫ì JSON„ÄÇ"></textarea>
                </div>
                <div id="ai-import-status" class="text-[10px] text-[var(--sub)]"></div>
                <div class="mt-2 border-t border-[var(--border)] pt-2">
                    <label class="flex items-center justify-between text-[11px] text-[var(--sub)] cursor-pointer">
                        <span>ÊòæÁ§∫ AI Ë∞ÉÁî®ÁõëÊéß</span>
                        <div class="relative">
                            <input type="checkbox" id="ai-monitor-toggle" class="sr-only peer"
                                onchange="App.ai.toggleMonitor(this.checked)">
                            <div
                                class="w-7 h-4 bg-[var(--border)] rounded-full peer-checked:bg-primary-500 transition-colors">
                            </div>
                            <div
                                class="absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full shadow transition-transform peer-checked:translate-x-3">
                            </div>
                        </div>
                    </label>
                    <div id="ai-monitor-panel"
                        class="mt-2 text-[11px] text-[var(--sub)] bg-[var(--bg)] rounded-lg px-3 py-2 border border-[var(--border)] max-h-32 overflow-y-auto custom-scroll hidden">
                        <div id="ai-monitor-summary"></div>
                        <div id="ai-monitor-requests" class="mt-1 space-y-1"></div>
                    </div>
                    <!-- ÂØºÂÖ•ÁªìÊûú‰∏éÁñë‰ººÁõ∏‰ººÈ¢òÊèêÁ§∫ -->
                    <div id="ai-import-report"
                        class="mt-2 text-[11px] text-[var(--sub)] bg-[var(--bg)] rounded-lg px-3 py-2 border border-dashed border-[var(--border)] hidden">
                    </div>
                </div>
            </div>
            <div
                class="p-4 border-t border-[var(--border)] bg-[var(--bg)] flex flex-wrap justify-end gap-3 rounded-b-2xl">
                <button onclick="App.ai.importFromRawText()"
                    class="btn px-3 py-2.5 bg-[var(--card)] border border-[var(--border)] text-[var(--text)] rounded-xl text-[11px] shadow-sm hover:bg-[var(--bg-hover)] active:scale-95">
                    üß† ÁîüÊàê JSON È¢ÑËßà
                </button>
                <button onclick="App.ai.importFromPreview()"
                    class="btn px-4 py-2.5 bg-primary-600 text-white rounded-xl text-xs md:text-sm shadow-md hover:bg-primary-700 active:scale-95">
                    ÂØºÂÖ•È¢ÑËßà JSON Âà∞È¢òÂ∫ì
                </button>
            </div>
        </div>
    </div>

    <!-- È¢òÁõÆÁºñËæë / Êñ∞Â¢û ÂºπÁ™ó -->
    <div id="modal-question-editor"
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm hidden opacity-0 pointer-events-none">
        <div class="card w-full max-w-lg rounded-2xl shadow-2xl p-0 flex flex-col max-h-[85vh]">
            <div
                class="p-4 md:p-5 border-b border-[var(--border)] flex justify-between items-center bg-[var(--bg-hover)] rounded-t-2xl">
                <h3 id="qe-title" class="font-bold text-base">ÁºñËæëÈ¢òÁõÆ</h3>
                <button onclick="App.ui.closeModal('question-editor')"
                    class="text-[var(--sub)] hover:text-[var(--text)] p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="p-4 md:p-5 space-y-3 overflow-y-auto custom-scroll flex-grow text-xs">
                <input type="hidden" id="qe-id" />
                <div class="space-y-1">
                    <label class="text-[11px] text-[var(--sub)] font-bold">ÁßëÁõÆ</label>
                    <div class="flex gap-2">
                        <select id="qe-subject-select"
                            class="flex-1 bg-[var(--card)] border border-[var(--border)] rounded-lg px-2 py-1.5 outline-none"></select>
                        <input id="qe-subject-input" placeholder="Ëá™ÂÆö‰πâÁßëÁõÆ"
                            class="w-32 bg-[var(--card)] border border-[var(--border)] rounded-lg px-2 py-1.5 outline-none" />
                    </div>
                    <p class="text-[10px] text-[var(--sub)]">‰ºòÂÖà‰ΩøÁî®Âè≥‰æßËæìÂÖ•ÁöÑÊñ∞ÁßëÁõÆÔºåÂê¶Âàô‰ΩøÁî®‰∏ãÊãâÊ°ÜÂΩìÂâçÈÄâ‰∏≠È°π„ÄÇ</p>
                </div>
                <div class="space-y-1">
                    <label class="text-[11px] text-[var(--sub)] font-bold">Á´†ËäÇ</label>
                    <div class="flex gap-2">
                        <select id="qe-chapter-select"
                            class="flex-1 bg-[var(--card)] border border-[var(--border)] rounded-lg px-2 py-1.5 outline-none"></select>
                        <input id="qe-chapter-input" placeholder="Ëá™ÂÆö‰πâÁ´†ËäÇ"
                            class="w-32 bg-[var(--card)] border border-[var(--border)] rounded-lg px-2 py-1.5 outline-none" />
                    </div>
                    <p class="text-[10px] text-[var(--sub)]">‰ºòÂÖà‰ΩøÁî®Âè≥‰æßËæìÂÖ•ÁöÑÊñ∞Á´†ËäÇÔºåÂê¶Âàô‰ΩøÁî®‰∏ãÊãâÊ°ÜÂΩìÂâçÈÄâ‰∏≠È°π„ÄÇ</p>
                </div>
                <div class="space-y-1">
                    <label class="text-[11px] text-[var(--sub)] font-bold">È¢òÂûã</label>
                    <select id="qe-type" onchange="App.ui.onQuestionTypeChange()"
                        class="w-full bg-[var(--card)] border border-[var(--border)] rounded-lg px-2 py-1.5 outline-none">
                        <option value="mcq">ÂçïÈÄâÈ¢ò (MCQ)</option>
                        <option value="multi">Â§öÈÄâÈ¢ò (Multi)</option>
                        <option value="tf">Âà§Êñ≠È¢ò (True/False)</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[11px] text-[var(--sub)] font-bold">È¢òÂπ≤</label>
                    <textarea id="qe-q" rows="3"
                        class="w-full bg-[var(--card)] border border-[var(--border)] rounded-lg px-3 py-2 outline-none custom-scroll leading-relaxed"
                        placeholder="ËØ∑ËæìÂÖ•È¢òÁõÆÂÜÖÂÆπ"></textarea>
                </div>
                <div id="qe-options-block" class="space-y-1">
                    <div class="flex items-center justify-between">
                        <label class="text-[11px] text-[var(--sub)] font-bold">ÈÄâÈ°π</label>
                        <button onclick="App.ui.addQuestionOption()"
                            class="text-[11px] text-primary-600 hover:underline">+ Êñ∞Â¢ûÈÄâÈ°π</button>
                    </div>
                    <div id="qe-options-list" class="space-y-2"></div>
                    <p class="text-[10px] text-[var(--sub)]">‰∏çË¶ÅÂú®ËøôÈáåÂÜô A. / B. ÂâçÁºÄÔºåÁ≥ªÁªü‰ºöËá™Âä®Âä†Â≠óÊØç„ÄÇ</p>
                </div>
                <div id="qe-tf-block" class="space-y-1 hidden">
                    <label class="text-[11px] text-[var(--sub)] font-bold">Ê≠£Á°ÆÁ≠îÊ°à</label>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-1">
                            <input type="radio" name="qe-tf" value="T" class="accent-primary-600" />
                            <span>Ê≠£Á°Æ (True)</span>
                        </label>
                        <label class="flex items-center gap-1">
                            <input type="radio" name="qe-tf" value="F" class="accent-primary-600" />
                            <span>ÈîôËØØ (False)</span>
                        </label>
                    </div>
                </div>
                <div id="qe-error" class="text-[11px] text-red-500"></div>
            </div>
            <div class="p-4 border-t border-[var(--border)] bg-[var(--bg)] flex justify-end gap-3 rounded-b-2xl">
                <button onclick="App.ui.closeModal('question-editor')"
                    class="btn px-3 py-2.5 bg-[var(--card)] border border-[var(--border)] text-[var(--text)] rounded-xl text-[11px] shadow-sm hover:bg-[var(--bg-hover)] active:scale-95">ÂèñÊ∂à</button>
                <button onclick="App.ui.saveQuestionFromEditor()"
                    class="btn px-4 py-2.5 bg-primary-600 text-white rounded-xl text-xs md:text-sm shadow-md hover:bg-primary-700 active:scale-95">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- ÂõûÊî∂Á´ôÂºπÁ™ó -->
    <div id="modal-trash"
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm hidden opacity-0 pointer-events-none">
        <div class="card w-full max-w-3xl rounded-2xl shadow-2xl p-0 flex flex-col max-h-[85vh]">
            <div
                class="p-4 md:p-5 border-b border-[var(--border)] flex justify-between items-center bg-[var(--bg-hover)] rounded-t-2xl">
                <h3 class="font-bold text-base">ÂõûÊî∂Á´ô (Recycle Bin)</h3>
                <div class="flex items-center gap-3">
                    <button onclick="App.data.emptyTrash()"
                        class="text-[10px] text-red-500 border border-red-200 bg-red-50 px-2 py-1 rounded hover:bg-red-100">Ê∏ÖÁ©∫</button>
                    <button onclick="App.ui.closeModal('trash')" class="text-[var(--sub)] hover:text-[var(--text)] p-1">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-4 md:p-5 space-y-3 overflow-y-auto custom-scroll flex-grow text-xs" id="trash-list"></div>
        </div>
    </div>

    <!-- Áñë‰ººÁõ∏‰ººÈ¢òÂÆ°Êü•ÂºπÁ™ó -->
    <div id="modal-dup-review"
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm hidden opacity-0 pointer-events-none">
        <div class="card w-full max-w-4xl rounded-2xl shadow-2xl p-0 flex flex-col max-h-[85vh]">
            <div
                class="p-4 md:p-5 border-b border-[var(--border)] flex justify-between items-center bg-[var(--bg-hover)] rounded-t-2xl">
                <h3 class="font-bold text-base">Áñë‰ººÁõ∏‰ººÈ¢òÂÆ°Êü•</h3>
                <button onclick="App.ui.closeModal('dup-review')"
                    class="text-[var(--sub)] hover:text-[var(--text)] p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="p-4 md:p-5 space-y-3 overflow-y-auto custom-scroll flex-grow text-xs" id="dup-review-list">
                <!-- Áî± JS Ê∏≤ÊüìÁñë‰ººÁõ∏‰ººÈ¢òÁªÑ -->
            </div>
            <div class="p-4 border-t border-[var(--border)] bg-[var(--bg)] flex justify-end gap-3 rounded-b-2xl">
                <button onclick="App.ui.closeModal('dup-review')"
                    class="btn px-3 py-2.5 bg-[var(--card)] border border-[var(--border)] text-[var(--text)] rounded-xl text-[11px] shadow-sm hover:bg-[var(--bg-hover)] active:scale-95">
                    ÂèñÊ∂à
                </button>
                <button onclick="App.ui.applySimilarReview()"
                    class="btn px-4 py-2.5 bg-primary-600 text-white rounded-xl text-xs md:text-sm shadow-md hover:bg-primary-700 active:scale-95">
                    Â∫îÁî®ÂΩìÂâçÈÄâÊã©
                </button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const App = {
            apiBase: window.API_BASE || '',
            dom: {
                get(id) {
                    const el = document.getElementById(id);
                    if (!el) console.warn(`[DOM Warning] Element #${id} not found.`);
                    return el;
                },
                setText(id, text) {
                    const el = this.get(id);
                    if (el) el.innerText = text;
                },
                setHTML(id, html) {
                    const el = this.get(id);
                    if (el) el.innerHTML = html;
                },
                show(id) {
                    const el = this.get(id);
                    if (el) el.classList.remove('hidden');
                },
                hide(id) {
                    const el = this.get(id);
                    if (el) el.classList.add('hidden');
                },
                getValue(id, fallback = null) {
                    const el = this.get(id);
                    return el ? el.value : fallback;
                },
                setValue(id, val) {
                    const el = this.get(id);
                    if (el) el.value = val;
                }
            },

            utils: {
                toPinyinStr(text) {
                    if (!text || typeof pinyinPro === 'undefined') return text ? String(text).toLowerCase() : '';
                    return pinyinPro.pinyin(text, { toneType: 'none', separator: '' }).toLowerCase();
                },
                shuffle(array) {
                    const arr = [...array];
                    let currentIndex = arr.length, randomIndex;
                    while (currentIndex != 0) {
                        randomIndex = Math.floor(Math.random() * currentIndex);
                        currentIndex--;
                        [arr[currentIndex], arr[randomIndex]] = [arr[randomIndex], arr[currentIndex]];
                    }
                    return arr;
                },
                escapeHTML(text) {
                    if (text == null) return '';
                    return String(text).replace(/[&<>"']/g, function (m) {
                        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m] || m;
                    });
                },
                highlightByPinyin(text, pinyinQuery) {
                    if (!pinyinQuery || typeof text !== 'string' || typeof pinyinPro === 'undefined') return text;

                    const charPinyinPairs = [];
                    for (let i = 0; i < text.length; i++) {
                        const char = text[i];
                        if (/[\u4e00-\u9fff]/.test(char)) {
                            charPinyinPairs.push({
                                char,
                                py: pinyinPro.pinyin(char, { toneType: 'none', type: 'string' }).replace(/\s/g, '').toLowerCase()
                            });
                        } else {
                            charPinyinPairs.push({ char, py: char.toLowerCase() });
                        }
                    }

                    const markRanges = [];

                    for (let i = 0; i < charPinyinPairs.length; i++) {
                        let combined = '';
                        for (let j = i; j < charPinyinPairs.length; j++) {
                            combined += charPinyinPairs[j].py;

                            if (combined === pinyinQuery) {
                                markRanges.push([i, j]);
                                break;
                            }

                            if (combined.length > pinyinQuery.length) {
                                const withoutLast = combined.slice(0, combined.length - charPinyinPairs[j].py.length);
                                const remaining = pinyinQuery.slice(withoutLast.length);

                                if (withoutLast === pinyinQuery.slice(0, withoutLast.length)
                                    && charPinyinPairs[j].py.startsWith(remaining)) {
                                    markRanges.push([i, j]);
                                }
                                break;
                            }

                            if (!pinyinQuery.startsWith(combined)) break;
                        }
                    }

                    if (markRanges.length === 0) return text;
                    markRanges.sort((a, b) => a[0] - b[0]);
                    const mergedRanges = [];
                    markRanges.forEach(r => {
                        if (!mergedRanges.length || r[0] > mergedRanges[mergedRanges.length - 1][1] + 1) {
                            mergedRanges.push([r[0], r[1]]);
                        } else {
                            mergedRanges[mergedRanges.length - 1][1] = Math.max(mergedRanges[mergedRanges.length - 1][1], r[1]);
                        }
                    });

                    const markedIndices = new Set();
                    mergedRanges.forEach(([s, e]) => {
                        for (let i = s; i <= e; i++) markedIndices.add(i);
                    });

                    let result = '';
                    let inMark = false;
                    charPinyinPairs.forEach(({ char }, i) => {
                        if (markedIndices.has(i) && !inMark) {
                            result += '<mark class="bg-yellow-200 dark:bg-yellow-700/50 rounded px-0.5 text-inherit">';
                            inMark = true;
                        }
                        if (!markedIndices.has(i) && inMark) {
                            result += '</mark>';
                            inMark = false;
                        }
                        result += char;
                    });
                    if (inMark) result += '</mark>';

                    return result;
                },
                highlight(text, query) {
                    if (typeof text !== 'string') return text;
                    if (!query) return this.escapeHTML(text);

                    const isPinyinQuery = /^[a-z0-9]+$/i.test(query);
                    if (isPinyinQuery && typeof pinyinPro !== 'undefined') {
                        const pinyinResult = App.utils.highlightByPinyin(text, query.toLowerCase());
                        if (pinyinResult !== text) {
                            const placeholderOpen = '__MARK_OPEN__';
                            const placeholderClose = '__MARK_CLOSE__';
                            const tmp = pinyinResult
                                .replace(/<mark[^>]*>/g, placeholderOpen)
                                .replace(/<\/mark>/g, placeholderClose);
                            const escaped = this.escapeHTML(tmp);
                            return escaped
                                .replace(new RegExp(placeholderOpen, 'g'), '<mark class="bg-yellow-200 dark:bg-yellow-700/50 rounded px-0.5 text-inherit">')
                                .replace(new RegExp(placeholderClose, 'g'), '</mark>');
                        }
                    }

                    const escapedText = this.escapeHTML(text);
                    const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const reg = new RegExp(`(${escapedQuery})`, 'gi');
                    return escapedText.replace(reg, '<mark class="bg-yellow-200 dark:bg-yellow-700/50 rounded px-0.5 text-inherit">$1</mark>');
                },
                getDetailedOptionHTML(q, charStr, searchQuery = '') {
                    if (!q.o || !Array.isArray(q.o)) return '<span class="text-red-500 text-xs">ÈÄâÈ°πÊï∞ÊçÆÁº∫Â§± (Data Missing)</span>';

                    const texts = q.o.map((optText, idx) => {
                        const char = String.fromCharCode(65 + idx);
                        const isCorrect = (charStr || '').includes(char);
                        const hlOptText = App.utils.highlight(optText, searchQuery);

                        if (isCorrect) {
                            return `<div class="mt-1 py-1 px-2 rounded bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-400 font-bold flex items-start gap-1.5 text-xs transition-colors">
                                        <span class="flex-shrink-0">‚úÖ</span>
                                        <span class="leading-snug">${char}. ${hlOptText}</span>
                                    </div>`;
                        } else {
                            return `<div class="mt-1 py-1 px-2 rounded text-[var(--sub)] flex items-start gap-1.5 text-xs opacity-75 transition-colors">
                                        <span class="flex-shrink-0 text-rose-400 opacity-80">‚ùå</span>
                                        <span class="leading-snug">${char}. ${hlOptText}</span>
                                    </div>`;
                        }
                    });
                    return `<div class="mt-1.5 flex flex-col">${texts.join('')}</div>`;
                },
                editDistance(a, b) {
                    const m = a.length, n = b.length;
                    const dp = Array.from({ length: m + 1 }, (_, i) =>
                        Array.from({ length: n + 1 }, (_, j) => i === 0 ? j : j === 0 ? i : 0)
                    );
                    for (let i = 1; i <= m; i++) {
                        for (let j = 1; j <= n; j++) {
                            dp[i][j] = a[i - 1] === b[j - 1]
                                ? dp[i - 1][j - 1]
                                : 1 + Math.min(dp[i - 1][j], dp[i][j - 1], dp[i - 1][j - 1]);
                        }
                    }
                    return dp[m][n];
                },
                fuzzyMatch(text, query) {
                    if (!query || query.length < 2) return false;
                    const tolerance = Math.floor(query.length / 4) + 1;

                    for (let i = 0; i <= text.length - query.length + tolerance; i++) {
                        const sub = text.substring(i, i + query.length);
                        if (this.editDistance(sub, query) <= tolerance) return true;
                    }
                    return false;
                },

                // ÂΩí‰∏ÄÂåñÈ¢òÂπ≤ÊñáÊú¨ÔºöÂéªÈô§Á©∫ÁôΩ‰∏éÂ∏∏ËßÅÊ†áÁÇπÂπ∂ËΩ¨Â∞èÂÜôÔºå‰æø‰∫éÁõ∏‰ººÂ∫¶ËÆ°ÁÆó
                normalizeQuestionText(text) {
                    if (!text) return '';
                    return String(text)
                        .toLowerCase()
                        .replace(/[\s\u3000]/g, '')
                        .replace(/[Ôºå„ÄÇ,\.„ÄÅÔºõ;ÔºÅ!Ôºü?\(\)\[\]„Äê„Äë'"‚Äú‚Äù‚Äò‚Äô]/g, '');
                },

                // ÁÆÄÂçïÁõ∏‰ººÂ∫¶Ôºö1 - (ÁºñËæëË∑ùÁ¶ª / ÊúÄÂ§ßÈïøÂ∫¶)ÔºåËåÉÂõ¥ [0,1]
                similarity(a, b) {
                    if (!a && !b) return 1;
                    if (!a || !b) return 0;
                    const maxLen = Math.max(a.length, b.length);
                    if (!maxLen) return 1;
                    const dist = this.editDistance(a, b);
                    return 1 - dist / maxLen;
                }
            },

            chart: {
                draw(canvasId, dataPoints) {
                    const cvs = App.dom.get(canvasId);
                    if (!cvs || !cvs.parentElement) return;

                    const ctx = cvs.getContext('2d');
                    if (!ctx) return;

                    const parent = cvs.parentElement;
                    if (parent.clientWidth === 0 || parent.clientHeight === 0) {
                        if (!cvs.dataset.pendingDraw) {
                            cvs.dataset.pendingDraw = '1';
                            requestAnimationFrame(() => {
                                delete cvs.dataset.pendingDraw;
                                App.chart.draw(canvasId, dataPoints);
                            });
                        }
                        return;
                    }
                    cvs.width = parent.clientWidth;
                    cvs.height = parent.clientHeight;
                    const w = cvs.width, h = cvs.height;
                    const pad = 10;

                    ctx.clearRect(0, 0, w, h);

                    if (!dataPoints || dataPoints.length === 0) return;
                    if (dataPoints.length === 1) {
                        ctx.fillStyle = '#64748b'; ctx.font = '10px Inter'; ctx.textAlign = 'center';
                        ctx.fillText(dataPoints[0] + '%', w / 2, h / 2);
                        return;
                    }

                    ctx.strokeStyle = '#0d9488'; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                    ctx.beginPath();
                    const step = (w - pad * 2) / (dataPoints.length - 1);

                    dataPoints.forEach((val, i) => {
                        const x = pad + i * step;
                        const y = h - pad - (val / 100 * (h - pad * 2));
                        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                        ctx.fillStyle = '#64748b'; ctx.font = '10px Inter'; ctx.textAlign = 'center';
                        ctx.fillText(val + '%', x, y - 8);
                    });
                    ctx.stroke();

                    const grad = ctx.createLinearGradient(0, 0, 0, h);
                    grad.addColorStop(0, 'rgba(13, 148, 136, 0.2)');
                    grad.addColorStop(1, 'rgba(13, 148, 136, 0)');
                    ctx.fillStyle = grad;
                    ctx.lineTo(pad + (dataPoints.length - 1) * step, h);
                    ctx.lineTo(pad, h);
                    ctx.fill();
                },

                drawBar(canvasId, labels, values, colors) {
                    const cvs = App.dom.get(canvasId);
                    if (!cvs) return;
                    const ctx = cvs.getContext('2d');
                    const parent = cvs.parentElement;
                    if (!parent || parent.clientWidth === 0) {
                        if (!cvs.dataset.pendingDrawBar) {
                            cvs.dataset.pendingDrawBar = '1';
                            requestAnimationFrame(() => {
                                delete cvs.dataset.pendingDrawBar;
                                App.chart.drawBar(canvasId, labels, values, colors);
                            });
                        }
                        return;
                    }
                    cvs.width = parent.clientWidth;
                    cvs.height = Math.max(labels.length * 36 + 20, 100);
                    const w = cvs.width, barH = 20, padL = 60, padR = 40;

                    ctx.clearRect(0, 0, w, cvs.height);

                    labels.forEach((label, i) => {
                        const y = 10 + i * 36;
                        const val = values[i] || 0;
                        const barW = (val / 100) * (w - padL - padR);

                        ctx.fillStyle = 'rgba(148,163,184,0.15)';
                        ctx.beginPath();
                        ctx.roundRect(padL, y, w - padL - padR, barH, 6);
                        ctx.fill();

                        if (barW > 0) {
                            ctx.fillStyle = colors[i] || '#0d9488';
                            ctx.beginPath();
                            ctx.roundRect(padL, y, barW, barH, 6);
                            ctx.fill();
                        }

                        ctx.fillStyle = '#64748b';
                        ctx.font = '11px Inter';
                        ctx.textAlign = 'right';
                        ctx.fillText(label.slice(0, 5), padL - 8, y + 14);

                        ctx.textAlign = 'left';
                        const isDarkMode = document.documentElement.classList.contains('dark');
                        ctx.fillStyle = isDarkMode ? '#f8fafc' : '#0f172a';
                        ctx.font = 'bold 11px Inter';
                        ctx.fillText(val + '%', padL + barW + 8, y + 14);
                    });
                },

                drawDonut(canvasId, values, labels, colors) {
                    const cvs = App.dom.get(canvasId);
                    if (!cvs) return;
                    const ctx = cvs.getContext('2d');
                    const size = Math.min(cvs.parentElement.clientWidth, 160);
                    cvs.width = size; cvs.height = size;
                    const cx = size / 2, cy = size / 2, r = size / 2 - 12, innerR = r * 0.58;
                    const total = values.reduce((a, b) => a + b, 0);
                    if (total === 0) return;

                    let startAngle = -Math.PI / 2;
                    values.forEach((v, i) => {
                        if (v === 0) return;
                        const slice = (v / total) * 2 * Math.PI;
                        ctx.beginPath();
                        ctx.moveTo(cx, cy);
                        ctx.arc(cx, cy, r, startAngle, startAngle + slice);
                        ctx.closePath();
                        ctx.fillStyle = colors[i];
                        ctx.fill();
                        startAngle += slice;
                    });

                    ctx.beginPath();
                    ctx.arc(cx, cy, innerR, 0, 2 * Math.PI);
                    const isDarkMode = document.documentElement.classList.contains('dark');
                    ctx.fillStyle = isDarkMode ? '#1e293b' : '#ffffff';
                    ctx.fill();

                    ctx.fillStyle = '#64748b';
                    ctx.font = `bold ${Math.round(size / 8)}px Inter`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(total + 'Ê¨°', cx, cy);
                },

                drawHeatmap(canvasId, daily30) {
                    const cvs = App.dom.get(canvasId);
                    if (!cvs) return;
                    const ctx = cvs.getContext('2d');
                    const parent = cvs.parentElement;
                    cvs.width = parent.clientWidth;
                    const cellW = Math.floor((cvs.width - 10) / 30);
                    cvs.height = cellW + 24;

                    ctx.clearRect(0, 0, cvs.width, cvs.height);

                    daily30.forEach((day, i) => {
                        const x = 5 + i * cellW;
                        const hasData = day.attempts > 0;
                        const intensity = hasData ? Math.min(day.attempts / 20, 1) : 0;

                        if (!hasData) {
                            ctx.fillStyle = document.documentElement.classList.contains('dark') ? 'rgba(51,65,85,0.4)' : 'rgba(148,163,184,0.2)';
                        } else {
                            const g = Math.round(148 - intensity * 60);
                            ctx.fillStyle = `rgba(13, ${g + 80}, 136, ${0.3 + intensity * 0.7})`;
                        }
                        ctx.beginPath();
                        ctx.roundRect(x, 4, cellW - 2, cellW - 2, 3);
                        ctx.fill();

                        if (i % 7 === 0 || i === 29) {
                            ctx.fillStyle = '#94a3b8';
                            ctx.font = '9px Inter';
                            ctx.textAlign = 'center';
                            ctx.fillText(day.label, x + cellW / 2, cvs.height - 4);
                        }
                    });
                }
            },

            auth: {
                client: null,
                session: null,
                init() {
                    if (!window.supabase || !window.supabase.createClient) return;
                    const url = window.SUPABASE_URL || '';
                    const key = window.SUPABASE_ANON_KEY || '';
                    if (!url || !key) return;
                    this.client = window.supabase.createClient(url, key);
                    this.client.auth.getSession().then(({ data }) => {
                        this.session = data && data.session ? data.session : null;
                        this.applyAuthState();
                    });
                    this.client.auth.onAuthStateChange((event, session) => {
                        this.session = session || null;
                        this.applyAuthState();
                    });
                },
                async getToken() {
                    if (!this.client) return null;
                    if (this.session && this.session.access_token) return this.session.access_token;
                    const { data } = await this.client.auth.getSession();
                    return data && data.session ? data.session.access_token : null;
                },
                getUserId() {
                    return this.session && this.session.user ? this.session.user.id : '';
                },
                usernameToEmail(loginId) {
                    const raw = (loginId || '').trim();
                    if (!raw) return '';
                    if (raw.includes('@')) return raw.toLowerCase();
                    const normalized = raw.toLowerCase();
                    return `${normalized}@user.local`;
                },
                async login(loginId, password) {
                    if (!this.client) return { error: { message: 'Êú™ÈÖçÁΩÆ Supabase' } };
                    const email = this.usernameToEmail(loginId);
                    if (!email) return { error: { message: 'Áî®Êà∑Âêç‰∏çËÉΩ‰∏∫Á©∫' } };
                    return await this.client.auth.signInWithPassword({ email, password });
                },
                async signup(loginId, password) {
                    if (!this.client) return { error: { message: 'Êú™ÈÖçÁΩÆ Supabase' } };
                    const raw = (loginId || '').trim();
                    if (!raw) return { error: { message: 'Áî®Êà∑Âêç‰∏çËÉΩ‰∏∫Á©∫' } };
                    if (raw.includes('@')) return { error: { message: 'Áî®Êà∑Âêç‰∏çËÉΩÂåÖÂê´ @ Á¨¶Âè∑' } };
                    const email = this.usernameToEmail(raw);
                    return await this.client.auth.signUp({
                        email,
                        password,
                        options: {
                            data: { username: raw }
                        }
                    });
                },
                async logout() {
                    if (!this.client) return;
                    await this.client.auth.signOut();
                },
                applyAuthState() {
                    const btn = document.getElementById("auth-btn");
                    const icon = document.getElementById("auth-icon");
                    const overlay = document.getElementById("auth-overlay");
                    if (!btn || !icon) return;
                    btn.classList.remove(
                        "bg-primary-600",
                        "text-white",
                        "border-emerald-400",
                        "bg-emerald-50",
                        "text-emerald-700",
                        "shadow",
                        "shadow-emerald-200"
                    );
                    btn.classList.add("border", "border-[var(--border)]", "bg-[var(--card)]", "text-[var(--sub)]");
                    if (this.session) {
                        btn.title = "ÈÄÄÂá∫ÁôªÂΩï";
                        btn.classList.remove("border-[var(--border)]", "bg-[var(--card)]", "text-[var(--sub)]");
                        btn.classList.add(
                            "border-emerald-400",
                            "bg-emerald-50",
                            "text-emerald-700",
                            "shadow",
                            "shadow-emerald-200"
                        );
                        if (overlay) {
                            overlay.classList.add("hidden");
                            overlay.classList.add("opacity-0", "pointer-events-none");
                        }
                        if (window.App && App.data && typeof App.data.loadFromCloud === "function") {
                            App.data._syncReady = false;
                            App.data.loadFromCloud();
                        }
                        if (window.App && App.sync && typeof App.sync.startAutoPull === "function") {
                            App.sync.startAutoPull();
                        }
                        if (window.App && App.realtime && typeof App.realtime.setup === "function") {
                            const token = this.session.access_token;
                            const uid = this.getUserId();
                            App.realtime.setup(uid, token);
                        }
                    } else {
                        btn.title = "ÁôªÂΩï";
                        if (overlay) {
                            overlay.classList.remove("hidden", "opacity-0", "pointer-events-none");
                        }
                        if (window.App && App.data && typeof App.data.clearAllForLogout === "function") {
                            App.data.clearAllForLogout();
                        }
                        if (window.App && App.sync && typeof App.sync.stopAutoPull === "function") {
                            App.sync.stopAutoPull();
                        }
                        if (window.App && App.realtime && typeof App.realtime.teardown === "function") {
                            App.realtime.teardown();
                        }
                    }
                }
            },

            data: {
                // ÂéÜÂè≤ËÆ∞ÂΩïÂíåÈ¢òÂ∫ìÂ≠òÂÇ® Key
                historyKey: 'lms_v26_history',
                bankKey: 'lms_v26_bank',
                // ÂõûÊî∂Á´ôÂ≠òÂÇ® Key
                trashKey: 'lms_v26_trash',
                bankNameKey: 'lms_v26_bank_name',

                // Âà∑È¢òÂéÜÂè≤
                history: [],
                lastPracticeTime: null,

                // È¢òÂ∫ìÁªìÊûÑÔºö{ [subject]: { [chapter]: Question[] } }
                bank: {},
                bankName: '',
                // ÂõûÊî∂Á´ôÁªìÊûÑÔºö‰∏é bank Áõ∏ÂêåÔºå‰ΩÜÈ¢òÁõÆÂØπË±°ÈôÑÂ∏¶Âà†Èô§ÂÖÉ‰ø°ÊÅØ
                trash: {},
                hiddenMistakeIds: [],

                // ËøêË°åÊó∂ÁºìÂ≠ò
                _cachedQuestions: null,
                _questionMap: null,
                _errFreqCache: null,
                _isHistoryDirty: true,
                _suppressCloudSync: false,
                _lastSyncedCounts: null,
                _cloudSaveTimer: null,
                _lastSyncedQuestionIds: null,
                _bankDirty: false,
                _syncReady: false,
                _cloudLoading: false,
                _pendingSaveState: null,
                _deferredSave: false,
                remoteVersion: 0,
                // ========== Â¢ûÈáèÂêåÊ≠• (Incremental Sync) ==========
                _historyAppendBuffer: [],    // Ëá™‰∏äÊ¨°ÂêåÊ≠•‰ª•Êù•Êñ∞Â¢ûÁöÑ history Êù°ÁõÆ
                _lastHistoryTimestamp: 0,     // ‰∏äÊ¨°ÂêåÊ≠•Êó∂ÁöÑÊúÄÊñ∞ history Êó∂Èó¥Êà≥
                _lastEtag: null,             // ‰∏äÊ¨° load ËøîÂõûÁöÑ ETag

                init() {
                    try {
                        const hStr = localStorage.getItem(this.historyKey);
                        if (hStr) {
                            const parsed = JSON.parse(hStr);
                            if (parsed && Array.isArray(parsed.history)) {
                                this.history = parsed.history.filter(h =>
                                    h && typeof h.id === 'string' && typeof h.r === 'boolean' && typeof h.t === 'number'
                                );
                            } else {
                                this.history = [];
                            }
                            this.lastPracticeTime = typeof parsed.lastPracticeTime === 'number' ? parsed.lastPracticeTime : null;
                            if (parsed && Array.isArray(parsed.hiddenMistakeIds)) {
                                this.hiddenMistakeIds = parsed.hiddenMistakeIds;
                            } else {
                                this.hiddenMistakeIds = [];
                            }
                        }
                    } catch (e) { console.error("History parse error", e); }

                    try {
                        const bStr = localStorage.getItem(this.bankKey);
                        if (bStr) {
                            const parsed = JSON.parse(bStr);
                            if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
                                this.bank = parsed;
                            } else {
                                this.bank = {};
                            }
                            if (window.App && App.ai && typeof App.ai.sanitizeImportedBank === 'function') {
                                const sanitized = App.ai.sanitizeImportedBank(this.bank);
                                const before = JSON.stringify(this.bank);
                                const after = JSON.stringify(sanitized);
                                if (before !== after) {
                                    this.bank = sanitized;
                                    this._safeSetItem(this.bankKey, after);
                                }
                            }
                        }
                    } catch (e) { console.error("Bank parse error", e); }
                    try {
                        const nStr = localStorage.getItem(this.bankNameKey);
                        if (nStr && typeof nStr === 'string') {
                            this.bankName = nStr;
                        }
                    } catch (e) { }

                    // Âä†ËΩΩÂõûÊî∂Á´ô
                    try {
                        const tStr = localStorage.getItem(this.trashKey);
                        if (tStr) {
                            const parsed = JSON.parse(tStr);
                            if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
                                this.trash = parsed;
                            } else {
                                this.trash = {};
                            }
                        }
                    } catch (e) { console.error("Trash parse error", e); }
                },

                _safeSetItem(key, value) {
                    try {
                        localStorage.setItem(key, value);
                        return true;
                    } catch (e) {
                        if (e && (e.name === 'QuotaExceededError' || e.code === 22 || e.code === 1014)) {
                            alert('Êú¨Âú∞Â≠òÂÇ®Á©∫Èó¥Â∑≤Êª°ÔºåËØ∑Ê∏ÖÁêÜÂõûÊî∂Á´ôÊàñÁ≤æÁÆÄÈ¢òÂ∫ì„ÄÇ');
                            return false;
                        }
                        console.error('Storage error', e);
                        return false;
                    }
                },

                clearAllForLogout() {
                    this.bank = {};
                    this.bankName = '';
                    this.history = [];
                    this.trash = {};
                    this.hiddenMistakeIds = [];
                    this._cachedQuestions = null;
                    this._questionMap = null;
                    this._errFreqCache = null;
                    this._isHistoryDirty = true;
                    this._lastSyncedCounts = null;
                    this._lastSyncedQuestionIds = null;
                    this._bankDirty = false;
                    this._syncReady = false;
                    this._cloudLoading = false;
                    this.remoteVersion = 0;
                    this._historyAppendBuffer = [];
                    this._lastHistoryTimestamp = 0;
                    this._lastEtag = null;
                    try {
                        localStorage.removeItem(this.bankKey);
                        localStorage.removeItem(this.bankNameKey);
                        localStorage.removeItem(this.historyKey);
                        localStorage.removeItem(this.trashKey);
                    } catch (e) {
                        console.error(e);
                    }
                },

                saveHistory() {
                    this._safeSetItem(this.historyKey, JSON.stringify({
                        history: this.history,
                        lastPracticeTime: this.lastPracticeTime,
                        hiddenMistakeIds: Array.isArray(this.hiddenMistakeIds) ? this.hiddenMistakeIds : []
                    }));
                    if (!this._suppressCloudSync && this.saveToCloudDebounced) {
                        this.saveToCloudDebounced();
                    }
                },

                validateSchema(data) {
                    if (!data || typeof data !== 'object' || Array.isArray(data)) return "Root must be an object";
                    for (const sub in data) {
                        if (typeof data[sub] !== 'object' || Array.isArray(data[sub])) return `Subject [${sub}] format error`;
                        for (const chap in data[sub]) {
                            if (!Array.isArray(data[sub][chap])) return `Chapter [${chap}] must be an array`;
                            for (let i = 0; i < data[sub][chap].length; i++) {
                                const q = data[sub][chap][i];
                                if (!q.id || !q.type || !q.q || !q.a) return `Missing core fields in [${sub}]-[${chap}] index ${i}`;
                                if (['mcq', 'multi'].includes(q.type) && (!Array.isArray(q.o) || q.o.length < 2)) {
                                    return `Invalid options array for question ID ${q.id}`;
                                }
                                // ‰øÆÂ§ç 6: ÂΩí‰∏ÄÂåñÂ§öÈÄâÈ¢òÁ≠îÊ°à (Normalize Multi-select Answers)
                                if (q.type === 'multi' && typeof q.a === 'string') {
                                    q.a = q.a.split('').sort().join('');
                                }
                            }
                        }
                    }
                    return true;
                },

                // ÊúÄËøë‰∏ÄÊ¨°ÂØºÂÖ•Êä•ÂëäÔºåÂåÖÊã¨Êñ∞Â¢û/Êõ¥Êñ∞/ÈáçÂ§ç/Áõ∏‰ººÈ¢òÁ≠âÁªüËÆ°
                _lastImportReport: null,

                importBank(jsonStr) {
                    try {
                        const prevBank = JSON.parse(JSON.stringify(this.bank || {}));
                        const prevTrash = JSON.parse(JSON.stringify(this.trash || {}));
                        const prevHistory = Array.isArray(this.history) ? this.history.slice() : [];

                        const parsed = JSON.parse(jsonStr);
                        const sanitizedInput = (window.App && App.ai && typeof App.ai.sanitizeImportedBank === 'function')
                            ? App.ai.sanitizeImportedBank(parsed)
                            : parsed;
                        const validationResult = this.validateSchema(sanitizedInput);
                        if (validationResult !== true) {
                            throw new Error(`Ê®°ÂºèÊ†°È™åÂ§±Ë¥• (Schema Validation Failed): ${validationResult}`);
                        }

                        // ÂØºÂÖ•ÁªüËÆ°‰ø°ÊÅØ‰∏éÁñë‰ººÁõ∏‰ººÈ¢òÊî∂ÈõÜ
                        const report = {
                            added: 0,
                            updated: 0,
                            skippedSame: 0,
                            importPairs: [],   // id Áõ∏Âêå‰ΩÜÂÜÖÂÆπ‰∏çÂêåÁöÑË¶ÜÁõñËÆ∞ÂΩï
                            similarPairs: []   // id ‰∏çÂêå‰ΩÜÈ¢òÂπ≤È´òÂ∫¶Áõ∏‰ººÁöÑËÆ∞ÂΩï
                        };

                        // ÊûÑÂª∫ÊóßÈ¢òÂÖ®Â±ÄÁ¥¢ÂºïÔºàid -> ‰ΩçÁΩÆ‰∏éÈ¢òÁõÆÔºâ
                        const globalMap = new Map();
                        for (const sub in this.bank) {
                            for (const chap in (this.bank[sub] || {})) {
                                const arr = this.bank[sub][chap] || [];
                                arr.forEach(q => {
                                    if (q && typeof q.id === 'string') {
                                        globalMap.set(q.id, { sub, chap, q });
                                    }
                                });
                            }
                        }
                        // ÊûÑÂª∫ÂØºÂÖ•Êï∞ÊçÆÁöÑÂÖ®Â±ÄÁ¥¢ÂºïÔºàÂêå id ÊúÄÂêé‰∏ÄÊ¨°Âá∫Áé∞ÁîüÊïàÔºâ
                        const importMap = new Map();
                        for (const sub in sanitizedInput) {
                            const chapters = sanitizedInput[sub] || {};
                            for (const chap in chapters) {
                                const arr = Array.isArray(chapters[chap]) ? chapters[chap] : [];
                                arr.forEach(qNew => {
                                    if (!qNew || typeof qNew !== 'object') return;
                                    if (qNew.type === 'multi' && typeof qNew.a === 'string') {
                                        qNew.a = qNew.a.split('').sort().join('');
                                    }
                                    if (typeof qNew.id !== 'string' || !qNew.id) return;
                                    importMap.set(qNew.id, { sub, chap, q: qNew });
                                });
                            }
                        }
                        // ÂêàÂπ∂ÔºöÈÄê id Â§ÑÁêÜÔºåÈÅøÂÖçÂú®Á´†ËäÇÁª¥Â∫¶‰∏äÂèçÂ§ç push
                        importMap.forEach(({ sub, chap, q: qNew }, id) => {
                            if (!this.bank[sub]) this.bank[sub] = {};
                            if (!this.bank[sub][chap]) this.bank[sub][chap] = [];
                            const targetArr = this.bank[sub][chap];
                            const exist = globalMap.get(id);
                            if (exist) {
                                const qOld = exist.q;
                                const same =
                                    qOld.type === qNew.type &&
                                    qOld.q === qNew.q &&
                                    JSON.stringify(qOld.o || []) === JSON.stringify(qNew.o || []) &&
                                    qOld.a === qNew.a;
                                if (same) {
                                    report.skippedSame++;
                                } else {
                                    const oldArr = this.bank[exist.sub] && this.bank[exist.sub][exist.chap];
                                    if (Array.isArray(oldArr)) {
                                        const idx = oldArr.findIndex(x => x.id === id);
                                        if (idx !== -1) {
                                            const oldQ = oldArr[idx];
                                            if (!this.trash[exist.sub]) this.trash[exist.sub] = {};
                                            if (!this.trash[exist.sub][exist.chap]) this.trash[exist.sub][exist.chap] = [];
                                            this.trash[exist.sub][exist.chap].push({
                                                ...oldQ,
                                                deletedAt: Date.now(),
                                                deletedBy: 'import',
                                                reason: 'override',
                                                originalPath: { sub: exist.sub, chap: exist.chap }
                                            });
                                            oldArr.splice(idx, 1);
                                        }
                                    }
                                    targetArr.push(qNew);
                                    globalMap.set(id, { sub, chap, q: qNew });
                                    report.updated++;
                                    report.importPairs.push({
                                        sub,
                                        chap,
                                        oldId: qOld.id,
                                        newId: qNew.id,
                                        oldQ: qOld.q,
                                        newQ: qNew.q
                                    });
                                }
                            } else {
                                targetArr.push(qNew);
                                globalMap.set(id, { sub, chap, q: qNew });
                                report.added++;
                            }
                        });
                        // ÂØπÊØè‰∏™Á´†ËäÇËøõË°å‰∏ÄÊ¨°ÂéªÈáçÔºàÊåâ id ‰øùÁïôÊúÄÂêé‰∏Ä‰∏™Ôºâ
                        for (const sub in this.bank) {
                            for (const chap in (this.bank[sub] || {})) {
                                const arr = this.bank[sub][chap] || [];
                                const uniq = new Map();
                                arr.forEach(q => {
                                    if (q && typeof q.id === 'string') {
                                        uniq.set(q.id, q);
                                    }
                                });
                                this.bank[sub][chap] = Array.from(uniq.values());
                            }
                        }
                        this.normalizeBankStructure();
                        if (!this.bankName) {
                            const subs = Object.keys(sanitizedInput || {});
                            if (subs.length === 1) {
                                this.bankName = subs[0];
                            } else if (subs.length > 1) {
                                this.bankName = subs[0];
                            }
                            if (this.bankName) {
                                this._safeSetItem(this.bankNameKey, this.bankName);
                            }
                        }
                        this.persistBank();
                        // ËÆ∞ÂΩïÂØºÂÖ•Êä•ÂëäÔºå‰æõ UI ÂêéÁª≠Êü•Áúã
                        this._lastImportReport = report;
                        return report;
                    } catch (e) {
                        try {
                            this.bank = JSON.parse(JSON.stringify(prevBank || {}));
                            this.trash = JSON.parse(JSON.stringify(prevTrash || {}));
                            this.history = Array.isArray(prevHistory) ? prevHistory.slice() : [];
                        } catch (rollbackError) {
                            console.error('ÂØºÂÖ•ÂõûÊªöÂ§±Ë¥•', rollbackError);
                        }
                        alert("ÂØºÂÖ•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü• JSON Ê†ºÂºè„ÄÇ\n(Import failed.)\n\nÊä•ÈîôËØ¶ÊÉÖ: " + e.message);
                        return null;
                    }
                },

                clearBank() {
                    if (confirm("Á°ÆÂÆöÊ∏ÖÁ©∫È¢òÂ∫ìÂêóÔºüËØ•Êìç‰Ωú‰∏ç‰ºöÊ∏ÖÁ©∫ÊÇ®ÁöÑÂÅöÈ¢òËÆ∞ÂΩï„ÄÇ\n(Are you sure to clear the question bank? Practice history will be preserved.)")) {
                        this.bank = {};
                        this.persistBank();
                        App.ui.closeModal('config');
                        App.router.go('dashboard');
                    }
                },

                resetHistory() {
                    if (confirm("Á°ÆÂÆöÊ∏ÖÁ©∫ÊâÄÊúâÂà∑È¢òËÆ∞ÂΩïÂêóÔºü\n(Are you sure to reset all practice history?)")) {
                        this.history = [];
                        this.lastPracticeTime = null;
                        this.saveHistory();
                        App.ui.closeModal('config');
                        App.router.go('dashboard');
                    }
                },

                getQuestions() {
                    if (this._cachedQuestions) return this._cachedQuestions;

                    let list = [];
                    for (let sub in this.bank) {
                        for (let chap in this.bank[sub]) {
                            list = list.concat(this.bank[sub][chap].map(q => {
                                const rawText = [q.q, chap, q.a, ...(q.o || [])].join(' ');
                                return {
                                    ...q,
                                    sub,
                                    chap,
                                    _pinyin: App.utils.toPinyinStr(rawText)
                                };
                            }));
                        }
                    }
                    this._cachedQuestions = list;
                    return list;
                },

                getQuestionById(id) {
                    if (!this._questionMap) {
                        this._questionMap = new Map();
                        this.getQuestions().forEach(q => this._questionMap.set(q.id, q));
                    }
                    return this._questionMap.get(id);
                },

                getMistakeCount(id) {
                    if (this._isHistoryDirty || !this._errFreqCache) {
                        this._errFreqCache = new Map();
                        this.history.forEach(h => {
                            if (!h.r) this._errFreqCache.set(h.id, (this._errFreqCache.get(h.id) || 0) + 1);
                        });
                        this._isHistoryDirty = false;
                    }
                    return this._errFreqCache.get(id) || 0;
                },

                // ÊåÅ‰πÖÂåñÈ¢òÂ∫ì
                persistBank() {
                    this._safeSetItem(this.bankKey, JSON.stringify(this.bank));
                    if (this.bankName) {
                        this._safeSetItem(this.bankNameKey, this.bankName);
                    }
                    this._cachedQuestions = null;
                    this._questionMap = null;
                    this._errFreqCache = null;
                    this._isHistoryDirty = true;
                    this._bankDirty = true;
                    if (!this._suppressCloudSync && this.saveToCloudDebounced) {
                        this.saveToCloudDebounced();
                    }
                },

                renameSubject(oldSub, newSub) {
                    const trimmed = String(newSub || '').trim();
                    if (!trimmed || trimmed === oldSub || !this.bank[oldSub]) return;
                    if (!this.bank[trimmed]) this.bank[trimmed] = {};
                    for (const chap in this.bank[oldSub]) {
                        if (!this.bank[trimmed][chap]) this.bank[trimmed][chap] = [];
                        const arr = this.bank[oldSub][chap] || [];
                        this.bank[trimmed][chap] = this.bank[trimmed][chap].concat(arr);
                    }
                    delete this.bank[oldSub];
                    if (this.trash && this.trash[oldSub]) {
                        if (!this.trash[trimmed]) this.trash[trimmed] = {};
                        for (const chap in this.trash[oldSub]) {
                            if (!this.trash[trimmed][chap]) this.trash[trimmed][chap] = [];
                            const arr = this.trash[oldSub][chap] || [];
                            this.trash[trimmed][chap] = this.trash[trimmed][chap].concat(arr);
                        }
                        delete this.trash[oldSub];
                        this.persistTrash();
                    }
                    this.normalizeBankStructure();
                    if (App && App.ui && App.ui._bankMgrCurrentSubject === oldSub) {
                        App.ui._bankMgrCurrentSubject = trimmed;
                    }
                    this.persistBank();
                },

                deleteSubject(sub) {
                    if (!this.bank[sub]) return;
                    // Êî∂ÈõÜËØ•ÁßëÁõÆ‰∏ãÊâÄÊúâÈ¢òÁõÆ IDÔºåÁî®‰∫éÊ∏ÖÁêÜ history
                    const deletedIds = new Set();
                    const chapDict = this.bank[sub] || {};
                    for (const chap in chapDict) {
                        const arr = chapDict[chap];
                        if (Array.isArray(arr)) arr.forEach(q => { if (q && q.id) deletedIds.add(q.id); });
                    }
                    delete this.bank[sub];
                    if (this.trash && this.trash[sub]) {
                        delete this.trash[sub];
                        this.persistTrash();
                    }
                    // Bug #5 fix: Ê∏ÖÁêÜË¢´Âà†Èô§È¢òÁõÆÁöÑÂéÜÂè≤ËÆ∞ÂΩï
                    if (deletedIds.size > 0 && Array.isArray(this.history)) {
                        this.history = this.history.filter(h => !deletedIds.has(h.id));
                        this._safeSetItem(this.historyKey, JSON.stringify({
                            history: this.history,
                            lastPracticeTime: this.lastPracticeTime,
                            hiddenMistakeIds: this.hiddenMistakeIds
                        }));
                    }
                    this.persistBank();
                },

                renameChapter(sub, oldChap, newChap) {
                    if (!this.bank[sub] || !this.bank[sub][oldChap]) return;
                    const trimmed = String(newChap || '').trim();
                    if (!trimmed || trimmed === oldChap) return;
                    if (!this.bank[sub][trimmed]) this.bank[sub][trimmed] = [];
                    const arr = this.bank[sub][oldChap] || [];
                    this.bank[sub][trimmed] = this.bank[sub][trimmed].concat(arr);
                    delete this.bank[sub][oldChap];
                    if (!Object.keys(this.bank[sub] || {}).length) delete this.bank[sub];
                    if (this.trash && this.trash[sub] && this.trash[sub][oldChap]) {
                        if (!this.trash[sub][trimmed]) this.trash[sub][trimmed] = [];
                        const tArr = this.trash[sub][oldChap] || [];
                        this.trash[sub][trimmed] = this.trash[sub][trimmed].concat(tArr);
                        delete this.trash[sub][oldChap];
                        if (!Object.keys(this.trash[sub] || {}).length) delete this.trash[sub];
                        this.persistTrash();
                    }
                    this.normalizeBankStructure();
                    this.persistBank();
                },

                deleteChapter(sub, chap) {
                    if (!this.bank[sub] || !this.bank[sub][chap]) return;
                    // Êî∂ÈõÜËØ•Á´†ËäÇ‰∏ãÊâÄÊúâÈ¢òÁõÆ IDÔºåÁî®‰∫éÊ∏ÖÁêÜ history
                    const deletedIds = new Set();
                    const arr = this.bank[sub][chap];
                    if (Array.isArray(arr)) arr.forEach(q => { if (q && q.id) deletedIds.add(q.id); });
                    delete this.bank[sub][chap];
                    if (!Object.keys(this.bank[sub] || {}).length) delete this.bank[sub];
                    if (this.trash && this.trash[sub] && this.trash[sub][chap]) {
                        delete this.trash[sub][chap];
                        if (!Object.keys(this.trash[sub] || {}).length) delete this.trash[sub];
                        this.persistTrash();
                    }
                    // Bug #5 fix: Ê∏ÖÁêÜË¢´Âà†Èô§È¢òÁõÆÁöÑÂéÜÂè≤ËÆ∞ÂΩï
                    if (deletedIds.size > 0 && Array.isArray(this.history)) {
                        this.history = this.history.filter(h => !deletedIds.has(h.id));
                        this._safeSetItem(this.historyKey, JSON.stringify({
                            history: this.history,
                            lastPracticeTime: this.lastPracticeTime,
                            hiddenMistakeIds: this.hiddenMistakeIds
                        }));
                    }
                    this.persistBank();
                },

                normalizeBankStructure() {
                    const bank = this.bank || {};
                    for (const sub in bank) {
                        const chapDict = bank[sub];
                        if (!chapDict || typeof chapDict !== 'object') continue;
                        for (const chap in chapDict) {
                            const arr = chapDict[chap];
                            if (!Array.isArray(arr)) continue;
                            arr.forEach(q => {
                                if (!q || typeof q !== 'object') return;
                                if (q.sub !== sub) q.sub = sub;
                                if (q.chap !== chap) q.chap = chap;
                            });
                        }
                    }
                },

                renameSubjectInteractive(sub) {
                    const next = window.prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÁßëÁõÆÂêçÁß∞', sub);
                    if (!next || next.trim() === sub) return;
                    this.renameSubject(sub, next.trim());
                    if (App && App.ui && typeof App.ui.renderBankManager === 'function') {
                        App.ui.renderBankManager();
                    }
                },

                deleteSubjectInteractive(sub) {
                    if (!window.confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÁßëÁõÆ„Äå${sub}„ÄçÂèäÂÖ∂ÊâÄÊúâÁ´†ËäÇÂíåÈ¢òÁõÆÂêóÔºü`)) return;
                    this.deleteSubject(sub);
                    if (App && App.ui && typeof App.ui.renderBankManager === 'function') {
                        App.ui.renderBankManager();
                    }
                },

                renameChapterInteractive(sub, chap) {
                    const next = window.prompt(`ËØ∑ËæìÂÖ•Êñ∞ÁöÑÁ´†ËäÇÂêçÁß∞Ôºà${sub}Ôºâ`, chap);
                    if (!next || next.trim() === chap) return;
                    this.renameChapter(sub, chap, next.trim());
                    if (App && App.ui && typeof App.ui.renderBankManager === 'function') {
                        App.ui.renderBankManager();
                    }
                },

                deleteChapterInteractive(sub, chap) {
                    if (!window.confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Á´†ËäÇ„Äå${sub} / ${chap}„ÄçÂèäÂÖ∂ÊâÄÊúâÈ¢òÁõÆÂêóÔºü`)) return;
                    this.deleteChapter(sub, chap);
                    if (App && App.ui && typeof App.ui.renderBankManager === 'function') {
                        App.ui.renderBankManager();
                    }
                },

                /**
                 * Ê†∏ÂøÉÊñπÊ≥ïÔºö‰øùÂ≠òÊï∞ÊçÆÂà∞‰∫ëÁ´Ø (Core: Save to Cloud)
                 * ÂåÖÂê´Èò≤Êäñ (Debounce)„ÄÅÈîÅÊú∫Âà∂ (Locking) ÂíåÂ¢ûÈáèÊõ¥Êñ∞ÈÄªËæë
                 */
                async saveToCloud() {
                    // 1. Âπ∂ÂèëÈîÅÔºöÂ¶ÇÊûúÊ≠£Âú®‰øùÂ≠òÊàñÊ≠£Âú®Âä†ËΩΩÔºåÂàôÊ†áËÆ∞‰∏∫"ÈúÄË¶ÅÂÜçÊ¨°‰øùÂ≠ò"Âπ∂ËøîÂõû
                    // ËøôÈò≤Ê≠¢‰∫ÜÂ§ö‰∏™Âπ∂ÂèëËØ∑Ê±ÇÂØºËá¥ÁöÑÁâàÊú¨ÂÜ≤Á™Å (409 Error)
                    if (this._isSaving) {
                        this._saveAgainPending = true;
                        return;
                    }
                    if (this._cloudLoading) {
                        this._saveAgainPending = true;
                        return;
                    }

                    if (!App.auth || typeof App.auth.getToken !== 'function') return;
                    this._isSaving = true;
                    try {
                        const token = await App.auth.getToken();
                        if (!token) return;

                        // 2. Á°Æ‰øùÂú®‰øùÂ≠òÂâçÂ∑≤Áªè‰ªé‰∫ëÁ´ØÂä†ËΩΩËøáÊúÄÊñ∞Êï∞ÊçÆ
                        if (!this._syncReady) {
                            await this.loadFromCloud();
                            // If load failed or is still pending (should be awaited), check ready again
                            if (!this._syncReady) return;
                        }
                        const bank = this.bank || {};
                        const history = Array.isArray(this.history) ? this.history : [];
                        const trash = this.trash || {};
                        const lastPracticeTime = this.lastPracticeTime || null;
                        this.normalizeBankStructure();
                        const questions = [];
                        let totalTrash = 0;

                        // 3. ÊâÅÂπ≥ÂåñÈ¢òÂ∫ìÁªìÊûÑÔºå‰æø‰∫éÁªüËÆ°Âíå‰º†Ëæì
                        for (const sub in bank) {
                            if (!bank[sub]) continue;
                            for (const chap in bank[sub]) {
                                const arr = bank[sub][chap];
                                if (!Array.isArray(arr)) continue;
                                arr.forEach(q => {
                                    if (q && typeof q === 'object') {
                                        questions.push(q);
                                    }
                                });
                            }
                        }
                        for (const sub in trash) {
                            if (!trash[sub]) continue;
                            for (const chap in trash[sub]) {
                                const arr = trash[sub][chap];
                                if (!Array.isArray(arr)) continue;
                                totalTrash += arr.length;
                            }
                        }
                        if (!questions.length && !history.length && !totalTrash) return;

                        const counts = {
                            questions: questions.length,
                            history: history.length,
                            trash: totalTrash
                        };
                        const prev = this._lastSyncedCounts || { questions: 0, history: 0, trash: 0 };
                        const delta = {
                            questions: counts.questions - prev.questions,
                            history: counts.history - prev.history,
                            trash: counts.trash - prev.trash
                        };
                        const inferredName = this.bankName || Object.keys(bank || {})[0] || "ÈªòËÆ§È¢òÂ∫ì";

                        // 4. ‰ºòÂåñÔºöÂ¶ÇÊûúÈ¢òÂ∫ìÂÜÖÂÆπÊ≤°ÊúâÂèòÂä®ÔºàDirty Flag ‰∏∫ falseÔºâÔºåÂàôË∑≥ËøáÂÖ®ÈáèÈ¢òÁõÆ‰∏ä‰º†
                        // ‰ªÖÊõ¥Êñ∞ÂÖÉÊï∞ÊçÆ (State) ÂíåÂéÜÂè≤ËÆ∞ÂΩïÔºåËäÇÁúÅÂ∏¶ÂÆΩ
                        const skipQuestionsUpdate = !this._bankDirty && delta.questions === 0;

                        // ========== Â¢ûÈáèÂêåÊ≠•ÂÜ≥Á≠ñ ==========
                        // Â¶ÇÊûúÂè™Êúâ history ÂèòÂä®Ôºàbank/trash Ê≤°ÂèòÔºâÔºå‰ΩøÁî®Â¢ûÈáèÊ®°Âºè
                        const historyBuffer = Array.isArray(this._historyAppendBuffer) ? this._historyAppendBuffer : [];
                        const useIncrementalSync = !this._bankDirty
                            && delta.questions === 0
                            && delta.trash === 0
                            && historyBuffer.length > 0;

                        if (window.App && App.sync && typeof App.sync.setDebug === 'function') {
                            App.sync.setDebug({
                                time: Date.now(),
                                name: inferredName,
                                questionsCount: questions.length,
                                historyCount: history.length,
                                trashCount: totalTrash,
                                skipQuestionsUpdate,
                                useIncrementalSync,
                                historyBufferSize: historyBuffer.length,
                                version: typeof this.remoteVersion === "number" ? this.remoteVersion : 0
                            });
                        }

                        // 5. ÊûÑÈÄ†Ë¶Å‰øùÂ≠òÁöÑÂÆåÊï¥Áä∂ÊÄÅÊ†ë
                        const state = {
                            bank,
                            bankName: this.bankName || null,
                            history,
                            lastPracticeTime,
                            trash,
                            hiddenMistakeIds: Array.isArray(this.hiddenMistakeIds) ? this.hiddenMistakeIds : []
                        };
                        const allIds = [];
                        for (const sub in bank) {
                            for (const chap in bank[sub]) {
                                const arr = bank[sub][chap];
                                if (!Array.isArray(arr)) continue;
                                arr.forEach(q => {
                                    if (q && typeof q.id === 'string') allIds.push(q.id);
                                });
                            }
                        }
                        const prevIds = Array.isArray(this._lastSyncedQuestionIds) ? this._lastSyncedQuestionIds : [];
                        const prevSet = new Set(prevIds);
                        const currSet = new Set(allIds);
                        const addedIds = [];
                        const removedIds = [];
                        currSet.forEach(id => {
                            if (!prevSet.has(id)) addedIds.push(id);
                        });
                        prevSet.forEach(id => {
                            if (!currSet.has(id)) removedIds.push(id);
                        });


                        let res;
                        try {
                            if (window.App && App.sync && typeof App.sync.setStatus === 'function') {
                                App.sync.setStatus('pending', null, null);
                            }
                            if (!this._pendingSaveState) {
                                this._pendingSaveState = {
                                    bank: JSON.parse(JSON.stringify(this.bank || {})),
                                    history: Array.isArray(this.history) ? this.history.slice() : [],
                                    trash: JSON.parse(JSON.stringify(this.trash || {})),
                                    lastPracticeTime: this.lastPracticeTime || null,
                                    hiddenMistakeIds: Array.isArray(this.hiddenMistakeIds) ? this.hiddenMistakeIds.slice() : [],
                                    bankName: this.bankName || ''
                                };
                            }
                            res = await fetch((App.apiBase || '') + "/api/save-question-set", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: "Bearer " + token
                                },
                                body: JSON.stringify(useIncrementalSync ? {
                                    // ========== Â¢ûÈáèÊ®°ÂºèÔºö‰ªÖÂèëÈÄÅÊñ∞Â¢û history ==========
                                    name: inferredName,
                                    statePartial: true,
                                    historyAppend: historyBuffer,
                                    skipQuestionsUpdate: true,
                                    version: typeof this.remoteVersion === "number" ? this.remoteVersion : 0,
                                    partialFields: ['lastPracticeTime'],
                                    partialValues: { lastPracticeTime: lastPracticeTime },
                                    delta: {
                                        questions: 0,
                                        history: historyBuffer.length,
                                        trash: 0,
                                        incremental: true
                                    }
                                } : {
                                    // ========== ÂÖ®ÈáèÊ®°ÂºèÔºàÂéüÈÄªËæëÔºâ ==========
                                    name: inferredName,
                                    questions,
                                    state,
                                    skipQuestionsUpdate,
                                    version: typeof this.remoteVersion === "number" ? this.remoteVersion : 0,
                                    // ÂêåÊó∂ÈôÑÂ∏¶ historyAppend ‰ª•Èò≤‰∏á‰∏Ä
                                    historyAppend: historyBuffer.length > 0 ? historyBuffer : undefined,
                                    delta: {
                                        questions: delta.questions,
                                        history: delta.history,
                                        trash: delta.trash,
                                        questionIds: {
                                            added: addedIds,
                                            removed: removedIds
                                        }
                                    }
                                })
                            });
                        } catch (e) {
                            console.error("‰øùÂ≠òÈ¢òÂ∫ìÂà∞‰∫ëÁ´ØÂ§±Ë¥•", e);
                            if (window.App && App.sync && typeof App.sync.showSyncStatus === 'function') {
                                App.sync.showSyncStatus('error', delta, 'ÁΩëÁªúÈîôËØØÊàñÊó†Ê≥ïËøûÊé•ÊúçÂä°Âô®');
                            }
                            return;
                        }
                        try {
                            const data = await res.json();
                            if (!res.ok || !data) {
                                console.error("‰øùÂ≠òÈ¢òÂ∫ìÂà∞‰∫ëÁ´ØÂ§±Ë¥•", data);
                                if (window.App && App.sync && typeof App.sync.showSyncStatus === 'function') {
                                    const msg = (data && (data.error || data.detail)) || 'Êú™Áü•ÈîôËØØ';
                                    App.sync.showSyncStatus('error', delta, msg);
                                }
                                if (res.status === 409 && window.App && App.data && typeof App.data.loadFromCloud === "function") {
                                    try {
                                        // Temporarily release lock to allow loadFromCloud
                                        this._isSaving = false;
                                        await App.data.loadFromCloud();
                                        this._isSaving = true;

                                        if (typeof this._retryAfterConflictOnce !== 'number') this._retryAfterConflictOnce = 0;
                                        if (this._retryAfterConflictOnce < 1) {
                                            this._retryAfterConflictOnce++;
                                            if (this._pendingSaveState) {
                                                this._suppressCloudSync = true;
                                                const s = this._pendingSaveState;
                                                this.bank = s.bank || {};
                                                this.history = Array.isArray(s.history) ? s.history : [];
                                                this.trash = s.trash || {};
                                                this.lastPracticeTime = s.lastPracticeTime || null;
                                                this.hiddenMistakeIds = Array.isArray(s.hiddenMistakeIds) ? s.hiddenMistakeIds : [];
                                                this.bankName = s.bankName || this.bankName;
                                                this._safeSetItem(this.bankKey, JSON.stringify(this.bank));
                                                this._safeSetItem(this.historyKey, JSON.stringify({
                                                    history: this.history,
                                                    lastPracticeTime: this.lastPracticeTime,
                                                    hiddenMistakeIds: this.hiddenMistakeIds
                                                }));
                                                this._safeSetItem(this.trashKey, JSON.stringify(this.trash));
                                                if (this.bankName) this._safeSetItem(this.bankNameKey, this.bankName);
                                                this._bankDirty = true;
                                                this._suppressCloudSync = false;
                                            }
                                            // Trigger retry via saveAgainPending logic
                                            this._saveAgainPending = true;
                                        } else {
                                            this._retryAfterConflictOnce = 0;
                                        }
                                    } catch (e) {
                                        console.error("loadFromCloud after conflict failed", e);
                                        this._isSaving = true; // Restore lock if it was released
                                    }
                                }
                            } else {
                                this._lastSyncedCounts = counts;
                                this._lastSyncedQuestionIds = allIds;
                                if (typeof data.version === "number" && Number.isFinite(data.version)) {
                                    this.remoteVersion = data.version;
                                }
                                if (window.App && App.sync && typeof App.sync.showSyncStatus === 'function') {
                                    App.sync.showSyncStatus('success', delta);
                                }
                                this._bankDirty = false;
                                this.bankName = inferredName;
                                this._safeSetItem(this.bankNameKey, this.bankName);
                                this._retryAfterConflictOnce = 0;
                                this._pendingSaveState = null;
                                // ========== Â¢ûÈáèÂêåÊ≠•ÔºöÊ∏ÖÁ©∫ buffer ==========
                                this._historyAppendBuffer = [];
                                // Êõ¥Êñ∞ÊúÄÂêéÂêåÊ≠•ÁöÑ history Êó∂Èó¥Êà≥
                                if (this.history.length > 0) {
                                    this._lastHistoryTimestamp = this.history[this.history.length - 1].t || 0;
                                }
                            }
                        } catch (e) {
                            console.error("Ëß£Êûê‰∫ëÁ´Ø‰øùÂ≠òÂìçÂ∫îÂ§±Ë¥•", e);
                            if (window.App && App.sync && typeof App.sync.showSyncStatus === 'function') {
                                App.sync.showSyncStatus('error', delta, 'Ëß£ÊûêÊúçÂä°Âô®ÂìçÂ∫îÂ§±Ë¥•');
                            }
                        }
                    } finally {
                        this._isSaving = false;
                        if (this._saveAgainPending) {
                            this._saveAgainPending = false;
                            this.saveToCloudDebounced();
                        }
                    }
                },

                saveToCloudDebounced() {
                    if (this._cloudSaveTimer) {
                        clearTimeout(this._cloudSaveTimer);
                    }
                    if (!App.auth || !App.auth.session) return;
                    if (!this._syncReady) {
                        this._deferredSave = true;
                        this.loadFromCloud();
                        return;
                    }
                    if (window.App && App.sync && typeof App.sync.setStatus === 'function') {
                        App.sync.setStatus('pending', null, null);
                    }
                    this._cloudSaveTimer = setTimeout(() => {
                        this._cloudSaveTimer = null;
                        this.saveToCloud();
                    }, 400);
                },

                /**
                 * Ê†∏ÂøÉÊñπÊ≥ïÔºö‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆ (Core: Load from Cloud)
                 * Â§ÑÁêÜÊï∞ÊçÆÂêàÂπ∂„ÄÅÁâàÊú¨Ê†°È™åÂíåÁä∂ÊÄÅÊÅ¢Â§ç
                 */
                async loadFromCloud() {
                    if (!App.auth || typeof App.auth.getToken !== 'function') return;

                    // 1. Âπ∂ÂèëÊéßÂà∂ÔºöÂ¶ÇÊûúÂ∑≤ÁªèÂú®Âä†ËΩΩ‰∏≠ÔºåÁõ¥Êé•ËøîÂõûÂΩìÂâçÁöÑ Promise
                    // ÈÅøÂÖçÈáçÂ§çËØ∑Ê±ÇÊµ™Ë¥πËµÑÊ∫ê
                    if (this._cloudLoading) {
                        if (this._loadPromise) return this._loadPromise;
                        return;
                    }
                    this._cloudLoading = true;
                    this._loadPromise = (async () => {
                        try {
                            const token = await App.auth.getToken();
                            if (!token) return;

                            let res;
                            try {
                                // ========== ETag + Â¢ûÈáèÂä†ËΩΩ ==========
                                let loadUrl = (App.apiBase || '') + "/api/load-question-set";
                                // Â¶ÇÊûúÂ∑≤ÁªèÊàêÂäüÂä†ËΩΩËøáÔºåÂèëÈÄÅ historyAfter ÂèÇÊï∞Âä†ÈÄüÂêéÁª≠Âä†ËΩΩ
                                if (this._lastHistoryTimestamp > 0 && this._syncReady) {
                                    loadUrl += '?historyAfter=' + this._lastHistoryTimestamp;
                                }
                                const headers = {
                                    Authorization: "Bearer " + token
                                };
                                // ETag: Â¶ÇÊûúÊúâ‰∏äÊ¨°ÁöÑ ETagÔºåÂèëÈÄÅ If-None-Match
                                if (this._lastEtag) {
                                    headers['If-None-Match'] = this._lastEtag;
                                }
                                res = await fetch(loadUrl, {
                                    method: "GET",
                                    headers
                                });
                            } catch (e) {
                                console.error("‰ªé‰∫ëÁ´ØÂä†ËΩΩÈ¢òÂ∫ìÂ§±Ë¥•", e);
                                this._syncReady = true;
                                if (this._deferredSave) {
                                    this._deferredSave = false;
                                    this.saveToCloudDebounced();
                                }
                                return;
                            }
                            // ========== 304 Not Modified: Êï∞ÊçÆÊú™ÂèòÂåñÔºåË∑≥ËøáÂ§ÑÁêÜ ==========
                            if (res.status === 304) {
                                this._syncReady = true;
                                if (this._deferredSave) {
                                    this._deferredSave = false;
                                    this.saveToCloudDebounced();
                                }
                                return;
                            }
                            if (!res.ok) {
                                console.error("‰ªé‰∫ëÁ´ØÂä†ËΩΩÈ¢òÂ∫ìÂ§±Ë¥•", res.status);
                                if (window.App && App.sync && typeof App.sync.showSyncStatus === 'function') {
                                    App.sync.showSyncStatus('error', null, '‰ªé‰∫ëÁ´ØÂä†ËΩΩÈ¢òÂ∫ìÂ§±Ë¥• (HTTP ' + res.status + ')');
                                }
                                this._syncReady = true;
                                if (this._deferredSave) {
                                    this._deferredSave = false;
                                    this.saveToCloudDebounced();
                                }
                                return;
                            }
                            // ‰øùÂ≠ò ETag
                            const newEtag = res.headers.get('etag');
                            if (newEtag) {
                                this._lastEtag = newEtag;
                            }
                            let data;
                            try {
                                data = await res.json();
                            } catch (e) {
                                console.error("Ëß£Êûê‰∫ëÁ´ØÈ¢òÂ∫ìÂìçÂ∫îÂ§±Ë¥•", e);
                                this._syncReady = true;
                                if (this._deferredSave) {
                                    this._deferredSave = false;
                                    this.saveToCloudDebounced();
                                }
                                return;
                            }
                            if (!data || !data.ok) {
                                return;
                            }

                            // 2. Ëß£Êûê‰∫ëÁ´ØËøîÂõûÁöÑÊï∞ÊçÆÂåÖ
                            const state = data.state && typeof data.state === "object" ? data.state : null;
                            if (!state) {
                                // Â¶ÇÊûú‰∫ëÁ´ØÊòØÁ©∫ÁöÑÔºàÊñ∞Áî®Êà∑ÔºâÔºåÂàùÂßãÂåñÁâàÊú¨Âè∑
                                if (typeof data.version === "number" && Number.isFinite(data.version)) {
                                    this.remoteVersion = data.version;
                                } else {
                                    this.remoteVersion = 0;
                                }
                                this._syncReady = true;
                                if (this._deferredSave) {
                                    this._deferredSave = false;
                                    this.saveToCloudDebounced();
                                }
                                return;
                            }

                            // 3. Â∫îÁî®Êï∞ÊçÆÂà∞Êú¨Âú∞
                            // _suppressCloudSync Ê†áÂøó‰ΩçÈò≤Ê≠¢Â∫îÁî®Êï∞ÊçÆÊó∂Ëß¶Âèë‰∏çÂøÖË¶ÅÁöÑËá™Âä®‰øùÂ≠ò
                            this._suppressCloudSync = true;
                            if (typeof data.version === "number" && Number.isFinite(data.version)) {
                                this.remoteVersion = data.version;
                            } else {
                                this.remoteVersion = 0;
                            }
                            this.bank = state.bank && typeof state.bank === "object" ? state.bank : {};
                            // ========== Â¢ûÈáè history ÂêàÂπ∂ ==========
                            if (data.historyPartial && Array.isArray(state.history)) {
                                // ÊúçÂä°Á´ØËøîÂõûÁöÑÊòØÂ¢ûÈáè historyÔºåÂêàÂπ∂Âà∞Êú¨Âú∞ËÄåÈùûÊõøÊç¢
                                const existingTimestamps = new Set(this.history.map(h => h.t));
                                const newEntries = state.history.filter(h => !existingTimestamps.has(h.t));
                                if (newEntries.length > 0) {
                                    this.history = this.history.concat(newEntries);
                                }
                            } else {
                                this.history = Array.isArray(state.history) ? state.history : [];
                            }
                            // Êõ¥Êñ∞ _lastHistoryTimestamp
                            if (this.history.length > 0) {
                                const maxT = this.history.reduce((m, h) => Math.max(m, h.t || 0), 0);
                                this._lastHistoryTimestamp = maxT;
                            }
                            this.lastPracticeTime =
                                typeof state.lastPracticeTime === "number" ? state.lastPracticeTime : null;
                            this.trash = state.trash && typeof state.trash === "object" ? state.trash : {};
                            this.hiddenMistakeIds = Array.isArray(state.hiddenMistakeIds) ? state.hiddenMistakeIds : [];
                            this.bankName = typeof data.name === "string" && data.name ? data.name : (state.bankName || this.bankName || '');
                            if (this.bankName) {
                                this._safeSetItem(this.bankNameKey, this.bankName);
                            }
                            // ÊåÅ‰πÖÂåñÂà∞ LocalStorage
                            this._safeSetItem(this.bankKey, JSON.stringify(this.bank));
                            this._safeSetItem(this.historyKey, JSON.stringify({
                                history: this.history,
                                lastPracticeTime: this.lastPracticeTime,
                                hiddenMistakeIds: this.hiddenMistakeIds
                            }));
                            this._safeSetItem(this.trashKey, JSON.stringify(this.trash));
                            const bankCount = (() => {
                                let n = 0;
                                for (const sub in this.bank) {
                                    for (const chap in this.bank[sub] || {}) {
                                        const arr = this.bank[sub][chap];
                                        if (Array.isArray(arr)) n += arr.length;
                                    }
                                }
                                return n;
                            })();
                            const allIds = [];
                            for (const sub in this.bank) {
                                for (const chap in this.bank[sub]) {
                                    const arr = this.bank[sub][chap];
                                    if (!Array.isArray(arr)) continue;
                                    arr.forEach(q => {
                                        if (q && typeof q.id === 'string') allIds.push(q.id);
                                    });
                                }
                            }
                            const trashCount = (() => {
                                let n = 0;
                                for (const sub in this.trash) {
                                    for (const chap in this.trash[sub] || {}) {
                                        const arr = this.trash[sub][chap];
                                        if (Array.isArray(arr)) n += arr.length;
                                    }
                                }
                                return n;
                            })();
                            this._lastSyncedCounts = {
                                questions: bankCount,
                                history: this.history.length,
                                trash: trashCount
                            };
                            this._lastSyncedQuestionIds = allIds;
                            this._bankDirty = false;
                            this._syncReady = true;
                            this._suppressCloudSync = false;
                            if (window.App && App.router && typeof App.router.refresh === 'function') {
                                App.router.refresh();
                            }
                            if (this._deferredSave) {
                                this._deferredSave = false;
                                this.saveToCloudDebounced();
                            }
                        } finally {
                            this._cloudLoading = false;
                            this._loadPromise = null;
                        }
                    })();

                    return this._loadPromise;
                },

                // ÊåÅ‰πÖÂåñÂõûÊî∂Á´ô
                persistTrash() {
                    this._safeSetItem(this.trashKey, JSON.stringify(this.trash));
                    if (!this._suppressCloudSync && this.saveToCloudDebounced) {
                        this.saveToCloudDebounced();
                    }
                },

                /**
                 * ËΩØÂà†Èô§ÔºöÂ∞ÜÊåáÂÆö ID ÁöÑÈ¢òÁõÆ‰ªé bank ÁßªÂä®Âà∞ trash
                 */
                softDeleteByIds(idSet, reason = 'manual-delete') {
                    const now = Date.now();
                    let changed = false;

                    for (const sub in this.bank) {
                        for (const chap in this.bank[sub]) {
                            const arr = this.bank[sub][chap];
                            if (!Array.isArray(arr) || !arr.length) continue;

                            const remain = [];
                            arr.forEach(q => {
                                if (!idSet.has(q.id)) {
                                    remain.push(q);
                                } else {
                                    if (!this.trash[sub]) this.trash[sub] = {};
                                    if (!this.trash[sub][chap]) this.trash[sub][chap] = [];
                                    this.trash[sub][chap].push({
                                        ...q,
                                        deletedAt: now,
                                        deletedBy: 'user',
                                        reason,
                                        originalPath: { sub, chap }
                                    });
                                    changed = true;
                                }
                            });

                            this.bank[sub][chap] = remain;
                        }
                    }

                    // ÂêåÊ≠•Ê∏ÖÁêÜÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Â∑≤Ë¢´Âà†Èô§È¢òÁõÆÁöÑÁ≠îÈ¢òËÆ∞ÂΩïÔºå‰øùÊåÅÁªüËÆ°Êï∞ÊçÆ‰∏ÄËá¥
                    if (idSet && idSet.size > 0 && Array.isArray(this.history) && this.history.length) {
                        const beforeLen = this.history.length;
                        this.history = this.history.filter(h => !idSet.has(h.id));
                        if (this.history.length !== beforeLen) {
                            this.saveHistory();
                            this._isHistoryDirty = true;
                        }
                    }

                    if (changed) {
                        this.persistBank();
                        this.persistTrash();
                    }
                },

                // ‰ªéÂõûÊî∂Á´ôÊÅ¢Â§çÂçïÈ¢ò
                restoreFromTrash(sub, chap, id) {
                    if (!this.trash[sub] || !this.trash[sub][chap]) return;
                    const arr = this.trash[sub][chap];
                    const idx = arr.findIndex(q => q.id === id);
                    if (idx === -1) return;

                    const q = arr[idx];
                    const targetSub = q.originalPath?.sub || sub;
                    const targetChap = q.originalPath?.chap || chap;
                    const { deletedAt, deletedBy, reason, originalPath, ...cleanQ } = q;

                    if (!this.bank[targetSub]) this.bank[targetSub] = {};
                    if (!this.bank[targetSub][targetChap]) this.bank[targetSub][targetChap] = [];
                    this.bank[targetSub][targetChap].push(cleanQ);

                    arr.splice(idx, 1);
                    if (!arr.length) delete this.trash[sub][chap];
                    if (!Object.keys(this.trash[sub] || {}).length) delete this.trash[sub];

                    this.persistBank();
                    this.persistTrash();
                },

                // ‰ªéÂõûÊî∂Á´ôÂΩªÂ∫ïÂà†Èô§
                destroyFromTrash(sub, chap, id) {
                    if (!this.trash[sub] || !this.trash[sub][chap]) return;
                    const arr = this.trash[sub][chap];
                    const idx = arr.findIndex(q => q.id === id);
                    if (idx === -1) return;

                    arr.splice(idx, 1);
                    if (!arr.length) delete this.trash[sub][chap];
                    if (!Object.keys(this.trash[sub] || {}).length) delete this.trash[sub];

                    this.persistTrash();
                },

                // Ê∏ÖÁ©∫ÂõûÊî∂Á´ô
                emptyTrash() {
                    if (!confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂõûÊî∂Á´ô‰∏≠ÁöÑÊâÄÊúâÈ¢òÁõÆÂêóÔºüËØ•Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ")) return;
                    this.trash = {};
                    this.persistTrash();
                    if (window.App && App.ui && typeof App.ui.openTrashModal === 'function') {
                        App.ui.openTrashModal();
                    }
                },

                _idCounter: 0,

                generateQuestionId() {
                    if (typeof this._idCounter !== 'number') this._idCounter = 0;
                    return `q-${Date.now()}-${(this._idCounter++).toString(36)}-${Math.random().toString(36).slice(2, 4)}`;
                },

                upsertQuestion(question) {
                    const q = { ...question };
                    if (!q.id || typeof q.id !== 'string') {
                        q.id = this.generateQuestionId();
                    }

                    if (!this.bank[q.sub]) this.bank[q.sub] = {};
                    if (!this.bank[q.sub][q.chap]) this.bank[q.sub][q.chap] = [];

                    // Âà†Èô§ÂÖ®Â±ÄÊóß ID
                    for (const sub in this.bank) {
                        for (const chap in this.bank[sub]) {
                            const arr = this.bank[sub][chap];
                            const idx = arr.findIndex(x => x.id === q.id);
                            if (idx !== -1) {
                                arr.splice(idx, 1);
                                if (!arr.length) delete this.bank[sub][chap];
                            }
                        }
                        if (!Object.keys(this.bank[sub] || {}).length) delete this.bank[sub];
                    }

                    this.bank[q.sub][q.chap].push(q);
                    this.persistBank();
                },

                removeQuestionsById(idSet) {
                    let changed = false;
                    for (const sub in this.bank) {
                        for (const chap in this.bank[sub]) {
                            const arr = this.bank[sub][chap];
                            const next = arr.filter(q => !idSet.has(q.id));
                            if (next.length !== arr.length) {
                                this.bank[sub][chap] = next;
                                changed = true;
                            }
                        }
                    }
                    if (changed) this.persistBank();
                },

                getSubjects() { return Object.keys(this.bank); },
                getChapters(sub) { return this.bank[sub] ? Object.keys(this.bank[sub]) : []; },

                getStats() {
                    const all = this.getQuestions();
                    const h = this.history;
                    const corr = h.filter(x => x.r).length;
                    const errFreq = {};
                    h.filter(x => !x.r).forEach(x => { errFreq[x.id] = (errFreq[x.id] || 0) + 1; });

                    const topMistakes = Object.entries(errFreq).sort((a, b) => b[1] - a[1]).slice(0, 10)
                        .map(([id, count]) => { const q = this.getQuestionById(id); return q ? { ...q, count, a: q.a, type: q.type, o: q.o } : null; }).filter(Boolean);

                    let timeText = '‰ªéÊú™ÁªÉ‰π† (Never Practiced)';
                    if (this.lastPracticeTime) {
                        const diff = Date.now() - this.lastPracticeTime;
                        const mins = Math.floor(diff / 60000);
                        if (mins < 60) {
                            timeText = `Ë∑ùÁ¶ª‰∏äÊ¨°ÁªÉ‰π†Â∑≤ËøáÂéªÔºö${mins}ÂàÜÈíü (Minutes ago)`;
                        } else {
                            const hrs = Math.floor(mins / 60);
                            const m = mins % 60;
                            timeText = `Ë∑ùÁ¶ª‰∏äÊ¨°ÁªÉ‰π†Â∑≤ËøáÂéªÔºö${hrs}Â∞èÊó∂${m}ÂàÜÈíü`;
                        }
                    }

                    const subjectStats = {};
                    this.getSubjects().forEach(sub => {
                        const subQids = new Set(all.filter(q => q.sub === sub).map(q => q.id));
                        const subH = h.filter(x => subQids.has(x.id));
                        subjectStats[sub] = {
                            attempts: subH.length,
                            correct: subH.filter(x => x.r).length,
                            acc: subH.length ? Math.round(subH.filter(x => x.r).length / subH.length * 100) : 0
                        };
                    });

                    const typeStats = { mcq: { a: 0, c: 0 }, tf: { a: 0, c: 0 }, multi: { a: 0, c: 0 } };
                    h.forEach(x => {
                        const q = this.getQuestionById(x.id);
                        if (!q || !typeStats[q.type]) return;
                        typeStats[q.type].a++;
                        if (x.r) typeStats[q.type].c++;
                    });
                    Object.keys(typeStats).forEach(t => {
                        typeStats[t].acc = typeStats[t].a ? Math.round(typeStats[t].c / typeStats[t].a * 100) : 0;
                    });

                    const daily30 = [];
                    for (let i = 29; i >= 0; i--) {
                        const d = new Date(); d.setDate(d.getDate() - i);
                        const ds = d.toISOString().slice(0, 10);
                        const recs = h.filter(x => new Date(x.t).toISOString().slice(0, 10) === ds);
                        daily30.push({
                            date: ds,
                            label: `${d.getMonth() + 1}/${d.getDate()}`,
                            attempts: recs.length,
                            correct: recs.filter(x => x.r).length,
                            acc: recs.length ? Math.round(recs.filter(x => x.r).length / recs.length * 100) : null
                        });
                    }

                    const durRecords = h.filter(x => x.d > 0);
                    const avgDuration = durRecords.length
                        ? Math.round(durRecords.reduce((s, x) => s + x.d, 0) / durRecords.length / 1000)
                        : null;

                    const durBuckets = [0, 0, 0, 0, 0];
                    durRecords.forEach(x => {
                        const s = x.d / 1000;
                        if (s < 5) durBuckets[0]++;
                        else if (s < 15) durBuckets[1]++;
                        else if (s < 30) durBuckets[2]++;
                        else if (s < 60) durBuckets[3]++;
                        else durBuckets[4]++;
                    });

                    let streak = 0;
                    for (let i = 0; i <= 365; i++) {
                        const d = new Date(); d.setDate(d.getDate() - i);
                        const ds = d.toISOString().slice(0, 10);
                        if (h.some(x => new Date(x.t).toISOString().slice(0, 10) === ds)) streak++;
                        else break;
                    }

                    const subEntries = Object.entries(subjectStats).filter(([, v]) => v.attempts > 0);
                    const bestSub = subEntries.sort((a, b) => b[1].acc - a[1].acc)[0]?.[0] || null;
                    const worstSub = [...subEntries].sort((a, b) => a[1].acc - b[1].acc)[0]?.[0] || null;

                    return {
                        total: all.length,
                        acc: h.length ? Math.round((corr / h.length) * 100) : 0,
                        mistakes: Object.keys(errFreq).length,
                        topMistakes,
                        timeText,
                        subjectStats,
                        typeStats,
                        daily30,
                        avgDuration,
                        durBuckets,
                        streak,
                        bestSub,
                        worstSub,
                        totalAttempts: h.length,
                        totalCorrect: corr
                    };
                },
                clearMistakeHistory(id) {
                    if (!Array.isArray(this.hiddenMistakeIds)) this.hiddenMistakeIds = [];
                    if (!this.hiddenMistakeIds.includes(id)) {
                        this.hiddenMistakeIds.push(id);
                    }
                    this._errFreqCache = null;
                    this._isHistoryDirty = true;
                    this.saveHistory();
                },
                record(id, res, duration = 0) {
                    const now = Date.now();
                    const entry = { id, r: res, t: now, d: duration };
                    this.history.push(entry);
                    // Â¢ûÈáèÂêåÊ≠•ÔºöÂêåÊó∂ËøΩÂä†Âà∞ bufferÔºå‰æõ‰∏ãÊ¨° save Êó∂ÂèëÈÄÅ
                    this._historyAppendBuffer.push(entry);
                    this.lastPracticeTime = now;
                    this._isHistoryDirty = true;
                    this.saveHistory();
                }
            },

            ai: {
                _messages: [],
                _currentQ: null,
                _isLoading: false,
                _apiKey: '',
                _provider: 'glm',
                _queue: [],
                _isProcessingQueue: false,
                _lastCallAt: 0,
                _minIntervalMs: 1000,
                _monitorEnabled: false,
                _stats: {
                    totalRequests: 0,
                    totalErrors: 0,
                    totalPromptTokens: 0,
                    totalCompletionTokens: 0,
                    lastLatency: 0,
                    lastStatus: null,
                    lastError: '',
                    recent: []
                },

                _providers: {
                    glm: {
                        name: 'GLM-4-Flash (Êô∫Ë∞±)',
                        endpoint: 'https://open.bigmodel.cn/api/paas/v4/chat/completions',
                        model: 'glm-4-flash',
                        storageKey: 'lms_api_key_glm',
                        modelStorageKey: 'lms_model_glm',
                        authHeader: (key) => `Bearer ${key}`,
                        docsUrl: 'https://open.bigmodel.cn/usercenter/apikeys'
                    },
                    deepseek: {
                        name: 'DeepSeek-Chat',
                        endpoint: 'https://api.deepseek.com/chat/completions',
                        model: 'deepseek-chat',
                        storageKey: 'lms_api_key_deepseek',
                        modelStorageKey: 'lms_model_deepseek',
                        authHeader: (key) => `Bearer ${key}`,
                        docsUrl: 'https://platform.deepseek.com/api_keys'
                    },
                    openai: {
                        name: 'GPT-4o-mini (OpenAI)',
                        endpoint: 'https://api.openai.com/v1/chat/completions',
                        model: 'gpt-4o-mini',
                        storageKey: 'lms_api_key_openai',
                        modelStorageKey: 'lms_model_openai',
                        authHeader: (key) => `Bearer ${key}`,
                        docsUrl: 'https://platform.openai.com/api-keys'
                    },
                    gemini: {
                        name: 'Gemini 2.0 Flash (Google)',
                        endpoint: 'https://generativelanguage.googleapis.com/v1beta/openai/chat/completions',
                        model: 'gemini-2.0-flash',
                        storageKey: 'lms_api_key_gemini',
                        modelStorageKey: 'lms_model_gemini',
                        authHeader: (key) => `Bearer ${key}`,
                        docsUrl: 'https://aistudio.google.com/app/apikey'
                    },
                    moonshot: {
                        name: 'Moonshot (Kimi)',
                        endpoint: 'https://api.moonshot.cn/v1/chat/completions',
                        model: 'moonshot-v1-8k',
                        storageKey: 'lms_api_key_moonshot',
                        modelStorageKey: 'lms_model_moonshot',
                        authHeader: (key) => `Bearer ${key}`,
                        docsUrl: 'https://platform.moonshot.cn/console/api-keys'
                    },
                    qwen: {
                        name: 'ÈÄö‰πâÂçÉÈóÆ (Qwen)',
                        endpoint: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',
                        model: 'qwen-plus',
                        storageKey: 'lms_api_key_qwen',
                        modelStorageKey: 'lms_model_qwen',
                        authHeader: (key) => `Bearer ${key}`,
                        docsUrl: 'https://dashscope.aliyun.com/apiKey'
                    },
                    baichuan: {
                        name: 'ÁôæÂ∑ù Baichuan',
                        endpoint: 'https://api.baichuan-ai.com/v1/chat/completions',
                        model: 'Baichuan4',
                        storageKey: 'lms_api_key_baichuan',
                        modelStorageKey: 'lms_model_baichuan',
                        authHeader: (key) => `Bearer ${key}`,
                        docsUrl: 'https://platform.baichuan-ai.com/console/apikey'
                    },
                    minimax: {
                        name: 'MiniMax',
                        endpoint: 'https://api.minimax.chat/v1/text/chatcompletion_v2',
                        model: 'abab6.5-chat',
                        storageKey: 'lms_api_key_minimax',
                        modelStorageKey: 'lms_model_minimax',
                        authHeader: (key) => `Bearer ${key}`,
                        docsUrl: 'https://www.minimax.chat/document/guides/document_dev_landing'
                    },
                    custom: {
                        name: 'Ëá™ÂÆö‰πâ OpenAI ÂÖºÂÆπ API',
                        endpoint: '',
                        model: 'gpt-4o-mini',
                        storageKey: 'lms_api_key_custom',
                        modelStorageKey: 'lms_model_custom',
                        authHeader: (key) => `Bearer ${key}`,
                        docsUrl: 'about:blank'
                    }
                },

                init() {
                    this._provider = localStorage.getItem('lms_ai_provider') || 'glm';
                    const cfg = this._providers[this._provider];
                    this._apiKey = cfg ? (localStorage.getItem(cfg.storageKey) || '') : '';

                    const sel = App.dom.get('config-provider-select');
                    if (sel) sel.value = this._provider;

                    const keyInput = App.dom.get('config-api-key');
                    if (keyInput) keyInput.value = this._apiKey;

                    this.updateProviderUI();

                    const monitorFlag = localStorage.getItem('lms_ai_monitor') === '1';
                    this._monitorEnabled = monitorFlag;
                    const monitorToggle = App.dom.get('ai-monitor-toggle');
                    if (monitorToggle) monitorToggle.checked = monitorFlag;
                    this.updateMonitorUI();
                },

                getActiveModelName() {
                    const cfg = this._providers[this._provider];
                    if (!cfg) return '';
                    const key = cfg.modelStorageKey;
                    const saved = key ? (localStorage.getItem(key) || '') : '';
                    return saved || cfg.model;
                },

                getAdvancedParams() {
                    const temp = parseFloat(localStorage.getItem('lms_ai_param_temperature') || '');
                    const topP = parseFloat(localStorage.getItem('lms_ai_param_top_p') || '');
                    const maxTokens = parseInt(localStorage.getItem('lms_ai_param_max_tokens') || '', 10);
                    const presence = parseFloat(localStorage.getItem('lms_ai_param_presence') || '');
                    const frequency = parseFloat(localStorage.getItem('lms_ai_param_frequency') || '');
                    const timeout = parseInt(localStorage.getItem('lms_ai_param_timeout') || '', 10);
                    return {
                        temperature: isFinite(temp) ? temp : 0.7,
                        top_p: isFinite(topP) ? topP : 1.0,
                        max_tokens: isFinite(maxTokens) && maxTokens > 0 ? maxTokens : 1024,
                        presence_penalty: isFinite(presence) ? presence : 0.0,
                        frequency_penalty: isFinite(frequency) ? frequency : 0.0,
                        timeoutMs: isFinite(timeout) ? (timeout > 0 ? timeout : 0) : 60000
                    };
                },

                updateProviderUI() {
                    const cfg = this._providers[this._provider];
                    if (!cfg) return;

                    const keyInput = App.dom.get('config-api-key');
                    if (keyInput) keyInput.placeholder = `ËæìÂÖ• ${cfg.name} API KeyÔºåÂèØÊç¢Ë°åÂ°´ÂÜôÂ§ö‰∏™`;

                    const link = App.dom.get('config-docs-link');
                    if (link) {
                        link.href = cfg.docsUrl;
                        link.textContent = `Ëé∑Âèñ ${cfg.name} Key ‚Üí`;
                    }

                    const savedKey = localStorage.getItem(cfg.storageKey) || '';
                    this._apiKey = savedKey;
                    if (keyInput) keyInput.value = savedKey;

                    const modelInput = App.dom.get('config-model-name');
                    const activeModel = this.getActiveModelName();
                    if (modelInput) modelInput.value = activeModel;

                    const modelLabel = App.dom.get('config-current-model');
                    if (modelLabel) modelLabel.textContent = activeModel || cfg.model;

                    const adv = this.getAdvancedParams();
                    const tInput = App.dom.get('ai-param-temperature');
                    const pInput = App.dom.get('ai-param-top-p');
                    const mInput = App.dom.get('ai-param-max-tokens');
                    const prInput = App.dom.get('ai-param-presence');
                    const fInput = App.dom.get('ai-param-frequency');
                    const toInput = App.dom.get('ai-param-timeout');
                    if (tInput) tInput.value = String(adv.temperature);
                    if (pInput) pInput.value = String(adv.top_p);
                    if (mInput) mInput.value = String(adv.max_tokens);
                    if (prInput) prInput.value = String(adv.presence_penalty);
                    if (fInput) fInput.value = String(adv.frequency_penalty);
                    if (toInput) toInput.value = String(adv.timeoutMs);
                },

                onProviderChange(val) {
                    this._provider = val;
                    localStorage.setItem('lms_ai_provider', val);
                    this.updateProviderUI();
                },

                saveApiKey() {
                    const keyInput = App.dom.get('config-api-key');
                    const modelInput = App.dom.get('config-model-name');
                    const cfg = this._providers[this._provider];
                    if (keyInput && cfg) {
                        this._apiKey = keyInput.value.trim();
                        localStorage.setItem(cfg.storageKey, this._apiKey);
                    }
                    if (modelInput && cfg) {
                        const val = modelInput.value.trim();
                        if (cfg.modelStorageKey) {
                            if (val) localStorage.setItem(cfg.modelStorageKey, val);
                            else localStorage.removeItem(cfg.modelStorageKey);
                        }
                    }
                    const tInput = App.dom.get('ai-param-temperature');
                    const pInput = App.dom.get('ai-param-top-p');
                    const mInput = App.dom.get('ai-param-max-tokens');
                    const prInput = App.dom.get('ai-param-presence');
                    const fInput = App.dom.get('ai-param-frequency');
                    const toInput = App.dom.get('ai-param-timeout');
                    if (tInput && tInput.value) localStorage.setItem('lms_ai_param_temperature', tInput.value);
                    if (pInput && pInput.value) localStorage.setItem('lms_ai_param_top_p', pInput.value);
                    if (mInput && mInput.value) localStorage.setItem('lms_ai_param_max_tokens', mInput.value);
                    if (prInput && prInput.value) localStorage.setItem('lms_ai_param_presence', prInput.value);
                    if (fInput && fInput.value) localStorage.setItem('lms_ai_param_frequency', fInput.value);
                    if (toInput && toInput.value) localStorage.setItem('lms_ai_param_timeout', toInput.value);
                    this.updateProviderUI();
                    alert(`${cfg?.name || 'API ÈÖçÁΩÆ'} ‰øùÂ≠òÊàêÂäüÔºÅÊîØÊåÅÂ°´ÂÜôÂ§ö‰∏™ KeyÔºåÂπ∂Ëá™ÂÆö‰πâÊ®°ÂûãÂêçÁß∞„ÄÇ`);
                },

                saveAdvancedParams() {
                    const tInput = App.dom.get('ai-param-temperature');
                    const pInput = App.dom.get('ai-param-top-p');
                    const mInput = App.dom.get('ai-param-max-tokens');
                    const prInput = App.dom.get('ai-param-presence');
                    const fInput = App.dom.get('ai-param-frequency');
                    const toInput = App.dom.get('ai-param-timeout');
                    if (tInput && tInput.value !== '') localStorage.setItem('lms_ai_param_temperature', tInput.value);
                    else localStorage.removeItem('lms_ai_param_temperature');
                    if (pInput && pInput.value !== '') localStorage.setItem('lms_ai_param_top_p', pInput.value);
                    else localStorage.removeItem('lms_ai_param_top_p');
                    if (mInput && mInput.value !== '') localStorage.setItem('lms_ai_param_max_tokens', mInput.value);
                    else localStorage.removeItem('lms_ai_param_max_tokens');
                    if (prInput && prInput.value !== '') localStorage.setItem('lms_ai_param_presence', prInput.value);
                    else localStorage.removeItem('lms_ai_param_presence');
                    if (fInput && fInput.value !== '') localStorage.setItem('lms_ai_param_frequency', fInput.value);
                    else localStorage.removeItem('lms_ai_param_frequency');
                    if (toInput && toInput.value !== '') localStorage.setItem('lms_ai_param_timeout', toInput.value);
                    else localStorage.removeItem('lms_ai_param_timeout');
                    this.updateProviderUI();
                    alert('AI È´òÁ∫ßÂèÇÊï∞Â∑≤‰øùÂ≠ò„ÄÇ');
                },

                async call(messages, maxTokens = 1024, temperature = 0.7) {
                    return new Promise((resolve, reject) => {
                        this._queue.push({ messages, maxTokens, temperature, resolve, reject });
                        this._drainQueue();
                    });
                },

                async _drainQueue() {
                    if (this._isProcessingQueue) return;
                    this._isProcessingQueue = true;
                    while (this._queue.length) {
                        const job = this._queue.shift();
                        const now = Date.now();
                        const diff = now - this._lastCallAt;
                        if (this._lastCallAt && diff < this._minIntervalMs) {
                            await new Promise(r => setTimeout(r, this._minIntervalMs - diff));
                        }
                        try {
                            const result = await this._executeAPICall(job.messages, job.maxTokens, job.temperature);
                            job.resolve(result.content);
                        } catch (e) {
                            job.reject(e);
                        } finally {
                            this._lastCallAt = Date.now();
                        }
                    }
                    this._isProcessingQueue = false;
                },

                async _executeAPICall(messages, maxTokens, temperature) {
                    const cfg = this._providers[this._provider];
                    if (!cfg) throw new Error('Êú™Áü•ÁöÑÊ®°ÂûãÊèê‰æõÂïÜ (Unknown Provider)');
                    if (!this._apiKey) throw new Error('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ API Key (API Key missing)');

                    const adv = this.getAdvancedParams();
                    const finalTemp = Number.isFinite(temperature) ? temperature : adv.temperature;
                    const bodyMax = typeof maxTokens === 'number' ? maxTokens : adv.max_tokens;
                    const topP = adv.top_p;
                    const presencePenalty = adv.presence_penalty;
                    const frequencyPenalty = adv.frequency_penalty;
                    const timeoutMs = adv.timeoutMs;

                    const start = Date.now();
                    let status = 0;
                    let abortId = null;
                    const controller = typeof AbortController !== 'undefined' ? new AbortController() : null;
                    try {
                        const rawKey = this._apiKey || '';
                        const keyList = rawKey
                            .split(/[\n,;]/)
                            .map(s => s.trim())
                            .filter(Boolean);
                        if (!keyList.length) throw new Error('API Key ‰∏∫Á©∫ÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠Â°´ÂÜôËá≥Â∞ë‰∏Ä‰∏™ Key');
                        const keyIndex = Math.floor(Math.random() * keyList.length);
                        const useKey = keyList[keyIndex];
                        const endpoint = cfg.endpoint || localStorage.getItem('lms_ai_custom_endpoint') || '';
                        if (controller && typeof timeoutMs === 'number' && timeoutMs > 0) {
                            abortId = setTimeout(() => controller.abort(), timeoutMs);
                        }
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': cfg.authHeader(useKey)
                            },
                            signal: controller ? controller.signal : undefined,
                            body: JSON.stringify({
                                model: this.getActiveModelName(),
                                messages,
                                stream: false,
                                max_tokens: bodyMax,
                                temperature: finalTemp,
                                top_p: topP,
                                presence_penalty: presencePenalty,
                                frequency_penalty: frequencyPenalty
                            })
                        });
                        status = response.status;
                        const latency = Date.now() - start;
                        if (!response.ok) {
                            if (status === 429 || status === 503) {
                                this._minIntervalMs = Math.min(this._minIntervalMs * 2, 10000);
                            }
                            const errBody = await response.text();
                            this._updateMetrics({
                                ok: false,
                                status,
                                latency,
                                usage: null,
                                provider: this._provider,
                                model: cfg.model,
                                errorMessage: errBody.slice(0, 200)
                            });
                            throw new Error(`API Error ${status}: ${errBody.slice(0, 200)}`);
                        }
                        const data = await response.json();
                        const usage = data && data.usage ? data.usage : null;
                        this._updateMetrics({
                            ok: true,
                            status,
                            latency,
                            usage,
                            provider: this._provider,
                            model: cfg.model,
                            errorMessage: ''
                        });
                        const content = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content ? data.choices[0].message.content : '';
                        return { content, usage };
                    } catch (e) {
                        if (!status) {
                            const latency = Date.now() - start;
                            this._updateMetrics({
                                ok: false,
                                status: status || 0,
                                latency,
                                usage: null,
                                provider: this._provider,
                                model: cfg.model,
                                errorMessage: e && e.message ? e.message : String(e)
                            });
                        }
                        if (e && e.name === 'AbortError') {
                            throw new Error('ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ');
                        }
                        throw e;
                    } finally {
                        if (abortId) clearTimeout(abortId);
                    }
                },

                _updateMetrics(info) {
                    if (!this._stats) {
                        this._stats = {
                            totalRequests: 0,
                            totalErrors: 0,
                            totalPromptTokens: 0,
                            totalCompletionTokens: 0,
                            lastLatency: 0,
                            lastStatus: null,
                            lastError: '',
                            recent: []
                        };
                    }
                    this._stats.totalRequests++;
                    if (!info.ok) this._stats.totalErrors++;
                    const pt = info.usage && typeof info.usage.prompt_tokens === 'number' ? info.usage.prompt_tokens : 0;
                    const ct = info.usage && typeof info.usage.completion_tokens === 'number' ? info.usage.completion_tokens : 0;
                    this._stats.totalPromptTokens += pt;
                    this._stats.totalCompletionTokens += ct;
                    this._stats.lastLatency = info.latency;
                    this._stats.lastStatus = info.status;
                    this._stats.lastError = info.errorMessage || '';
                    const now = Date.now();
                    const record = {
                        ts: now,
                        provider: info.provider,
                        model: info.model,
                        ok: info.ok,
                        status: info.status,
                        latency: info.latency,
                        promptTokens: pt || null,
                        completionTokens: ct || null
                    };
                    this._stats.recent.push(record);
                    if (this._stats.recent.length > 20) this._stats.recent.shift();
                    this.updateMonitorUI();
                },

                getLastUsageRecord() {
                    if (!this._stats || !this._stats.recent || !this._stats.recent.length) return null;
                    const last = this._stats.recent[this._stats.recent.length - 1];
                    if (last && (last.promptTokens != null || last.completionTokens != null)) return last;
                    return null;
                },

                toggleMonitor(enabled) {
                    this._monitorEnabled = !!enabled;
                    localStorage.setItem('lms_ai_monitor', this._monitorEnabled ? '1' : '0');
                    this.updateMonitorUI();
                },

                updateMonitorUI() {
                    const panel = App.dom.get('ai-monitor-panel');
                    const summaryEl = App.dom.get('ai-monitor-summary');
                    const listEl = App.dom.get('ai-monitor-requests');
                    const toggle = App.dom.get('ai-monitor-toggle');
                    if (!panel || !summaryEl || !listEl || !toggle) return;
                    if (this._monitorEnabled) {
                        panel.classList.remove('hidden');
                        toggle.checked = true;
                    } else {
                        panel.classList.add('hidden');
                        toggle.checked = false;
                        return;
                    }
                    const s = this._stats || {
                        totalRequests: 0,
                        totalErrors: 0,
                        totalPromptTokens: 0,
                        totalCompletionTokens: 0,
                        lastLatency: 0,
                        lastStatus: null
                    };
                    const cfg = this._providers[this._provider];
                    const providerName = cfg ? cfg.name : this._provider;
                    const totalTokens = s.totalPromptTokens + s.totalCompletionTokens;
                    let tokenText = '';
                    if (totalTokens > 0) {
                        tokenText = `ÔºåToken Áî®ÈáèÔºöÊèêÁ§∫ ${s.totalPromptTokens}ÔºåÂõûÁ≠î ${s.totalCompletionTokens}ÔºåÂêàËÆ° ${totalTokens}`;
                    }
                    const statusText = typeof s.lastStatus === 'number' && s.lastStatus > 0 ? `ÔºåÊúÄËøëÁä∂ÊÄÅÁ†ÅÔºö${s.lastStatus}` : '';
                    const latencyText = s.lastLatency ? `ÔºåÊúÄËøëÂª∂ËøüÔºö${s.lastLatency}ms` : '';
                    summaryEl.textContent = `${providerName} ¬∑ ÊúÄÂ∞èÈó¥Èöî ${this._minIntervalMs}ms ¬∑ ËØ∑Ê±Ç ${s.totalRequests} Ê¨°ÔºåÈîôËØØ ${s.totalErrors} Ê¨°${statusText}${latencyText}${tokenText}`;
                    const records = (s.recent || []).slice().reverse();
                    if (!records.length) {
                        listEl.innerHTML = '<div class="text-[10px] text-[var(--sub)]">ÊöÇÊó†Ë∞ÉÁî®ËÆ∞ÂΩï„ÄÇ</div>';
                        return;
                    }
                    const rows = records.slice(0, 10).map(r => {
                        const date = new Date(r.ts);
                        const time = date.toLocaleTimeString();
                        const status = r.ok ? 'OK' : 'ERR';
                        const tokens = r.promptTokens != null || r.completionTokens != null ? `${r.promptTokens || 0}/${r.completionTokens || 0}` : 'Êó†';
                        return `<div class="flex justify-between gap-2"><span class="flex-1 truncate">${time} ¬∑ ${r.model}</span><span class="w-10 text-right">${status}</span><span class="w-14 text-right">${r.latency}ms</span><span class="w-16 text-right">${tokens}</span></div>`;
                    });
                    listEl.innerHTML = rows.join('');
                },

                setContext(q) {
                    this._currentQ = q;
                    this._messages = [];
                    const msgArea = App.dom.get('ai-chat-messages');
                    if (msgArea) msgArea.innerHTML = `
                        <div id="ai-chat-welcome" class="text-xs text-[var(--sub)] text-center py-4">
                            ‚ú® ÂØπËøôÈÅìÈ¢òÊúâÁñëÈóÆÔºüÂêë AI ÊèêÈóÆÂêß (Ask AI about this question)
                        </div>`;
                    const input = App.dom.get('ai-chat-input');
                    if (input) { input.value = ''; input.style.height = 'auto'; }
                },

                buildSystemPrompt(q) {
                    let optionsText = '';
                    if (q.type === 'mcq' || q.type === 'multi') {
                        optionsText = '\nÈÄâÈ°πÔºö\n' + (q.o || []).map((o, i) =>
                            `${String.fromCharCode(65 + i)}. ${o}`
                        ).join('\n');
                    }
                    const typeMap = { mcq: 'ÂçïÈÄâÈ¢ò', tf: 'Âà§Êñ≠È¢ò', multi: 'Â§öÈÄâÈ¢ò' };
                    const answerText = q.type === 'tf'
                        ? (q.a === 'T' ? 'Ê≠£Á°Æ' : 'ÈîôËØØ')
                        : q.a;

                    return `‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑÂ≠¶‰π†Âä©Êâã„ÄÇÁî®Êà∑Ê≠£Âú®Â≠¶‰π†‰ª•‰∏ãÈ¢òÁõÆÔºåËØ∑Âü∫‰∫éÈ¢òÁõÆÂÜÖÂÆπÂõûÁ≠îÁî®Êà∑ÁöÑÈóÆÈ¢òÔºåËß£ÈáäÁü•ËØÜÁÇπÔºåÂ∏ÆÂä©Áî®Êà∑ÁêÜËß£„ÄÇÂõûÁ≠îËØ∑ÁÆÄÊ¥ÅÊ∏ÖÊô∞Ôºå‰ΩøÁî®‰∏≠Êñá„ÄÇ

            È¢òÁõÆ‰ø°ÊÅØÔºö
            ÁßëÁõÆÔºö${q.sub}
            Á´†ËäÇÔºö${q.chap}
            È¢òÂûãÔºö${typeMap[q.type] || q.type}
            È¢òÁõÆÔºö${q.q}${optionsText}
            Ê≠£Á°ÆÁ≠îÊ°àÔºö${answerText}

            ËØ∑Ê†πÊçÆ‰ª•‰∏äÈ¢òÁõÆÂÜÖÂÆπÂõûÁ≠îÁî®Êà∑ÁöÑÈóÆÈ¢ò„ÄÇÂ¶ÇÊûúÁî®Êà∑ÁöÑÈóÆÈ¢ò‰∏éÈ¢òÁõÆÊó†ÂÖ≥Ôºå‰πüÂèØ‰ª•ÈÄÇÂΩìÂõûÁ≠îÔºå‰ΩÜ‰ºòÂÖàËÅöÁÑ¶Âú®È¢òÁõÆÁü•ËØÜÁÇπ‰∏ä„ÄÇ`;
                },

                buildMistakeProfile(pool) {
                    return pool.map(q => {
                        const records = App.data.history.filter(h => h.id === q.id);
                        const totalAttempts = records.length;
                        const wrongAttempts = records.filter(h => !h.r).length;
                        const errorRate = totalAttempts > 0 ? Math.round((wrongAttempts / totalAttempts) * 100) : 100;

                        const durRecords = records.filter(h => h.d > 0);
                        const avgDuration = durRecords.length > 0
                            ? Math.round(durRecords.reduce((s, h) => s + h.d, 0) / durRecords.length / 1000)
                            : null;

                        const lastRecord = records[records.length - 1];
                        const lastCorrect = lastRecord ? lastRecord.r : false;

                        let consecutiveWrong = 0;
                        for (let i = records.length - 1; i >= 0; i--) {
                            if (!records[i].r) consecutiveWrong++;
                            else break;
                        }

                        const daysSinceLastAttempt = lastRecord
                            ? Math.round((Date.now() - lastRecord.t) / 86400000)
                            : 999;

                        return {
                            id: q.id,
                            q: q.q.slice(0, 30),
                            sub: q.sub,
                            errorRate,
                            avgDuration,
                            consecutiveWrong,
                            lastCorrect,
                            daysSinceLastAttempt,
                            totalAttempts
                        };
                    });
                },

                buildAnalysisPrompt(profiles) {
                    const profileText = profiles.map((p, i) =>
                        `${i + 1}. [${p.sub}] "${p.q}..." | ÈîôËØØÁéá:${p.errorRate}% | ËøûÁª≠Á≠îÈîô:${p.consecutiveWrong}Ê¨° | Âπ≥ÂùáÁî®Êó∂:${p.avgDuration ?? 'Êú™Áü•'}Áßí | ‰∏äÊ¨°Á≠îÈ¢ò:${p.daysSinceLastAttempt}Â§©Ââç | ÊúÄËøë‰∏ÄÊ¨°:${p.lastCorrect ? '‚úìÊ≠£Á°Æ' : '‚úóÈîôËØØ'} | ÂÖ±Á≠î:${p.totalAttempts}Ê¨°`
                    ).join('\n');

                    return `‰Ω†ÊòØ‰∏Ä‰∏™Âü∫‰∫éËÆ§Áü•ÂøÉÁêÜÂ≠¶ÂíåËÆ∞ÂøÜÁßëÂ≠¶ÁöÑÂ≠¶‰π†ÂàÜÊûêÂä©Êâã„ÄÇ‰ª•‰∏ãÊòØÂ≠¶ÁîüÁöÑÈîôÈ¢òÊï∞ÊçÆÔºåËØ∑Ê†πÊçÆ‰ª•‰∏ãÂéüÂàôÂàÜÊûêÂπ∂ÁªôÂá∫ÊúÄ‰ºòÁöÑÂ§ç‰π†È°∫Â∫èÔºö

ÂàÜÊûêÂéüÂàôÔºö
1. ÈÅóÂøòÊõ≤Á∫øÔºöË∑ù‰∏äÊ¨°‰ΩúÁ≠îË∂ä‰πÖ‰∏îÂΩìÊó∂Á≠îÈîôÁöÑÈ¢òÔºåÈÅóÂøòÈ£éÈô©Ë∂äÈ´òÔºå‰ºòÂÖàÁ∫ßË∂äÈ´ò
2. È°ΩÂõ∫ÈîôÈ¢òÔºöËøûÁª≠Á≠îÈîôÊ¨°Êï∞Ë∂äÂ§öÔºåËØ¥ÊòéÁü•ËØÜÁÇπË∂äËñÑÂº±ÔºåÈúÄË¶Å‰ºòÂÖàÂº∫Âåñ
3. ‰ΩúÁ≠îÊó∂ÈïøÔºöÁî®Êó∂ÊûÅÁü≠‰ΩÜÁ≠îÈîôÔºàÂèØËÉΩÊòØÁåúÁöÑÔºâÂíåÁî®Êó∂ÊûÅÈïø‰ΩÜÁ≠îÈîôÔºàÁêÜËß£Âõ∞ÈöæÔºâÔºåÈÉΩÈúÄË¶ÅÈáçÁÇπÂÖ≥Ê≥®
4. ËøëÊúüÁä∂ÊÄÅÔºöÊúÄËøë‰∏ÄÊ¨°‰ªçÁ≠îÈîôÁöÑÈ¢òÊØîÂ∑≤Á≠îÂØπÁöÑÊõ¥Á¥ßËø´
5. ÈîôËØØÁéáÊùÉÈáçÔºöÈîôËØØÁéáË∂äÈ´òÔºåË∂äÈúÄË¶Å‰ºòÂÖàÂ§ç‰π†

È¢òÁõÆÊï∞ÊçÆÔºàÂÖ±${profiles.length}ÈÅìÔºâÔºö
${profileText}

ËØ∑ËøîÂõû‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºåÊåâÂ§ç‰π†‰ºòÂÖàÁ∫ß‰ªéÈ´òÂà∞‰ΩéÊéíÂàóÔºö
[
  { "id": "È¢òÁõÆid", "priority": "high/medium/low", "reason": "ÁÆÄÁü≠ÁöÑÂàÜÊûêÂéüÂõ†Ôºà20Â≠óÂÜÖÔºâ", "strategy": "quick_review/deep_study/reinforce" }
]

strategyÂê´‰πâÔºöquick_review=Âø´ÈÄüËøá‰∏ÄÈÅçÂç≥ÂèØ, deep_study=ÈúÄË¶ÅÊ∑±ÂÖ•ÁêÜËß£, reinforce=ÈúÄË¶ÅÂèçÂ§çÂº∫Âåñ

Âè™ËøîÂõûJSONÔºå‰∏çË¶ÅÂÖ∂‰ªñÊñáÂ≠ó„ÄÇ`;
                },

                _extractJson(text) {
                    if (typeof text !== 'string') return text;
                    const arrMatch = text.match(/\[[\s\S]*\]/);
                    const objMatch = text.match(/\{[\s\S]*\}/);
                    if (arrMatch && objMatch) {
                        return arrMatch.index < objMatch.index ? arrMatch[0] : objMatch[0];
                    }
                    return arrMatch ? arrMatch[0] : (objMatch ? objMatch[0] : text);
                },

                async analyzeMistakes(pool) {
                    let analysisPool = pool;
                    if (pool.length > 50) {
                        analysisPool = [...pool].sort((a, b) => App.data.getMistakeCount(b.id) - App.data.getMistakeCount(a.id)).slice(0, 50);
                    }

                    const profiles = this.buildMistakeProfile(analysisPool);

                    const raw = await this.call(
                        [{ role: 'user', content: this.buildAnalysisPrompt(profiles) }],
                        2048, 0.3
                    );

                    const cleaned = this._extractJson(raw);
                    const parsed = JSON.parse(cleaned);
                    const usage = this.getLastUsageRecord && this.getLastUsageRecord();
                    if (usage) {
                        const total = (usage.promptTokens || 0) + (usage.completionTokens || 0);
                        console.info(`[AI Mistake Analysis] tokens: prompt=${usage.promptTokens || 0}, completion=${usage.completionTokens || 0}, total=${total}`);
                    }
                    return parsed;
                },

                // Âü∫‰∫éÂéüÂßãÊñáÊú¨ÊûÑÈÄ†È¢òÂ∫ìÂØºÂÖ•ÊèêÁ§∫ËØç
                buildImportPrompt(rawText) {
                    const example = `{
  "Á§∫‰æãÁßëÁõÆ": {
    "Á¨¨1Á´† Á§∫‰æãÁ´†ËäÇ": [
      {
        "id": "ex-001",
        "type": "mcq",
        "q": "Á§∫‰æãÂçïÈÄâÈ¢òÔºö‰∏ãÈù¢Âì™‰∏ÄÈ°πÊòØ‚Ä¶‚Ä¶Ôºü",
        "o": ["ÈÄâÈ°πA", "ÈÄâÈ°πB", "ÈÄâÈ°πC", "ÈÄâÈ°πD"],
        "a": "B"
      },
      {
        "id": "ex-002",
        "type": "tf",
        "q": "Á§∫‰æãÂà§Êñ≠È¢òÔºö‰∏ãÂàóËØ¥Ê≥ïÊòØÂê¶Ê≠£Á°ÆÔºü",
        "a": "T"
      },
      {
        "id": "ex-003",
        "type": "multi",
        "q": "Á§∫‰æãÂ§öÈÄâÈ¢òÔºö‰∏ãÈù¢Âì™‰∫õÈÄâÈ°πÊòØÊ≠£Á°ÆÁöÑÔºü",
        "o": ["ÈÄâÈ°πA", "ÈÄâÈ°πB", "ÈÄâÈ°πC"],
        "a": "AC"
      }
    ]
  }
}`;

                    return `‰Ω†ÊòØ‰∏ÄÂêç‰∏ì‰∏öÁöÑËØïÈ¢òÁªìÊûÑÂåñÂä©ÊâãÔºå‰ªªÂä°ÊòØ‰ªéÂéüÂßãÊñáÊ°£ÊñáÊú¨‰∏≠Ëá™Âä®ËØÜÂà´Âá∫ÂÆ¢ËßÇÈ¢òÂπ∂Êï¥ÁêÜÊàêÁªü‰∏ÄÁöÑ JSON È¢òÂ∫ìÊ†ºÂºè„ÄÇ

„ÄêÈ¢òÂûãËåÉÂõ¥ÔºàÈùûÂ∏∏ÈáçË¶ÅÔºâ„Äë
Âè™ÊäΩÂèñ‰ª•‰∏ã‰∏âÁßçÈ¢òÂûãÔºåÂÖ∂‰ªñÁ±ªÂûãÔºàÂ¶ÇÂ°´Á©∫È¢ò„ÄÅÁÆÄÁ≠îÈ¢ò„ÄÅ‰∏ªËßÇÈ¢ò„ÄÅËÆ°ÁÆóÈ¢ò„ÄÅËØÅÊòéÈ¢òÁ≠âÔºâ‰∏ÄÂæãÂøΩÁï•„ÄÅ‰∏çË¶ÅÂá∫Áé∞Âú® JSON ‰∏≠Ôºö
1. ÂçïÈÄâÈ¢òÔºàmcqÔºâÔºöÂè™Êúâ‰∏Ä‰∏™Ê≠£Á°ÆÈÄâÈ°π
2. Â§öÈÄâÈ¢òÔºàmultiÔºâÔºöÊúâÂ§ö‰∏™Ê≠£Á°ÆÈÄâÈ°π
3. Âà§Êñ≠È¢òÔºàtfÔºâÔºöÂØπ/Èîô„ÄÅÊòØ/Âê¶„ÄÅÊ≠£Á°Æ/ÈîôËØØ

„ÄêJSON ÁõÆÊ†áÁªìÊûÑ„Äë
Ê†πÂØπË±°ÊòØ‰∏Ä‰∏™Â≠óÂÖ∏ÔºöÈîÆ‰∏∫ÁßëÁõÆÂêçÁß∞ÔºàÂ≠óÁ¨¶‰∏≤ÔºâÔºåÂÄº‰∏∫„ÄåÁ´†ËäÇÂ≠óÂÖ∏„Äç„ÄÇ
Á´†ËäÇÂ≠óÂÖ∏ÁöÑÈîÆ‰∏∫Á´†ËäÇÂêçÁß∞ÔºàÂ≠óÁ¨¶‰∏≤ÔºâÔºåÂÄº‰∏∫È¢òÁõÆÊï∞ÁªÑ„ÄÇ
ÊØè‰∏™È¢òÁõÆÂØπË±°ÂøÖÈ°ªÊª°Ë∂≥‰∏ãÈù¢Ê®°ÂºèÔºà‰∏çË¶ÅÂ¢ûÂä†Â§ö‰ΩôÂ≠óÊÆµÔºâÔºö
- id: Â≠óÁ¨¶‰∏≤ÔºåÈ¢òÁõÆÊ†áËØÜÔºå‰øùËØÅÂú®ÂÖ®Â±ÄËåÉÂõ¥ÂÜÖÂîØ‰∏ÄÔºàÂèØ‰ª•Áî®„ÄåÁßëÁõÆÁÆÄÂÜô + Â∫èÂè∑„ÄçÁ≠âÊñπÂºèÁîüÊàêÔºâ
- type: "mcq" | "multi" | "tf"
- q: È¢òÂπ≤ÊñáÊú¨Ôºà‰∏çÂê´ÈÄâÈ°πÂ≠óÊØçÔºâ
- o: ‰ªÖÂØπ mcq Âíå multi ÂøÖÈ°ªÔºå‰∏∫ÈÄâÈ°πÊï∞ÁªÑÔºå‰æãÂ¶Ç ["ÈÄâÈ°πA","ÈÄâÈ°πB","ÈÄâÈ°πC","ÈÄâÈ°πD"]
- a:
  - ÂØπ mcqÔºöÊ≠£Á°ÆÈÄâÈ°πÁöÑÂ≠óÊØçÔºå‰æãÂ¶Ç "A"
  - ÂØπ multiÔºöÊâÄÊúâÊ≠£Á°ÆÈÄâÈ°πÁöÑÂ≠óÊØçÊåâÂ≠óÊØçÈ°∫Â∫èÊãºÊé•Ôºå‰æãÂ¶Ç "AC"„ÄÅ"BD"
  - ÂØπ tfÔºöÊ≠£Á°Æ‰∏∫ "T"ÔºåÈîôËØØ‰∏∫ "F"

„ÄêJSON Á§∫‰æã„Äë
${example}

„ÄêËß£ÊûêËßÑÂàôÂª∫ËÆÆ„Äë
- Â∞ùËØïËØÜÂà´ÂéüÊñá‰∏≠ÁöÑÁßëÁõÆÂêçÁß∞ÂíåÁ´†ËäÇÊ†áÈ¢òÔºàÂ¶Ç„Äå‰∏Ä„ÄÅÂæÆËßÇÁªèÊµéÂ≠¶„Äç„ÄåÁ¨¨1Á´† ÈúÄÊ±Ç‰∏é‰æõÁªô„ÄçÔºâÔºåÊçÆÊ≠§ËøõË°åÂàÜÁªÑÔºõÂ¶ÇÊûúÊó†Ê≥ïÂèØÈù†ËØÜÂà´ÔºåÂèØ‰ª•Â∞ÜÊâÄÊúâÈ¢òÁõÆÊîæÂÖ•Âêå‰∏Ä‰∏™ÁßëÁõÆÂíåÁ´†ËäÇ‰∏ãÔºå‰æãÂ¶ÇÁßëÁõÆÂêç‰∏∫„ÄåÈªòËÆ§ÁßëÁõÆ„Äç„ÄÅÁ´†ËäÇÂêç‰∏∫„ÄåÈªòËÆ§Á´†ËäÇ„Äç„ÄÇ
- ÂçïÈÄâ / Â§öÈÄâÈÄâÈ°πÂâçÈÄöÂ∏∏Â∏¶Êúâ„ÄåA.„Äç„ÄåB.„Äç„ÄåC.„ÄçÊàñ„ÄåA„ÄÅ„Äç„ÄåB„ÄÅ„ÄçÁ≠âÂâçÁºÄÔºåËØ∑ÂéªÊéâËøô‰∫õÂâçÁºÄÔºå‰ªÖ‰øùÁïôÈÄâÈ°πÂÜÖÂÆπ„ÄÇ
- Â§öÈÄâÈ¢òÁöÑÁ≠îÊ°àÂèØËÉΩ‰ª•„ÄåABCD„Äç„ÄåAC„Äç„ÄåB„ÄÅC„ÄçÁ≠âÂΩ¢ÂºèÂá∫Áé∞ÔºåËØ∑Ëá™Âä®ËßÑËåÉ‰∏∫ÊåâÂ≠óÊØçÈ°∫Â∫èÊéíÂàó‰∏î‰∏çÂ∏¶ÂàÜÈöîÁ¨¶ÁöÑÂΩ¢ÂºèÔºå‰æãÂ¶Ç "AC"„ÄÇ
- Âà§Êñ≠È¢òÁöÑÁ≠îÊ°àÂ¶ÇÊûúÊòØ„ÄåÊ≠£Á°Æ/ÈîôËØØ„Äç„ÄåÂØπ/Èîô„Äç„ÄåT/F„ÄçÔºåËØ∑Áªü‰∏ÄËΩ¨Êç¢‰∏∫ "T" Êàñ "F"„ÄÇ
- ‰∏•Ê†º‰øùËØÅËæìÂá∫ÊòØÂêàÊ≥ïÁöÑ JSONÔºåÈîÆÂêçÁî®ÂèåÂºïÂè∑ÂåÖË£πÔºå‰∏çË¶ÅÂú® JSON Â§ñÂ§öËæìÂá∫‰ªª‰ΩïËØ¥ÊòéÊÄßÊñáÂ≠ó„ÄÇ

„ÄêÂæÖËß£ÊûêÂéüÂßãÂÜÖÂÆπ„Äë
${rawText}

ËØ∑Áõ¥Êé•ËæìÂá∫ÊúÄÁªà JSON ÂØπË±°Ôºå‰∏çË¶ÅÊ∑ªÂä†Ëß£ÈáäÊàñÊ≥®Èáä„ÄÇ`;
                },

                // Âè™‰øùÁïôÂçïÈÄâ / Â§öÈÄâ / Âà§Êñ≠È¢òÔºåËøáÊª§ÊéâÂÖ∂‰ªñÁ±ªÂûã
                sanitizeImportedBank(obj) {
                    const allowed = new Set(['mcq', 'multi', 'tf']);
                    const result = {};
                    if (!obj || typeof obj !== 'object' || Array.isArray(obj)) return result;

                    for (const [sub, chapDict] of Object.entries(obj)) {
                        if (!chapDict || typeof chapDict !== 'object' || Array.isArray(chapDict)) continue;
                        const cleanedChaps = {};
                        for (const [chap, arr] of Object.entries(chapDict)) {
                            if (!Array.isArray(arr)) continue;
                            const cleanedQs = arr
                                .filter(q => q && allowed.has(q.type))
                                .map(q => {
                                    const copy = { ...q };
                                    if ((copy.type === 'mcq' || copy.type === 'multi') && Array.isArray(copy.o)) {
                                        copy.o = copy.o.map(opt => {
                                            if (typeof opt !== 'string') return opt;
                                            return opt.replace(/^\s*[A-ZÔº°-Ôº∫][\.\Ôºé„ÄÅÔºå\)\Ôºâ]\s*/, '');
                                        });
                                    }
                                    return copy;
                                });
                            if (cleanedQs.length > 0) cleanedChaps[chap] = cleanedQs;
                        }
                        if (Object.keys(cleanedChaps).length > 0) result[sub] = cleanedChaps;
                    }
                    return result;
                },

                // ‰ªé modal ÊñáÊú¨Ê°Ü‰∏≠ËØªÂèñÂéüÂßãÂÜÖÂÆπÔºåË∞ÉÁî®Â§ßÊ®°ÂûãÁîüÊàêÈ¢òÂ∫ì JSONÔºà‰ªÖÂÜôÂÖ•È¢ÑËßàÂå∫Ôºå‰∏çÁõ¥Êé•ÂØºÂÖ•Ôºâ
                async importFromRawText() {
                    if (this._isLoading) return;

                    if (!this._apiKey) {
                        alert("ËØ∑ÂÖàÂú®„ÄêËÆæÁΩÆ„Äë‰∏≠ÈÄâÊã©Ê®°ÂûãÂπ∂ÈÖçÁΩÆÂØπÂ∫îÁöÑ API Key„ÄÇ");
                        return;
                    }

                    const textarea = App.dom.get('ai-import-raw');
                    const previewEl = App.dom.get('ai-import-preview');
                    const statusEl = App.dom.get('ai-import-status');
                    const raw = textarea ? textarea.value.trim() : '';
                    if (!raw) {
                        alert("ËØ∑ÂÖà‰∏ä‰º†ÊñáÊ°£ÊàñÂú®ÊñáÊú¨Ê°Ü‰∏≠Á≤òË¥¥ËØïÈ¢òÂÜÖÂÆπ„ÄÇ");
                        return;
                    }

                    const maxLen = 20000;
                    const limited = raw.length > maxLen ? raw.slice(0, maxLen) : raw;
                    const segmentSize = 4000;
                    const segments = [];
                    for (let i = 0; i < limited.length; i += segmentSize) {
                        segments.push(limited.slice(i, i + segmentSize));
                    }

                    this._isLoading = true;
                    if (previewEl) previewEl.value = '';
                    if (statusEl) statusEl.textContent = "üß† Ê≠£Âú®ÂàÜÊÆµË∞ÉÁî® AI ËØÜÂà´È¢òÁõÆÂπ∂ÁîüÊàêÈ¢òÂ∫ì JSONÔºåËØ∑Á®çÂÄô‚Ä¶";

                    try {
                        const merged = {};
                        let totalPrompt = 0;
                        let totalCompletion = 0;
                        for (let i = 0; i < segments.length; i++) {
                            const seg = segments[i];
                            const prompt = this.buildImportPrompt(seg);
                            if (statusEl) statusEl.textContent = `üß† Ê≠£Âú®Â§ÑÁêÜÁ¨¨ ${i + 1} / ${segments.length} ÊÆµÊñáÊú¨‚Ä¶`;
                            const reply = await this.call(
                                [{ role: 'user', content: prompt }],
                                4096,
                                0.2
                            );
                            const lastUsage = this.getLastUsageRecord && this.getLastUsageRecord();
                            if (lastUsage) {
                                totalPrompt += lastUsage.promptTokens || 0;
                                totalCompletion += lastUsage.completionTokens || 0;
                            }
                            const cleaned = this._extractJson(reply);
                            const obj = JSON.parse(cleaned);
                            const sanitized = this.sanitizeImportedBank(obj);
                            for (const [sub, chapDict] of Object.entries(sanitized)) {
                                if (!merged[sub]) merged[sub] = {};
                                for (const [chap, arr] of Object.entries(chapDict)) {
                                    if (!merged[sub][chap]) merged[sub][chap] = [];
                                    merged[sub][chap] = merged[sub][chap].concat(arr);
                                }
                            }
                        }
                        if (!Object.keys(merged).length) {
                            if (statusEl) statusEl.textContent = "‚ö†Ô∏è AI Êú™ËØÜÂà´Âà∞‰ªª‰ΩïÂçïÈÄâ/Â§öÈÄâ/Âà§Êñ≠È¢òÔºåËØ∑Ê£ÄÊü•ÂéüÊñáÊ†ºÂºèÂêéÈáçËØï„ÄÇ";
                            alert("AI Êú™ËØÜÂà´Âà∞‰ªª‰ΩïÁ¨¶ÂêàË¶ÅÊ±ÇÁöÑÂÆ¢ËßÇÈ¢òÔºàmcq/multi/tfÔºâ„ÄÇ");
                            return;
                        }
                        const pretty = JSON.stringify(merged, null, 2);
                        if (previewEl) previewEl.value = pretty;
                        if (statusEl) {
                            const tokenTip = totalPrompt + totalCompletion > 0
                                ? ` Êú¨Ê¨° Token Áî®ÈáèÔºöÊèêÁ§∫ ${totalPrompt}ÔºåÂõûÁ≠î ${totalCompletion}ÔºåÂêàËÆ° ${totalPrompt + totalCompletion}„ÄÇ`
                                : '';
                            statusEl.textContent = "‚úÖ Â∑≤ÁîüÊàê JSON È¢ÑËßàÔºà‰ªÖÂåÖÂê´ÂçïÈÄâ/Â§öÈÄâ/Âà§Êñ≠È¢òÔºâÔºåËØ∑Á°ÆËÆ§Êó†ËØØÂêéÂÜçÁÇπÂáª„ÄåÂØºÂÖ•È¢ÑËßà JSON Âà∞È¢òÂ∫ì„Äç„ÄÇ" + tokenTip;
                        }
                    } catch (e) {
                        console.error("AI import error", e);
                        if (statusEl) statusEl.textContent = "‚ùå AI ËØÜÂà´ÊàñÈ¢ÑËßàÁîüÊàêÂ§±Ë¥•Ôºö" + (e.message || e.toString());
                        alert("AI ËØÜÂà´ÊàñÈ¢ÑËßàÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Áä∂ÊÄÅÊ†è‰∏≠ÁöÑÈîôËØØ‰ø°ÊÅØ„ÄÇ");
                    } finally {
                        this._isLoading = false;
                    }
                },

                // ‰ªéÂè™ËØªÈ¢ÑËßàÂå∫ËØªÂèñ JSON Âπ∂ÂØºÂÖ•È¢òÂ∫ì
                importFromPreview() {
                    const previewEl = App.dom.get('ai-import-preview');
                    const statusEl = App.dom.get('ai-import-status');
                    const reportEl = App.dom.get('ai-import-report');
                    const text = previewEl ? previewEl.value.trim() : '';
                    if (!text) {
                        alert("È¢ÑËßàÂå∫‰∏∫Á©∫ÔºåËØ∑ÂÖàÁîüÊàê JSON È¢ÑËßà„ÄÇ");
                        return;
                    }
                    try {
                        const obj = JSON.parse(text);
                        const sanitized = this.sanitizeImportedBank(obj);
                        if (!Object.keys(sanitized).length) {
                            if (statusEl) statusEl.textContent = "‚ö†Ô∏è È¢ÑËßà JSON ‰∏≠Ê≤°ÊúâÂçïÈÄâ/Â§öÈÄâ/Âà§Êñ≠È¢òÔºåÊú™ÂØºÂÖ•‰ªª‰ΩïÈ¢òÁõÆ„ÄÇ";
                            alert("È¢ÑËßà JSON ‰∏≠Ê≤°ÊúâÂåÖÂê´ type ‰∏∫ mcq/multi/tf ÁöÑÈ¢òÁõÆ„ÄÇ");
                            return;
                        }
                        // ÁªüËÆ°Êú¨Ê¨°Âç≥Â∞ÜÂØºÂÖ•ÁöÑÈ¢òÁõÆÊï∞ÈáèÔºåÂπ∂ËøõË°å‰∫åÊ¨°Á°ÆËÆ§
                        let questionCount = 0;
                        for (const sub in sanitized) {
                            const chapDict = sanitized[sub] || {};
                            for (const chap in chapDict) {
                                const arr = chapDict[chap];
                                if (Array.isArray(arr)) questionCount += arr.length;
                            }
                        }
                        const ok = confirm(`Âç≥Â∞ÜÊ†πÊçÆÈ¢ÑËßà JSON ÂØºÂÖ•Á∫¶ ${questionCount} ÈÅìÈ¢òÔºà‰ªÖÂçïÈÄâ/Â§öÈÄâ/Âà§Êñ≠È¢òÔºâÔºåÊòØÂê¶ÁªßÁª≠Ôºü`);
                        if (!ok) {
                            if (statusEl) statusEl.textContent = "Â∑≤ÂèñÊ∂àÊú¨Ê¨°ÂØºÂÖ•ÔºåËØ∑Ê£ÄÊü•È¢ÑËßà JSON ÊòØÂê¶Á¨¶ÂêàÈ¢ÑÊúü„ÄÇ";
                            return;
                        }

                        const report = App.data.importBank(JSON.stringify(sanitized));
                        if (!report) {
                            if (statusEl) statusEl.textContent = "‚ùå ÂØºÂÖ•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü• JSON Ê†ºÂºèÊàñÊéßÂà∂Âè∞ÈîôËØØ‰ø°ÊÅØ„ÄÇ";
                            return;
                        }
                        if (statusEl) statusEl.textContent = "‚úÖ Â∑≤Ê†πÊçÆÈ¢ÑËßà JSON ÊàêÂäüÂØºÂÖ•È¢òÂ∫ìÔºà‰ªÖÂåÖÂê´ÂçïÈÄâ/Â§öÈÄâ/Âà§Êñ≠È¢òÔºâ„ÄÇ";

                        // Â±ïÁ§∫ÂØºÂÖ•Êä•ÂëäÂèäÁñë‰ººÁõ∏‰ººÈ¢òÊèêÈÜí
                        if (reportEl) {
                            const r = App.data._lastImportReport;
                            if (r) {
                                let html = `<div class="font-bold mb-1">ÂØºÂÖ•ÁªìÊûúÊëòË¶ÅÔºö</div>
                                    <ul class="list-disc ml-4 space-y-0.5">
                                        <li>Êñ∞Â¢ûÈ¢òÁõÆÔºö${r.added}</li>
                                        <li>Ë¶ÜÁõñÊõ¥Êñ∞Ôºö${r.updated}</li>
                                        <li>ÂÆåÂÖ®ÈáçÂ§çË∑≥ËøáÔºö${r.skippedSame}</li>
                                        <li>Áñë‰ººÁõ∏‰ººÈ¢òÁªÑÔºö${r.similarPairs.length}</li>
                                    </ul>`;
                                if (r.similarPairs.length) {
                                    html += `<div class="mt-2 font-bold">Áñë‰ººÁõ∏‰ººÈ¢òÈ¢ÑË≠¶Ôºà‰ªÖÂ±ïÁ§∫Ââç 5 ÁªÑÔºâÔºö</div>`;
                                    r.similarPairs.slice(0, 5).forEach((pair, idx) => {
                                        const subEsc = App.utils.escapeHTML(pair.sub || '');
                                        const chapEsc = App.utils.escapeHTML(pair.chap || '');
                                        const existQ = App.utils.escapeHTML(pair.existing?.q || '');
                                        const incomingQ = App.utils.escapeHTML(pair.incoming?.q || '');
                                        html += `<div class="mt-1.5 p-1.5 rounded border border-[var(--border)] bg-[var(--card)]">
                                            <div class="text-[10px] text-[var(--sub)] mb-1">#${idx + 1} [${subEsc} / ${chapEsc}] Áõ∏‰ººÂ∫¶Ôºö${(pair.score * 100).toFixed(0)}%</div>
                                            <div class="text-[11px] text-emerald-700 mb-0.5">Áé∞ÊúâÔºö${existQ}</div>
                                            <div class="text-[11px] text-sky-700">Êñ∞È¢òÔºö${incomingQ}</div>
                                        </div>`;
                                    });
                                    html += `<div class="mt-1 text-[10px] text-[var(--sub)]">ÂèØ‰ª•ÁÇπÂáª‰∏ãÊñπÊåâÈíÆËøõÂÖ•„ÄåÁñë‰ººÁõ∏‰ººÈ¢òÂÆ°Êü•„ÄçÁïåÈù¢ÔºåÈÄêÈ¢òÂÜ≥ÂÆöÊòØÂê¶‰øùÁïô„ÄÇ</div>
                                             <button onclick="App.ui.openSimilarReview()" class="mt-2 px-2 py-1 rounded border border-amber-200 bg-amber-50 text-amber-700 text-[10px] hover:bg-amber-100 active:scale-95">
                                                ÊâìÂºÄÁñë‰ººÁõ∏‰ººÈ¢òÂÆ°Êü•
                                             </button>`;
                                }
                                reportEl.innerHTML = html;
                                reportEl.classList.remove('hidden');
                            }
                        }
                    } catch (e) {
                        console.error("Import from preview error", e);
                        if (statusEl) statusEl.textContent = "‚ùå È¢ÑËßà JSON Ëß£ÊûêÂ§±Ë¥•Ôºö" + (e.message || e.toString());
                        alert("È¢ÑËßà JSON ‰∏çÊòØÂêàÊ≥ïÁöÑ JSON Ê†ºÂºèÔºåËØ∑Ê£ÄÊü•ÂêéÈáçËØï„ÄÇ");
                    }
                },

                async send() {
                    if (this._isLoading || !this._currentQ) return;
                    if (!this._apiKey) {
                        alert("ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÄâÊã©Ê®°ÂûãÂπ∂ÈÖçÁΩÆÂØπÂ∫îÁöÑ API Key„ÄÇ(Please select a model and configure API Key in Settings first.)");
                        return;
                    }

                    const input = App.dom.get('ai-chat-input');
                    const userText = input ? input.value.trim() : '';
                    if (!userText) return;

                    input.value = '';
                    input.style.height = 'auto';

                    this.appendMessage('user', userText);
                    this._messages.push({ role: 'user', content: userText });

                    const loadingId = `ai-msg-loading-${Date.now()}`;
                    this.appendMessage('assistant', '...', loadingId);

                    this._isLoading = true;
                    App.dom.get('ai-send-btn').disabled = true;

                    try {
                        const aiText = await this.call(
                            [{ role: 'system', content: this.buildSystemPrompt(this._currentQ) }, ...this._messages],
                            1024, 0.7
                        );
                        const usage = this.getLastUsageRecord && this.getLastUsageRecord();
                        let decorated = aiText;
                        if (usage && (usage.promptTokens || usage.completionTokens)) {
                            const p = usage.promptTokens || 0;
                            const c = usage.completionTokens || 0;
                            const total = p + c;
                            decorated = aiText + `\n\n‚Äî‚Äî Êú¨Ê¨° TokenÔºöÊèêÁ§∫ ${p}ÔºåÂõûÁ≠î ${c}ÔºåÂêàËÆ° ${total}`;
                        }
                        this.replaceMessage(loadingId, decorated);
                        this._messages.push({ role: 'assistant', content: aiText });

                    } catch (e) {
                        this.replaceMessage(loadingId, `‚ùå ËØ∑Ê±ÇÂ§±Ë¥•Ôºö${e.message}`);
                    } finally {
                        this._isLoading = false;
                        const btn = App.dom.get('ai-send-btn');
                        if (btn) btn.disabled = false;
                    }
                },

                handleKeydown(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.send();
                    }
                },

                autoResize(el) {
                    el.style.height = 'auto';
                    el.style.height = Math.min(el.scrollHeight, 96) + 'px';
                },

                appendMessage(role, content, id = '') {
                    const msgArea = App.dom.get('ai-chat-messages');
                    if (!msgArea) return;

                    const welcome = msgArea.querySelector('#ai-chat-welcome');
                    if (welcome) welcome.remove();

                    const div = document.createElement('div');
                    if (id) div.id = id;

                    if (role === 'user') {
                        div.className = 'flex justify-end';
                        div.innerHTML = `<div class="max-w-[85%] bg-primary-600 text-white text-xs rounded-2xl rounded-br-sm px-3 py-2 leading-relaxed whitespace-pre-wrap shadow-sm">${App.utils.escapeHTML(content)}</div>`;
                    } else {
                        div.className = 'flex justify-start';
                        div.innerHTML = `<div class="max-w-[85%] bg-[var(--card)] border border-[var(--border)] text-xs rounded-2xl rounded-bl-sm px-3 py-2 leading-relaxed text-[var(--text)] whitespace-pre-wrap shadow-sm">${content === '...' ? '<span class="animate-pulse">AI Ê≠£Âú®ÊÄùËÄÉ...</span>' : App.utils.escapeHTML(content)}</div>`;
                    }

                    msgArea.appendChild(div);
                    msgArea.scrollTop = msgArea.scrollHeight;
                },

                replaceMessage(id, content) {
                    const el = App.dom.get(id);
                    if (!el) return;
                    el.querySelector('div').innerHTML = App.utils.escapeHTML(content);
                    const msgArea = App.dom.get('ai-chat-messages');
                    if (msgArea) msgArea.scrollTop = msgArea.scrollHeight;
                },

                clearChat() {
                    if (this._currentQ) this.setContext(this._currentQ);
                }
            },

            quiz: {
                queue: [], idx: 0, stats: { c: 0, w: 0 }, currentMultiSelection: new Set(), lastConfig: null,
                _questionStartTime: null,
                _isAnalyzing: false,
                _pendingNextTimer: null,

                init(mode, config = {}) {
                    if (this._pendingNextTimer) {
                        clearTimeout(this._pendingNextTimer);
                        this._pendingNextTimer = null;
                    }
                    let pool = App.data.getQuestions();
                    if (!pool.length) {
                        alert("ÂΩìÂâçÈ¢òÂ∫ì‰∏∫Á©∫ÔºåËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÂØºÂÖ•È¢òÂ∫ìÊñá‰ª∂„ÄÇ\n(The question bank is empty. Please import a JSON file in settings.)");
                        return false;
                    }

                    this.lastConfig = { mode, options: { ...config } };

                    let typeConstraint = 'all';
                    let limit = 20;

                    if (mode === 'random') {
                        if (!config.type) typeConstraint = App.dom.getValue('smart-type', 'all');
                        else typeConstraint = config.type;

                        if (!config.limit) {
                            const l = App.dom.getValue('smart-limit', '20');
                            limit = l === 'all' ? pool.length : parseInt(l);
                        } else {
                            limit = config.limit;
                        }

                        const subChks = document.querySelectorAll('.smart-subject-chk:checked');
                        if (subChks.length > 0) {
                            const selectedSubs = Array.from(subChks).map(c => c.value);
                            pool = pool.filter(q => selectedSubs.includes(q.sub));
                        }
                    } else if (mode === 'custom') {
                        if (!config.type) typeConstraint = App.dom.getValue('setup-type', 'all');
                        else typeConstraint = config.type;
                    }

                    if (typeConstraint === 'mcq') pool = pool.filter(q => q.type === 'mcq');
                    if (typeConstraint === 'tf') pool = pool.filter(q => q.type === 'tf');
                    if (typeConstraint === 'multi') pool = pool.filter(q => q.type === 'multi');

                    if (pool.length === 0) {
                        alert("Ê≠§Á≠õÈÄâÊù°‰ª∂‰∏ãÊ≤°ÊúâÁ¨¶ÂêàÁöÑÈ¢òÁõÆ„ÄÇËØ∑Êõ¥ÊîπÊù°‰ª∂ÂêéÈáçËØï„ÄÇ\n(No questions match your filter criteria.)");
                        return false;
                    }

                    if (mode === 'mistakes') {
                        const errIds = new Set(App.data.history.filter(h => !h.r).map(h => h.id));
                        pool = pool.filter(q => errIds.has(q.id));
                        if (!pool.length) { alert("Â§™Ê£í‰∫ÜÔºÅÊÇ®ÁöÑÈ¢òÂ∫ì‰∏≠ÊöÇÊó†ÈîôÈ¢ò„ÄÇ\n(Great job! No mistakes found.)"); return false; }
                        this.queue = App.utils.shuffle(pool);
                    } else if (mode === 'random') {
                        this.queue = App.utils.shuffle(pool).slice(0, limit);
                    } else if (mode === 'custom') {
                        const chks = document.querySelectorAll('.setup-chk:checked');
                        if (chks.length > 0) {
                            const targets = Array.from(chks).map(c => c.value);
                            pool = pool.filter(q => targets.includes(`${q.sub}|${q.chap}`));
                        }
                        if (!pool.length) { alert("ÈÄâ‰∏≠ÁöÑÁ´†ËäÇ‰∏ãÊ≤°ÊúâÁ¨¶ÂêàÁöÑÈ¢òÁõÆ„ÄÇ\n(No questions in the selected chapters.)"); return false; }

                        pool = App.utils.shuffle(pool);
                        const l = App.dom.getValue('setup-limit', '20');
                        this.queue = l === 'all' ? pool : pool.slice(0, parseInt(l));
                    }

                    this.idx = 0; this.stats = { c: 0, w: 0 };
                    App.router.go('quiz');
                    this.render();
                    return true;
                },

                async initWithAI() {
                    // ‰øÆÂ§ç 3: Èò≤ÈáçÂ§çÂπ∂ÂèëÈîÅ (Mutex Lock)
                    if (this._isAnalyzing) return;

                    const aiModeOn = document.getElementById('ai-mode-toggle')?.checked;

                    if (!aiModeOn) {
                        this.init('mistakes');
                        return;
                    }

                    if (!App.ai._apiKey) {
                        alert("AI Ê®°ÂºèÈúÄË¶ÅÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÄâÊã©Ê®°ÂûãÂπ∂ÈÖçÁΩÆÂØπÂ∫îÁöÑ API Key„ÄÇ(AI mode requires API Provider configuration first.)");
                        return;
                    }

                    let pool = App.data.getQuestions();
                    const errIds = new Set(App.data.history.filter(h => !h.r).map(h => h.id));
                    pool = pool.filter(q => errIds.has(q.id));

                    if (!pool.length) {
                        alert("Â§™Ê£í‰∫ÜÔºÅÊöÇÊó†ÈîôÈ¢ò„ÄÇ(Great job! No mistakes found.)");
                        return;
                    }

                    this._isAnalyzing = true;
                    const btn = document.querySelector('[onclick="App.quiz.initWithAI()"]');
                    const originalText = btn?.innerHTML;
                    if (btn) btn.innerHTML = 'üß† ÂàÜÊûê‰∏≠...';

                    try {
                        const analysisResult = await App.ai.analyzeMistakes(pool);

                        const priorityWeight = { high: 3, medium: 2, low: 1 };
                        const analysisMap = new Map(analysisResult.map(r => [r.id, r]));

                        pool.sort((a, b) => {
                            const wa = priorityWeight[analysisMap.get(a.id)?.priority] || 0;
                            const wb = priorityWeight[analysisMap.get(b.id)?.priority] || 0;
                            return wb - wa;
                        });

                        pool = pool.map(q => ({
                            ...q,
                            _aiAnalysis: analysisMap.get(q.id) || null
                        }));

                        this.lastConfig = { mode: 'mistakes', options: {} };
                        this.queue = pool;
                        this.idx = 0;
                        this.stats = { c: 0, w: 0 };
                        App.router.go('quiz');
                        this.render();

                    } catch (e) {
                        alert(`AI ÂàÜÊûêÂ§±Ë¥•Ôºö${e.message}\nÂ∞Ü‰ΩøÁî®ÊôÆÈÄöÊ®°ÂºèÂºÄÂßã„ÄÇ(Falling back to normal mode.)`);
                        this.init('mistakes');
                    } finally {
                        this._isAnalyzing = false;
                        if (btn) btn.innerHTML = originalText;
                    }
                },

                restart() {
                    if (this.lastConfig) this.init(this.lastConfig.mode, this.lastConfig.options);
                    else this.init('random');
                },

                render() {
                    if (this._pendingNextTimer) {
                        clearTimeout(this._pendingNextTimer);
                        this._pendingNextTimer = null;
                    }
                    const q = this.queue[this.idx];
                    if (!q) return;
                    App.dom.setText('q-type', q.type === 'mcq' ? 'ÂçïÈÄâ' : (q.type === 'multi' ? 'Â§öÈÄâ' : 'Âà§Êñ≠'));
                    App.dom.setText('q-sub', q.sub);
                    App.dom.setText('q-text', q.q);
                    App.dom.setText('quiz-progress', `${this.idx + 1} / ${this.queue.length}`);

                    this._questionStartTime = Date.now();

                    const c = App.dom.get('q-options');
                    if (c) { c.innerHTML = ''; c.style.pointerEvents = 'auto'; }
                    App.dom.hide('quiz-feedback');

                    const aiTag = App.dom.get('q-ai-tag');
                    if (aiTag) {
                        if (q._aiAnalysis) {
                            const priorityColor = { high: 'text-red-500 bg-red-50 dark:bg-red-900/20', medium: 'text-yellow-600 bg-yellow-50 dark:bg-yellow-900/20', low: 'text-green-600 bg-green-50 dark:bg-green-900/20' };
                            const strategyLabel = { quick_review: 'Âø´ÈÄüËøá', deep_study: 'Ê∑±ÂÖ•ÁêÜËß£', reinforce: 'ÂèçÂ§çÂº∫Âåñ' };
                            const p = q._aiAnalysis;
                            aiTag.className = `text-[9px] font-bold px-2 py-0.5 rounded border ${priorityColor[p.priority] || ''}`;
                            aiTag.textContent = `üß† ${strategyLabel[p.strategy] || ''} ¬∑ ${p.reason}`;
                            aiTag.classList.remove('hidden');
                        } else {
                            aiTag.classList.add('hidden');
                        }
                    }

                    this.currentMultiSelection = new Set();

                    if (q.type === 'multi') {
                        App.dom.show('multi-actions');
                        App.dom.show('multi-hint');

                        (q.o || []).forEach((opt, i) => {
                            const char = String.fromCharCode(65 + i);
                            const safeOpt = App.utils.escapeHTML(opt);
                            const b = document.createElement('div');
                            b.className = "opt-btn card p-4 cursor-pointer hover:border-primary-500 transition-all flex gap-3 items-center group mb-3 rounded-xl touch-manipulation";
                            b.dataset.val = char;
                            b.innerHTML = `<span class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 text-[var(--sub)] font-bold flex items-center justify-center transition-colors border border-transparent">${char}</span><span class="text-sm font-medium">${safeOpt}</span>`;
                            b.onclick = () => this.toggle(char, b);
                            if (c) c.appendChild(b);
                        });
                    } else {
                        App.dom.hide('multi-actions');
                        App.dom.hide('multi-hint');

                        if (q.type === 'mcq') {
                            (q.o || []).forEach((opt, i) => {
                                const char = String.fromCharCode(65 + i);
                                const safeOpt = App.utils.escapeHTML(opt);
                                const b = document.createElement('div');
                                b.className = "opt-btn card p-4 cursor-pointer hover:border-primary-500 transition-all flex gap-3 items-center group mb-3 rounded-xl touch-manipulation";
                                b.innerHTML = `<span class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 text-[var(--sub)] font-bold flex items-center justify-center group-hover:text-primary-600 group-hover:bg-primary-50 transition-colors">${char}</span><span class="text-sm font-medium">${safeOpt}</span>`;
                                b.onclick = () => this.sub(char, b);
                                if (c) c.appendChild(b);
                            });
                        } else {
                            ['T', 'F'].forEach(v => {
                                const b = document.createElement('div');
                                b.className = "opt-btn card p-4 cursor-pointer hover:border-primary-500 transition-all text-center font-bold mb-3 rounded-xl text-lg touch-manipulation";
                                b.innerText = v === 'T' ? 'Ê≠£Á°Æ (True)' : 'ÈîôËØØ (False)';
                                b.onclick = () => this.sub(v, b);
                                if (c) c.appendChild(b);
                            });
                        }
                    }
                },

                toggle(val, el) {
                    if (this.currentMultiSelection.has(val)) {
                        this.currentMultiSelection.delete(val);
                        el.classList.remove('selected');
                    } else {
                        this.currentMultiSelection.add(val);
                        el.classList.add('selected');
                    }
                },

                submitMulti() {
                    const q = this.queue[this.idx];
                    const selectedArr = Array.from(this.currentMultiSelection).sort();
                    const userAns = selectedArr.join('');

                    if (userAns.length === 0) { alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÈÄâÈ°πÔºÅ(Select at least one option)"); return; }

                    // ‰øÆÂ§ç 1: Âú®Âà§È¢òÊó∂‰πüÂÅö‰∏ÄÊ¨°ÂÆâÂÖ®ÂÖúÂ∫ïÔºåÈÅøÂÖçËÑèÊï∞ÊçÆÂºïÂèëÈîôËØØ (Normalization Check)
                    const normalizedAnswer = (q.a || '').split('').sort().join('');
                    const ok = userAns === normalizedAnswer;

                    const duration = this._questionStartTime ? Math.min(Date.now() - this._questionStartTime, 300000) : 0;
                    App.data.record(q.id, ok, duration);

                    const c = App.dom.get('q-options');
                    if (c) c.style.pointerEvents = 'none';
                    App.dom.hide('multi-actions');
                    App.dom.show('quiz-feedback');

                    if (ok) {
                        this.stats.c++;
                        App.dom.setText('fb-icon', 'üéâ');
                        App.dom.setText('fb-title', 'ÂõûÁ≠îÊ≠£Á°ÆÔºÅ');
                        App.dom.setText('fb-desc', 'Â§™Ê£í‰∫ÜÔºåÂÆåÂÖ®ÂåπÈÖç„ÄÇ');
                    } else {
                        this.stats.w++;
                        App.dom.setText('fb-icon', '‚úï');
                        App.dom.setText('fb-title', 'ÂõûÁ≠îÈîôËØØ (Incorrect)');
                        const detailedHTML = App.utils.getDetailedOptionHTML(q, q.a);
                        App.dom.setHTML('fb-desc', `Ê≠£Á°ÆÁ≠îÊ°àÊòØÔºö<span class="font-bold text-primary-600">${q.a}</span><br/>${detailedHTML}`);
                    }

                    if (c) {
                        Array.from(c.children).forEach(child => {
                            const val = child.dataset.val;
                            const isCorrect = (q.a && typeof q.a === 'string') ? q.a.includes(val) : false;
                            const isSelected = this.currentMultiSelection.has(val);

                            if (isCorrect && !isSelected) child.classList.add('missed');
                            else if (isCorrect) child.classList.add('correct');
                            if (isSelected && !isCorrect) child.classList.add('wrong');
                        });
                    }
                },

                sub(val, el) {
                    const q = this.queue[this.idx];
                    const ok = val === q.a;
                    const duration = this._questionStartTime ? Math.min(Date.now() - this._questionStartTime, 300000) : 0;
                    App.data.record(q.id, ok, duration);

                    const c = App.dom.get('q-options');
                    if (c) c.style.pointerEvents = 'none';

                    if (ok) {
                        this.stats.c++;
                        el.classList.add('correct');
                        App.dom.hide('quiz-feedback');
                        if (this._pendingNextTimer) clearTimeout(this._pendingNextTimer);
                        this._pendingNextTimer = setTimeout(() => {
                            this._pendingNextTimer = null;
                            this.next();
                        }, 400);
                    } else {
                        this.stats.w++;
                        el.classList.add('wrong');
                        App.dom.show('quiz-feedback');
                        App.dom.setText('fb-icon', '‚úï');
                        App.dom.setText('fb-title', 'ÂõûÁ≠îÈîôËØØ (Incorrect)');

                        if (q.type === 'mcq') {
                            const detailedHTML = App.utils.getDetailedOptionHTML(q, q.a);
                            App.dom.setHTML('fb-desc', `Ê≠£Á°ÆÁ≠îÊ°àÔºö<span class="font-bold text-primary-600">${q.a}</span><br/>${detailedHTML}`);
                        } else {
                            const ansText = q.a === 'T' ? 'Ê≠£Á°Æ (True)' : 'ÈîôËØØ (False)';
                            App.dom.setText('fb-desc', `Ê≠£Á°ÆÁ≠îÊ°àÔºö${ansText}`);
                        }

                        if (q.type === 'mcq' && c) {
                            Array.from(c.children).forEach((child, idx) => {
                                if (String.fromCharCode(65 + idx) === q.a) child.classList.add('correct');
                            });
                        } else if (c) {
                            Array.from(c.children).forEach((child) => {
                                if ((q.a === 'T' && child.innerText.includes('True')) || (q.a === 'F' && child.innerText.includes('False'))) {
                                    child.classList.add('correct');
                                }
                            });
                        }
                    }
                },
                next() {
                    if (this._pendingNextTimer) {
                        clearTimeout(this._pendingNextTimer);
                        this._pendingNextTimer = null;
                    }
                    if (this.idx < this.queue.length - 1) { this.idx++; this.render(); } else this.finish();
                },
                finish() {
                    if (this._pendingNextTimer) {
                        clearTimeout(this._pendingNextTimer);
                        this._pendingNextTimer = null;
                    }
                    App.router.go('result');
                    const total = this.queue.length;
                    const answered = this.stats.c + this.stats.w;
                    const unanswered = Math.max(0, total - answered);
                    const finalWrong = this.stats.w + unanswered;
                    const score = total === 0 ? 0 : Math.round((this.stats.c / total) * 100);
                    App.dom.setText('res-score', score + '%');
                    App.dom.setText('res-correct', this.stats.c);
                    App.dom.setText('res-wrong', finalWrong);
                },
                abort() {
                    if (this._pendingNextTimer) {
                        clearTimeout(this._pendingNextTimer);
                        this._pendingNextTimer = null;
                    }
                    App.router.go('dashboard');
                }
            },

            router: {
                validViews: ['dashboard', 'setup', 'library', 'quiz', 'result', 'analytics'],
                currentView: 'dashboard',

                go(id) {
                    const targetId = id === 'mistake_book' ? 'library' : id;

                    if (!this.validViews.includes(targetId)) {
                        console.error(`[Router Error] Invalid view attempt: "${id}". Falling back to dashboard.`);
                        this.go('dashboard');
                        return;
                    }

                    const targetEl = App.dom.get(`view-${targetId}`);
                    if (!targetEl) return;

                    document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));

                    let libMode = 'all';
                    if (id === 'mistake_book') libMode = 'mistakes';

                    targetEl.classList.remove('hidden');
                    this.currentView = targetId;

                    if (id === 'dashboard') App.views.dashboard.render();
                    if (id === 'setup') App.views.setup.render();
                    if (id === 'library' || id === 'mistake_book') App.views.library.render(libMode);
                    if (id === 'analytics') App.views.analytics.render();
                },
                refresh() {
                    const view = this.currentView || 'dashboard';
                    if (view === 'quiz' || view === 'result') return;
                    this.go(view);
                },
                init() { this.go('dashboard'); }
            },

            views: {
                dashboard: {
                    render() {
                        const s = App.data.getStats();
                        App.dom.setText('dash-acc', s.acc + '%');
                        App.dom.setText('dash-total', s.total);
                        App.dom.setText('dash-err', s.mistakes);
                        App.dom.setText('last-practice-time', s.timeText);

                        const ml = App.dom.get('mistake-list');
                        if (ml) {
                            ml.innerHTML = '';
                            if (s.total === 0) {
                                ml.innerHTML = `<div class="p-6 text-center text-[var(--sub)] text-xs border border-dashed border-[var(--border)] rounded-xl m-4">ËØ∑ÂÖàÂØºÂÖ•È¢òÂ∫ì (Please import a question bank first).</div>`;
                            } else if (s.topMistakes.length === 0) {
                                ml.innerHTML = `<div class="p-6 text-center text-[var(--sub)] text-xs border border-dashed border-[var(--border)] rounded-xl m-4">ÊöÇÊó†ÈîôÈ¢òÊï∞ÊçÆÔºåÂ§™Ê£í‰∫ÜÔºÅ(No mistakes recorded yet!)</div>`;
                            } else {
                                s.topMistakes.forEach((q, i) => {
                                    const d = document.createElement('div');
                                    d.className = "flex items-start justify-between p-4 border-b border-[var(--border)] active:bg-[var(--bg-hover)] cursor-pointer transition-colors gap-3";
                                    d.onclick = () => App.ui.openDrawer(q.id);
                                    const badgeClass = i === 0 ? 'rank-1' : (i === 1 ? 'rank-2' : (i === 2 ? 'rank-3' : 'bg-slate-100 text-slate-500'));

                                    const safeQuestion = App.utils.escapeHTML(q.q || '');
                                    let fullAnswer = '';
                                    if (q.type === 'mcq' || q.type === 'multi') {
                                        let inlineAns = q.a;
                                        if (q.type === 'mcq') {
                                            const idx = q.a.charCodeAt(0) - 65;
                                            if (q.o && q.o[idx]) inlineAns = `${q.a}. ${App.utils.escapeHTML(q.o[idx])}`;
                                        } else if (q.type === 'multi') {
                                            inlineAns = q.a.split('').map(c => {
                                                const idx = c.charCodeAt(0) - 65;
                                                return (q.o && q.o[idx]) ? `${c}. ${App.utils.escapeHTML(q.o[idx])}` : c;
                                            }).join(' , ');
                                        }
                                        fullAnswer = `<div class="font-bold text-emerald-600 mb-1">Á≠îÊ°àÔºö${inlineAns}</div>` + App.utils.getDetailedOptionHTML(q, q.a);
                                    } else {
                                        fullAnswer = q.a === 'T' ? '<span class="font-bold text-emerald-600">Ê≠£Á°Æ (True)</span>' : '<span class="font-bold text-red-500">ÈîôËØØ (False)</span>';
                                    }

                                    d.innerHTML = `
                                        <div class="flex items-start gap-3 flex-grow min-w-0">
                                            <span class="w-5 h-5 flex-shrink-0 rounded-full flex items-center justify-center text-[10px] font-bold mt-0.5 ${badgeClass}">${i + 1}</span>
                                            <div class="flex flex-col min-w-0">
                                                <div class="text-xs font-medium text-[var(--text)] line-clamp-2 mb-2">${safeQuestion}</div>
                                                <div class="text-[11px] bg-slate-50 dark:bg-slate-800 p-2 rounded-lg border border-[var(--border)] text-[var(--sub)] shadow-sm">
                                                    ${fullAnswer}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-xs font-bold text-red-500 flex-shrink-0 self-center bg-red-50 px-2 py-1 rounded ml-1">${q.count}Ê¨°</div>`;
                                    ml.appendChild(d);
                                });
                            }
                        }
                        const h = App.data.history;
                        if (h.length === 0) {
                            App.dom.show('chart-empty');
                        } else {
                            App.dom.hide('chart-empty');
                            const pts = [];
                            for (let i = 6; i >= 0; i--) {
                                const d = new Date(); d.setDate(d.getDate() - i);
                                const ds = d.toISOString().slice(0, 10);
                                const recs = h.filter(x => new Date(x.t).toISOString().slice(0, 10) === ds);
                                pts.push(recs.length ? Math.round((recs.filter(x => x.r).length / recs.length) * 100) : 0);
                            }
                            requestAnimationFrame(() => App.chart.draw('dashboardChart', pts));
                        }
                    }
                },
                setup: {
                    render() {
                        App.dom.setValue('setup-type', 'all');
                        App.dom.setValue('setup-limit', '20');

                        const c = App.dom.get('setup-options');
                        if (!c) return;
                        c.innerHTML = '';
                        const subs = App.data.getSubjects();
                        if (subs.length === 0) {
                            c.innerHTML = '<div class="text-center text-[var(--sub)] mt-10">Êú™Ê£ÄÊµãÂà∞È¢òÂ∫ìÔºåËØ∑ÂâçÂæÄÂè≥‰∏äËßíËÆæÁΩÆÂØºÂÖ•È¢òÂ∫ì JSON Êñá‰ª∂„ÄÇ</div>';
                            return;
                        }

                        subs.forEach(sub => {
                            const safeSub = App.utils.escapeHTML(sub);
                            const w = document.createElement('div'); w.className = "mb-4";
                            w.innerHTML = `<div class="font-bold text-primary-600 mb-2 px-1 text-sm">${safeSub}</div>`;
                            const g = document.createElement('div'); g.className = "grid grid-cols-2 gap-2";
                            App.data.getChapters(sub).forEach(chap => {
                                const safeChap = App.utils.escapeHTML(chap);
                                const l = document.createElement('label');
                                l.className = "flex items-center gap-2 p-3 border border-[var(--border)] rounded-xl cursor-pointer active:border-primary-500 transition-colors bg-[var(--card)] touch-manipulation";
                                l.innerHTML = `<input type="checkbox" class="setup-chk accent-primary-600 w-4 h-4" value="${sub}|${chap}" checked> <span class="text-xs font-medium truncate">${safeChap}</span>`;
                                g.appendChild(l);
                            });
                            w.appendChild(g); c.appendChild(w);
                        });
                    }
                },
                library: {
                    currentMode: 'all',
                    _searchQuery: '',
                    _debounceTimer: null,
                    _scrollListenerAttached: false,
                    _searchKeydownAttached: false,
                    _expandAll: false,
                    // ÁÆ°ÁêÜÊ®°Âºè‰∏éÈÄâ‰∏≠ÈõÜÂêà
                    _manageMode: false,
                    _selectedIds: new Set(),

                    handleTypeChange() { this.render(); },
                    handleFilterChange() { this.render(); },

                    handleSearch(val) {
                        clearTimeout(this._debounceTimer);
                        const clearBtn = App.dom.get('lib-search-clear');
                        if (clearBtn) clearBtn.classList.toggle('hidden', val.length === 0);

                        this._debounceTimer = setTimeout(() => {
                            this._searchQuery = val.trim().toLowerCase();
                            this.render();
                        }, 300);
                    },

                    clearSearch() {
                        const input = App.dom.get('lib-search');
                        if (input) input.value = '';
                        this.handleSearch('');
                    },

                    backToTop() {
                        const listEl = App.dom.get('lib-list');
                        if (listEl) listEl.scrollTo({ top: 0, behavior: 'smooth' });
                    },

                    toggleExpandAll() {
                        this._expandAll = !this._expandAll;
                        const listEl = App.dom.get('lib-list');
                        if (!listEl) return;
                        const panels = listEl.querySelectorAll('.details-panel');
                        panels.forEach(p => {
                            if (this._expandAll) p.classList.remove('hidden');
                            else p.classList.add('hidden');
                        });
                        const btn = App.dom.get('lib-toggle-expand');
                        if (btn) {
                            btn.classList.toggle('bg-primary-600', this._expandAll);
                            btn.classList.toggle('text-white', this._expandAll);
                        }
                    },

                    toggleDetails(el) {
                        const container = el.closest('.p-4');
                        if (!container) return;
                        const panel = container.querySelector('.details-panel');
                        if (!panel) return;
                        panel.classList.toggle('hidden');
                    },

                    // ÂàáÊç¢ÁÆ°ÁêÜÊ®°ÂºèÔºöÊòæÁ§∫/ÈöêËóèÂ§öÈÄâÊ°ÜÂíåÁÆ°ÁêÜÂ∑•ÂÖ∑Êù°
                    toggleManageMode() {
                        this._manageMode = !this._manageMode;
                        this._selectedIds = new Set();

                        const listEl = App.dom.get('lib-list');
                        if (listEl) {
                            const chks = listEl.querySelectorAll('.lib-select-chk');
                            chks.forEach(chk => {
                                chk.classList.toggle('hidden', !this._manageMode);
                                chk.checked = false;
                            });
                        }

                        const bar = App.dom.get('lib-manage-bar');
                        if (bar) bar.classList.toggle('hidden', !this._manageMode);
                        App.dom.setText('lib-selected-count', '0');

                        const btn = App.dom.get('lib-manage-toggle');
                        if (btn) {
                            btn.classList.toggle('bg-primary-600', this._manageMode);
                            btn.classList.toggle('text-white', this._manageMode);
                        }
                    },

                    // Â§öÈÄâÊ°ÜÂèòÂåñÊó∂Êõ¥Êñ∞ÈÄâ‰∏≠ÈõÜÂêà
                    handleSelectChange(el) {
                        const id = el.dataset.id;
                        if (!id) return;
                        if (el.checked) this._selectedIds.add(id);
                        else this._selectedIds.delete(id);
                        App.dom.setText('lib-selected-count', String(this._selectedIds.size));
                    },

                    // ÂçïÈ¢òÂà†Èô§ÔºöËΩØÂà†Èô§Âà∞ÂõûÊî∂Á´ô
                    deleteSingle(id) {
                        if (!confirm("Á°ÆÂÆöÂà†Èô§ËøôÈÅìÈ¢òÂêóÔºüÊ≠§Êìç‰Ωú‰ºöÂ∞ÜÈ¢òÁõÆÊîæÂÖ•ÂõûÊî∂Á´ôÔºåÂèØÂú®ÂõûÊî∂Á´ô‰∏≠ÊÅ¢Â§ç„ÄÇ")) return;
                        App.data.softDeleteByIds(new Set([id]), 'manual-delete');
                        this.render(this.currentMode);
                    },

                    // ÊâπÈáèÂà†Èô§ÈÄâ‰∏≠
                    bulkDeleteSelected() {
                        if (!this._selectedIds || this._selectedIds.size === 0) {
                            alert("ËØ∑ÂÖàÂãæÈÄâËá≥Â∞ë‰∏ÄÈ¢òÂÜçÊâßË°åÊâπÈáèÂà†Èô§„ÄÇ");
                            return;
                        }
                        if (!confirm(`Á°ÆÂÆöÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${this._selectedIds.size} ÈÅìÈ¢òÁõÆÂêóÔºüËøô‰∫õÈ¢òÂ∞ÜË¢´ÁßªÂÖ•ÂõûÊî∂Á´ôÔºåÂèØÂú®ÂõûÊî∂Á´ô‰∏≠ÊÅ¢Â§ç„ÄÇ`)) return;
                        App.data.softDeleteByIds(this._selectedIds, 'manual-delete-bulk');
                        this._selectedIds = new Set();
                        App.dom.setText('lib-selected-count', '0');
                        this.render(this.currentMode);
                    },

                    // ÊâπÈáèÂØºÂá∫ÈÄâ‰∏≠‰∏∫ JSON
                    exportSelected() {
                        if (!this._selectedIds || this._selectedIds.size === 0) {
                            alert("ËØ∑ÂÖàÂãæÈÄâËá≥Â∞ë‰∏ÄÈ¢òÂÜçÂØºÂá∫„ÄÇ");
                            return;
                        }
                        if (this._selectedIds.size > 500) {
                            if (!confirm(`ÊÇ®ÈÄâ‰∏≠‰∫Ü ${this._selectedIds.size} ÈÅìÈ¢òÔºåÂØºÂá∫ÂèØËÉΩÈúÄË¶ÅËæÉÈïøÊó∂Èó¥ÔºåÁ°ÆËÆ§ÁªßÁª≠ÂêóÔºü`)) {
                                return;
                            }
                        }
                        const all = App.data.getQuestions();
                        const selected = all.filter(q => this._selectedIds.has(q.id));
                        if (!selected.length) {
                            alert("ÈÄâ‰∏≠ÁöÑÈ¢òÁõÆÂú®ÂΩìÂâçÈ¢òÂ∫ì‰∏≠Â∑≤‰∏çÂ≠òÂú®„ÄÇ");
                            return;
                        }
                        const out = {};
                        selected.forEach(q => {
                            if (!out[q.sub]) out[q.sub] = {};
                            if (!out[q.sub][q.chap]) out[q.sub][q.chap] = [];
                            const { _pinyin, _aiAnalysis, sub, chap, ...rest } = q;
                            out[q.sub][q.chap].push(rest);
                        });

                        const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `LMS_Export_${Date.now()}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    },

                    render(mode) {
                        const prevMode = this.currentMode;
                        // ÂàáÊç¢Ê®°ÂºèÊó∂ÈáçÁΩÆÊêúÁ¥¢ÂÖ≥ÈîÆÂ≠ó
                        if (mode && mode !== prevMode) {
                            this._searchQuery = '';
                            App.dom.setValue('lib-search', '');
                            const clearBtn = App.dom.get('lib-search-clear');
                            if (clearBtn) clearBtn.classList.add('hidden');
                        }
                        if (mode) this.currentMode = mode;
                        mode = this.currentMode;

                        // ‰ªª‰Ωï‰∏ÄÊ¨°ÈáçÊñ∞Ê∏≤ÊüìÔºåÈÉΩÈáçÁΩÆÁÆ°ÁêÜÊ®°Âºè‰∏ãÁöÑÈÄâ‰∏≠Áä∂ÊÄÅÔºåÈÅøÂÖçÁä∂ÊÄÅÈÅóÁïô
                        if (this._manageMode) {
                            this._selectedIds = new Set();
                            App.dom.setText('lib-selected-count', '0');
                        }

                        App.dom.setText('lib-title', mode === 'mistakes' ? 'ÈîôÈ¢òÊú¨' : 'ÊÄªÈ¢òÂ∫ì');

                        const filter = App.dom.get('lib-filter');
                        const typeFilter = App.dom.get('lib-type');
                        const sortSel = App.dom.get('lib-sort');

                        let currentSortValue = sortSel ? sortSel.value : 'default';

                        if (filter) filter.classList.toggle('hidden', mode === 'mistakes');

                        if (filter) {
                            const savedFilterValue = filter.value;
                            filter.innerHTML = '<option value="all">ÂÖ®ÁßëÁõÆ</option>';
                            const subjects = App.data.getSubjects();
                            subjects.forEach(s => filter.add(new Option(s, s)));
                            if (savedFilterValue === 'all' || subjects.includes(savedFilterValue)) {
                                filter.value = savedFilterValue;
                            } else {
                                filter.value = 'all';
                            }
                        }

                        if (sortSel) {
                            const currentType = typeFilter ? typeFilter.value : 'all';
                            let html = `
                                <option value="default">ÈªòËÆ§</option>
                                <option value="err_desc">ÈîôÁéá‚Üì</option>
                                <option value="ans_asc">Á≠îÊ°àA-Z</option>
                            `;
                            if (currentType === 'tf') {
                                html += `<option value="tf_true">Á≠îÊ°à (ÂØπ->Èîô)</option>`;
                                html += `<option value="tf_false">Á≠îÊ°à (Èîô->ÂØπ)</option>`;
                            }
                            sortSel.innerHTML = html;

                            let hasOption = false;
                            for (let i = 0; i < sortSel.options.length; i++) {
                                if (sortSel.options[i].value === currentSortValue) {
                                    hasOption = true; break;
                                }
                            }
                            if (hasOption) sortSel.value = currentSortValue;
                            else { sortSel.value = 'default'; currentSortValue = 'default'; }
                        }

                        let qs = App.data.getQuestions();

                        if (mode === 'mistakes') {
                            const hidden = new Set(Array.isArray(App.data.hiddenMistakeIds) ? App.data.hiddenMistakeIds : []);
                            const errSet = new Set(App.data.history.filter(h => !h.r && !hidden.has(h.id)).map(h => h.id));
                            qs = qs.filter(q => errSet.has(q.id));
                        } else {
                            if (filter && filter.value !== 'all') qs = qs.filter(q => q.sub === filter.value);
                            if (typeFilter && typeFilter.value !== 'all') {
                                const t = typeFilter.value;
                                qs = qs.filter(q => q.type === t);
                            }
                        }

                        if (this._searchQuery) {
                            const q_str = this._searchQuery;
                            qs = qs.filter(q => {
                                const haystack = [
                                    q.q,
                                    q.chap,
                                    q.a,
                                    ...(q.o || [])
                                ].join(' ').toLowerCase();

                                return haystack.includes(q_str)
                                    || (q._pinyin && q._pinyin.includes(q_str))
                                    || App.utils.fuzzyMatch(haystack, q_str);
                            });
                        }

                        const sType = currentSortValue;
                        let sortedQs = [...qs];

                        if (sType === 'err_desc') {
                            sortedQs.sort((a, b) => {
                                return (App.data.getMistakeCount(b.id) - App.data.getMistakeCount(a.id)) || String(a.id).localeCompare(String(b.id), undefined, { numeric: true });
                            });
                        } else if (sType === 'ans_asc') {
                            sortedQs.sort((a, b) => {
                                const aAns = (a.a || '').split('').sort().join('');
                                const bAns = (b.a || '').split('').sort().join('');
                                return aAns.localeCompare(bAns, undefined, { numeric: true }) ||
                                    String(a.id).localeCompare(String(b.id), undefined, { numeric: true });
                            });
                        } else if (sType === 'tf_true') {
                            sortedQs.sort((a, b) => {
                                if (a.a === b.a) return String(a.id).localeCompare(String(b.id), undefined, { numeric: true });
                                return a.a === 'T' ? -1 : 1;
                            });
                        } else if (sType === 'tf_false') {
                            sortedQs.sort((a, b) => {
                                if (a.a === b.a) return String(a.id).localeCompare(String(b.id), undefined, { numeric: true });
                                return a.a === 'F' ? -1 : 1;
                            });
                        }

                        qs = sortedQs;
                        App.dom.setText('lib-count', qs.length);

                        const c = App.dom.get('lib-list');
                        if (!c) return;
                        c.innerHTML = '';

                        if (qs.length === 0) {
                            if (this._searchQuery) {
                                const safeQuery = App.utils.escapeHTML(this._searchQuery);
                                c.innerHTML = `<div class="p-8 text-center text-xs text-[var(--sub)]">Êú™ÊâæÂà∞‰∏é "<span class="font-bold text-primary-600">${safeQuery}</span>" Áõ∏ÂÖ≥ÁöÑÈ¢òÁõÆ„ÄÇ(No results found)</div>`;
                            } else {
                                c.innerHTML = '<div class="p-8 text-center text-xs text-[var(--sub)]">Â∞öÊú™Âä†ËΩΩÈ¢òÁõÆ„ÄÇËØ∑ÂØºÂÖ•È¢òÂ∫ìÊàñÊõ¥ÊîπÁ≠õÈÄâÊù°‰ª∂„ÄÇ</div>';
                            }
                            return;
                        }

                        if (!this._searchKeydownAttached) {
                            const input = App.dom.get('lib-search');
                            if (input) {
                                input.addEventListener('keydown', (e) => {
                                    if (e.key === 'Enter') {
                                        e.preventDefault();
                                        input.blur();
                                    }
                                });
                                this._searchKeydownAttached = true;
                            }
                        }

                        const frag = document.createDocumentFragment();
                        qs.forEach((q, index) => {
                            const d = document.createElement('div');
                            d.className = "p-4 border-b border-[var(--border)] hover:bg-[var(--bg-hover)] transition-colors";
                            d.dataset.qid = q.id;

                            let mistakeBadge = '';
                            let delBtn = '';
                            if (mode === 'mistakes') {
                                const errCount = App.data.getMistakeCount(q.id);
                                mistakeBadge = `<span class="text-[10px] font-bold text-white bg-red-500 px-1.5 py-0.5 rounded-full ml-2">${errCount}</span>`;
                                delBtn = `<button class="ml-auto text-xs text-[var(--sub)] hover:text-red-500 p-2 border border-[var(--border)] rounded" onclick="event.stopPropagation(); App.data.clearMistakeHistory('${q.id}'); App.views.library.render()">‚úï ÁßªÈô§</button>`;
                            }

                            let ansPreview = '';
                            let detailsHtml = '';

                            if (q.type === 'tf') {
                                const isTrue = q.a === 'T';
                                ansPreview = isTrue
                                    ? '<span class="status-true">‚àö (Ê≠£Á°Æ/True)</span>'
                                    : '<span class="status-false">√ó (ÈîôËØØ/False)</span>';
                                detailsHtml = `<div class="mt-2 text-xs text-[var(--sub)] hidden details-panel">Ê≠§È¢ò‰∏∫Âà§Êñ≠È¢ò„ÄÇ</div>`;
                            } else {
                                let inlineAns = q.a;
                                if (q.type === 'mcq') {
                                    const idx = q.a.charCodeAt(0) - 65;
                                    if (q.o && q.o[idx]) inlineAns = `${q.a}. ${App.utils.highlight(q.o[idx], this._searchQuery)}`;
                                } else if (q.type === 'multi') {
                                    inlineAns = q.a.split('').map(c => {
                                        const idx = c.charCodeAt(0) - 65;
                                        return (q.o && q.o[idx]) ? `${c}. ${App.utils.highlight(q.o[idx], this._searchQuery)}` : c;
                                    }).join(' , ');
                                }

                                ansPreview = `<span class="font-bold text-primary-600">‚úÖ Á≠îÊ°àÔºö${inlineAns}</span>`;
                                detailsHtml = `<div class="mt-2 hidden details-panel bg-slate-50 dark:bg-slate-800 p-2 rounded-lg border border-[var(--border)]">` +
                                    App.utils.getDetailedOptionHTML(q, q.a, this._searchQuery) +
                                    `</div>`;
                            }

                            const typeLabel = q.type === 'mcq' ? 'ÂçïÈÄâ' : (q.type === 'multi' ? 'Â§öÈÄâ' : 'Âà§Êñ≠');
                            const highlightedQ = App.utils.highlight(q.q, this._searchQuery);

                            const safeSub = App.utils.escapeHTML(q.sub || '');
                            d.innerHTML = `
                                <div class="flex justify-between mb-1 items-center">
                                    <label class="flex items-center gap-2 cursor-pointer select-none">
                                        <input type="checkbox" class="lib-select-chk w-4 h-4 mr-1 hidden" data-id="${App.utils.escapeHTML(String(q.id || ''))}" onchange="App.views.library.handleSelectChange(this)">
                                        <span class="text-[10px] font-bold text-[var(--sub)] mr-1">#${index + 1}</span>
                                        <span class="text-[10px] font-bold text-primary-600 bg-primary-50 px-1 rounded border border-primary-100">${safeSub}</span>
                                        <span class="text-[10px] text-[var(--sub)] border border-[var(--border)] px-1 rounded">${typeLabel}</span>
                                        ${mistakeBadge}
                                    </label>
                                    <div class="flex items-center gap-1">
                                        ${delBtn}
                                        <button class="text-[10px] text-[var(--sub)] hover:text-primary-600 p-1 rounded prevent-drawer" onclick="event.stopPropagation(); App.ui.openQuestionEditor('${App.utils.escapeHTML(String(q.id || ''))}')">‚úé</button>
                                        <button class="text-[var(--sub)] hover:text-primary-600 p-1 rounded prevent-drawer" onclick="event.stopPropagation(); App.ui.openDrawer('${App.utils.escapeHTML(String(q.id || ''))}')">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-4.553a1 1 0 00-1.414-1.414L13.586 8.586A2 2 0 0112.172 9H7a2 2 0 00-2 2v6h6v-1a2 2 0 01.586-1.414l4.553-4.553z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 18h14"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="font-medium text-sm text-[var(--text)] leading-snug cursor-pointer hover:text-primary-600 transition-colors lib-toggle" onclick="App.views.library.toggleDetails(this)">${highlightedQ}</div>
                                <div class="mt-2 text-xs font-bold text-[var(--sub)] flex flex-col gap-1 cursor-pointer lib-toggle" onclick="App.views.library.toggleDetails(this)">
                                    <span>${ansPreview}</span>
                                </div>
                                ${detailsHtml}`;
                            frag.appendChild(d);
                        });
                        c.appendChild(frag);

                        if (!this._scrollListenerAttached) {
                            const listEl = App.dom.get('lib-list');
                            const btn = App.dom.get('lib-back-top');
                            if (listEl && btn) {
                                listEl.addEventListener('scroll', () => {
                                    btn.classList.toggle('opacity-0', listEl.scrollTop < 200);
                                    btn.classList.toggle('pointer-events-none', listEl.scrollTop < 200);
                                });
                                this._scrollListenerAttached = true;
                            }
                        }
                    }
                },

                analytics: {
                    currentMode: 'global',

                    setMode(mode) {
                        this.currentMode = mode === 'subject' ? 'subject' : 'global';
                        this.render();
                    },

                    hideQuestionPopover() {
                        const overlay = App.dom.get('an-q-popover-overlay');
                        const pop = App.dom.get('an-q-popover');
                        if (overlay) overlay.classList.add('hidden');
                        if (pop) {
                            pop.classList.add('hidden');
                            pop.innerHTML = '';
                        }
                    },

                    showQuestionPopover(id, avgSec, totalSec, attempts, el) {
                        const q = App.data.getQuestionById(id);
                        const overlay = App.dom.get('an-q-popover-overlay');
                        const pop = App.dom.get('an-q-popover');
                        if (!q || !pop || !overlay) return;

                        const subSelect = App.dom.get('an-subject-select');
                        const currentSub = subSelect ? subSelect.value : 'all';
                        const allHistory = App.data.history || [];
                        const scopedHistory = currentSub === 'all'
                            ? allHistory
                            : allHistory.filter(hEntry => {
                                const qq = App.data.getQuestionById(hEntry.id);
                                return qq && qq.sub === currentSub;
                            });
                        const records = scopedHistory.filter(hEntry => hEntry.id === id);
                        const attemptsReal = records.length || attempts || 0;
                        const wrong = records.filter(x => !x.r).length;
                        const correct = records.filter(x => x.r).length;
                        const errRate = attemptsReal ? Math.round(wrong / attemptsReal * 100) : 0;
                        const durRecords = records.filter(x => x.d > 0);
                        const totalMs = durRecords.reduce((sum, x) => sum + x.d, 0);
                        const avgSecReal = durRecords.length ? (totalMs / durRecords.length / 1000) : (avgSec || 0);
                        const totalSecReal = totalMs ? Math.round(totalMs / 1000) : (totalSec || 0);

                        const typeLabel = q.type === 'mcq' ? 'ÂçïÈÄâÈ¢ò' : (q.type === 'multi' ? 'Â§öÈÄâÈ¢ò' : 'Âà§Êñ≠È¢ò');
                        let bodyHtml = '';
                        if (q.type === 'tf') {
                            const isTrue = q.a === 'T';
                            const tfLabel = isTrue ? '‚àö (Ê≠£Á°Æ/True)' : '√ó (ÈîôËØØ/False)';
                            bodyHtml = `<div class="text-[11px] text-[var(--sub)] mb-1">${tfLabel}</div>`;
                        } else {
                            const detailHtml = App.utils.getDetailedOptionHTML(q, q.a, '');
                            bodyHtml = `<div class="mt-1">${detailHtml}</div>`;
                        }

                        const avgText = attemptsReal ? `${Math.round(avgSecReal * 10) / 10} Áßí/Ê¨°` : '--';
                        const totalText = totalSecReal ? `${totalSecReal} Áßí` : '--';

                        pop.innerHTML = `
                            <div id="an-q-arrow" class="absolute"></div>
                            <div class="flex items-center justify-between gap-2 mb-1 pr-3">
                                <div class="text-[10px] text-[var(--sub)] truncate max-w-[80%]">${App.utils.escapeHTML(q.sub || '')} ‚Ä¢ ${App.utils.escapeHTML(q.chap || '')} ‚Ä¢ ${typeLabel}</div>
                            </div>
                            <div class="text-[12px] font-medium text-[var(--text)] mb-1 leading-snug whitespace-pre-line">${App.utils.escapeHTML(q.q || '')}</div>
                            ${bodyHtml}
                            <div class="mt-2 pt-1 border-t border-[var(--border)] text-[10px] text-[var(--sub)] grid grid-cols-2 gap-y-0.5 gap-x-2">
                                <div>‰ΩúÁ≠îÊ¨°Êï∞Ôºö<span class="font-bold text-[var(--text)]">${attemptsReal}</span></div>
                                <div>Ê≠£Á°ÆÊ¨°Êï∞Ôºö<span class="font-bold text-[var(--text)]">${correct}</span></div>
                                <div>ÈîôËØØÊ¨°Êï∞Ôºö<span class="font-bold text-[var(--text)]">${wrong}</span></div>
                                <div>ÈîôËØØÁéáÔºö<span class="font-bold text-[var(--text)]">${errRate}%</span></div>
                                <div>Âπ≥ÂùáÁî®Êó∂Ôºö<span class="font-bold text-[var(--text)]">${avgText}</span></div>
                                <div>ÊÄªÁî®Êó∂Ôºö<span class="font-bold text-[var(--text)]">${totalText}</span></div>
                            </div>
                        `;

                        overlay.classList.remove('hidden');
                        pop.classList.remove('hidden');

                        const anchorRect = el.getBoundingClientRect();
                        pop.style.left = '0px';
                        pop.style.top = '0px';
                        const popRect = pop.getBoundingClientRect();
                        const padding = 8;
                        const viewportWidth = window.innerWidth;
                        const viewportHeight = window.innerHeight;
                        const width = popRect.width;
                        const height = popRect.height;

                        let top = window.scrollY + anchorRect.bottom + 10;
                        let arrowPos = 'top';
                        if (top + height + padding > window.scrollY + viewportHeight) {
                            top = window.scrollY + anchorRect.top - height - 10;
                            if (top < window.scrollY + padding) {
                                top = window.scrollY + Math.max(padding, anchorRect.top + (anchorRect.height / 2) - height / 2);
                            }
                            arrowPos = 'bottom';
                        }

                        let left = anchorRect.left + anchorRect.width / 2 - width / 2;
                        left = Math.max(padding, Math.min(left, viewportWidth - width - padding));

                        pop.style.left = left + 'px';
                        pop.style.top = top + 'px';

                        const arrowContainer = document.getElementById('an-q-arrow');
                        if (arrowContainer) {
                            if (arrowPos === 'top') {
                                arrowContainer.innerHTML = '<div class="w-3 h-3 bg-[var(--card)] border-l border-t border-[var(--border)] rotate-45 absolute -top-1 left-1/2 -translate-x-1/2"></div>';
                            } else {
                                arrowContainer.innerHTML = '<div class="w-3 h-3 bg-[var(--card)] border-r border-b border-[var(--border)] rotate-45 absolute -bottom-1 left-1/2 -translate-x-1/2"></div>';
                            }
                        }
                    },

                    render() {
                        const s = App.data.getStats();

                        const tabGlobal = App.dom.get('an-tab-global');
                        const tabSubject = App.dom.get('an-tab-subject');
                        if (tabGlobal && tabSubject) {
                            const isSubject = this.currentMode === 'subject';
                            tabGlobal.classList.toggle('bg-[var(--card)]', !isSubject);
                            tabGlobal.classList.toggle('text-[var(--text)]', !isSubject);
                            tabGlobal.classList.toggle('bg-transparent', isSubject);
                            tabGlobal.classList.toggle('text-[var(--sub)]', isSubject);
                            tabSubject.classList.toggle('bg-[var(--card)]', isSubject);
                            tabSubject.classList.toggle('text-[var(--text)]', isSubject);
                            tabSubject.classList.toggle('bg-transparent', !isSubject);
                            tabSubject.classList.toggle('text-[var(--sub)]', !isSubject);
                        }

                        const globalBlocks = document.querySelectorAll('.an-global-block');
                        const subjectBlocks = document.querySelectorAll('.an-subject-block');
                        globalBlocks.forEach(el => el.classList.toggle('hidden', this.currentMode !== 'global'));
                        subjectBlocks.forEach(el => el.classList.toggle('hidden', this.currentMode !== 'subject'));

                        App.dom.setText('an-total-attempts', s.totalAttempts);
                        App.dom.setText('an-acc', s.acc + '%');
                        App.dom.setText('an-streak', s.streak + 'Â§©');
                        App.dom.setText('an-avg-dur', s.avgDuration != null ? s.avgDuration + 'Áßí' : '--');

                        const subSelect = App.dom.get('an-subject-select');
                        const subs = Object.keys(s.subjectStats || {});
                        let currentSub = 'all';
                        if (subSelect) {
                            const prev = subSelect.value || 'all';
                            subSelect.innerHTML = '<option value="all">ÂÖ®ÈÉ®ÁßëÁõÆ</option>' + subs.map(sub => {
                                const esc = App.utils.escapeHTML(sub);
                                return `<option value="${esc}">${esc}</option>`;
                            }).join('');
                            currentSub = subs.includes(prev) || prev === 'all' ? prev : 'all';
                            subSelect.value = currentSub;
                            subSelect.onchange = () => this.setMode('subject');
                        }

                        const filteredHistory = (currentSub === 'all')
                            ? App.data.history
                            : App.data.history.filter(hEntry => {
                                const q = App.data.getQuestionById(hEntry.id);
                                return q && q.sub === currentSub;
                            });

                        const labelEl = App.dom.get('an-subject-current-label');
                        if (labelEl) {
                            labelEl.textContent = currentSub === 'all' ? 'ÂΩìÂâçËßÜÂõæÔºöÂÖ®ÈÉ®ÁßëÁõÆ' : `ÂΩìÂâçËßÜÂõæÔºö${currentSub}`;
                        }

                        if (this.currentMode === 'subject') {
                            const totalAttemptsSub = filteredHistory.length;
                            const totalCorrectSub = filteredHistory.filter(x => x.r).length;
                            const durRecordsSub = filteredHistory.filter(x => x.d > 0);
                            const totalDurMs = durRecordsSub.reduce((sum, x) => sum + x.d, 0);
                            const avgDurSub = durRecordsSub.length ? Math.round(totalDurMs / durRecordsSub.length / 1000) : null;

                            const qTimeMap = new Map();
                            filteredHistory.forEach(hEntry => {
                                const q = App.data.getQuestionById(hEntry.id);
                                if (!q) return;
                                let rec = qTimeMap.get(hEntry.id);
                                if (!rec) {
                                    rec = { q, attempts: 0, totalMs: 0 };
                                    qTimeMap.set(hEntry.id, rec);
                                }
                                rec.attempts++;
                                if (hEntry.d > 0) rec.totalMs += hEntry.d;
                            });
                            const qTimeList = Array.from(qTimeMap.values()).map(rec => {
                                const avgMs = rec.attempts ? rec.totalMs / rec.attempts : 0;
                                return { q: rec.q, attempts: rec.attempts, totalMs: rec.totalMs, avgMs };
                            }).filter(x => x.totalMs > 0).sort((a, b) => b.avgMs - a.avgMs).slice(0, 10);

                            const now = Date.now();
                            const buckets = [
                                { label: '‰ªäÂ§©', min: 0, max: 0, attempts: 0, correct: 0 },
                                { label: '1-3Â§©', min: 1, max: 3, attempts: 0, correct: 0 },
                                { label: '4-7Â§©', min: 4, max: 7, attempts: 0, correct: 0 },
                                { label: '8-14Â§©', min: 8, max: 14, attempts: 0, correct: 0 },
                                { label: '>14Â§©', min: 15, max: Infinity, attempts: 0, correct: 0 }
                            ];
                            filteredHistory.forEach(hEntry => {
                                const days = Math.floor((now - hEntry.t) / 86400000);
                                for (let i = 0; i < buckets.length; i++) {
                                    const b = buckets[i];
                                    if (days >= b.min && days <= b.max) {
                                        b.attempts++;
                                        if (hEntry.r) b.correct++;
                                        break;
                                    }
                                }
                            });

                            const distinctQCount = qTimeMap.size;
                            const subDetail = App.dom.get('an-subject-detail');
                            if (subDetail) {
                                if (!filteredHistory.length) {
                                    subDetail.innerHTML = `<div class="col-span-2 md:col-span-4 text-[11px] text-[var(--sub)]">ÂΩìÂâçÁßëÁõÆÊöÇÊó†ÁªÉ‰π†Êï∞ÊçÆ„ÄÇ</div>`;
                                } else {
                                    const totalSec = Math.round(totalDurMs / 1000);
                                    const totalMin = Math.floor(totalSec / 60);
                                    const totalSecRem = totalSec % 60;
                                    const totalTimeText = totalSec ? (totalMin ? `${totalMin}ÂàÜ${totalSecRem}Áßí` : `${totalSecRem}Áßí`) : '--';
                                    const accSub = totalAttemptsSub ? Math.round(totalCorrectSub / totalAttemptsSub * 100) : 0;
                                    const avgTimeText = avgDurSub != null ? `${avgDurSub}Áßí/È¢ò` : '--';
                                    subDetail.innerHTML = `
                                        <div>
                                            <div class="text-[10px] text-[var(--sub)]">ÂΩìÂâçÁßëÁõÆ‰ΩúÁ≠îÊ¨°Êï∞</div>
                                            <div class="text-sm font-bold text-[var(--text)]">${totalAttemptsSub}</div>
                                        </div>
                                        <div>
                                            <div class="text-[10px] text-[var(--sub)]">ÂΩìÂâçÁßëÁõÆÊ≠£Á°ÆÁéá</div>
                                            <div class="text-sm font-bold text-emerald-600">${accSub}%</div>
                                        </div>
                                        <div>
                                            <div class="text-[10px] text-[var(--sub)]">Á¥ØËÆ°‰ΩúÁ≠îÊÄªÊó∂Èïø</div>
                                            <div class="text-sm font-bold text-[var(--text)]">${totalTimeText}</div>
                                        </div>
                                        <div>
                                            <div class="text-[10px] text-[var(--sub)]">Âπ≥ÂùáÂçïÈ¢òÁî®Êó∂</div>
                                            <div class="text-sm font-bold text-blue-500">${avgTimeText}</div>
                                        </div>
                                        <div>
                                            <div class="text-[10px] text-[var(--sub)]">Ê∂âÂèäÈ¢òÁõÆÊï∞Èáè</div>
                                            <div class="text-sm font-bold text-[var(--text)]">${distinctQCount}</div>
                                        </div>
                                        <div>
                                            <div class="text-[10px] text-[var(--sub)]">ÊúÄËøëÊ¥ªË∑ÉÂ§©Êï∞</div>
                                            <div class="text-sm font-bold text-[var(--text)]">${buckets.filter(b => b.attempts > 0).length}</div>
                                        </div>
                                    `;
                                }
                            }

                            const qTimeEl = App.dom.get('an-sub-qtime');
                            if (qTimeEl) {
                                if (!qTimeList.length) {
                                    qTimeEl.innerHTML = '<div class="text-[11px] text-[var(--sub)]">ÊöÇÊó†ÂÖÖË∂≥Êï∞ÊçÆÔºåÂª∫ËÆÆÂÖàÂ§öÂÅöÂá†È¢ò„ÄÇ</div>';
                                } else {
                                    qTimeEl.innerHTML = qTimeList.map((item, idx) => {
                                        const avgSec = item.avgMs / 1000;
                                        const avgSecRounded = Math.round(avgSec * 10) / 10;
                                        const totalSec = Math.round(item.totalMs / 1000);
                                        const qText = App.utils.escapeHTML(item.q.q).slice(0, 40);
                                        return `
                                            <div class="flex flex-col gap-0.5 border-b border-[var(--border)] pb-1 last:border-b-0 cursor-pointer" onclick="App.views.analytics.showQuestionPopover('${item.q.id}', ${avgSecRounded}, ${totalSec}, ${item.attempts}, this)">
                                                <div class="flex items-center justify-between">
                                                    <span class="text-[10px] text-[var(--sub)]">#${idx + 1}</span>
                                                    <span class="text-[10px] text-[var(--sub)]">${item.attempts} Ê¨°</span>
                                                </div>
                                                <div class="text-[11px] text-[var(--text)]">${qText}${item.q.q.length > 40 ? '‚Ä¶' : ''}</div>
                                                <div class="flex items-center justify-between text-[10px] text-[var(--sub)]">
                                                    <span>Âπ≥ÂùáÁî®Êó∂Á∫¶ ${avgSecRounded} ÁßíÔºåÊÄªÁî®Êó∂ ${totalSec} Áßí</span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('');
                                }
                            }

                            const forgetEl = App.dom.get('an-sub-forget');
                            if (forgetEl) {
                                if (!filteredHistory.length) {
                                    forgetEl.innerHTML = '<div class="text-[11px] text-[var(--sub)]">ÊöÇÊó†Êï∞ÊçÆÔºåÊó†Ê≥ï‰º∞ËÆ°ÈÅóÂøòË∂ãÂäø„ÄÇ</div>';
                                } else {
                                    forgetEl.innerHTML = buckets.map(b => {
                                        const acc = b.attempts ? Math.round(b.correct / b.attempts * 100) : 0;
                                        return `
                                            <div class="flex items-center gap-2">
                                                <div class="w-20 text-[10px] text-[var(--sub)]">${b.label}</div>
                                                <div class="flex-1 h-2 rounded-full bg-[var(--border)] overflow-hidden">
                                                    <div class="h-2 bg-emerald-500" style="width:${acc}%;"></div>
                                                </div>
                                                <div class="w-16 text-right text-[10px] text-[var(--sub)]">${b.attempts} Ê¨° / ${acc}%</div>
                                            </div>
                                        `;
                                    }).join('');
                                }
                            }

                            const dailyAccSub = [];
                            for (let i = 29; i >= 0; i--) {
                                const d = new Date(); d.setDate(d.getDate() - i);
                                const ds = d.toISOString().slice(0, 10);
                                const recs = filteredHistory.filter(x => new Date(x.t).toISOString().slice(0, 10) === ds);
                                if (!recs.length) {
                                    dailyAccSub.push(0);
                                } else {
                                    const c = recs.filter(x => x.r).length;
                                    dailyAccSub.push(Math.round(c / recs.length * 100));
                                }
                            }
                            requestAnimationFrame(() => App.chart.draw('anSubForgetChart', dailyAccSub));

                            const cvs = App.dom.get('anSubForgetChart');
                            if (!filteredHistory.length && cvs && cvs.getContext) {
                                const ctx = cvs.getContext('2d');
                                ctx && ctx.clearRect(0, 0, cvs.width, cvs.height);
                            }
                        }

                        requestAnimationFrame(() => App.chart.drawHeatmap('heatmapChart', s.daily30));

                        const subEntries = Object.entries(s.subjectStats).filter(([, v]) => v.attempts > 0);
                        if (subEntries.length > 0) {
                            const labels = subEntries.map(([k]) => k);
                            const values = subEntries.map(([, v]) => v.acc);
                            const colors = ['#0d9488', '#0891b2', '#7c3aed', '#db2777', '#ea580c', '#65a30d'].slice(0, labels.length);
                            requestAnimationFrame(() => App.chart.drawBar('subjectChart', labels, values, colors));
                        }

                        const typeLabels = ['ÂçïÈÄâÈ¢ò', 'Â§öÈÄâÈ¢ò', 'Âà§Êñ≠È¢ò'];
                        const typeKeys = ['mcq', 'multi', 'tf'];
                        const typeValues = typeKeys.map(k => s.typeStats[k] ? s.typeStats[k].acc : 0);
                        const typeColors = ['#0d9488', '#7c3aed', '#f59e0b'];
                        requestAnimationFrame(() => App.chart.drawBar('typeChart', typeLabels, typeValues, typeColors));

                        const durLabels = ['<5Áßí', '5-15Áßí', '15-30Áßí', '30-60Áßí', '>60Áßí'];
                        const durColors = ['#10b981', '#0d9488', '#0891b2', '#7c3aed', '#ef4444'];
                        requestAnimationFrame(() => App.chart.drawDonut('durChart', s.durBuckets, durLabels, durColors));

                        const legend = App.dom.get('dur-legend');
                        if (legend) {
                            legend.innerHTML = durLabels.map((l, i) => `
                                <div class="flex items-center gap-1.5">
                                    <div class="w-2.5 h-2.5 rounded-sm flex-shrink-0" style="background:${durColors[i]}"></div>
                                    <span class="text-[var(--sub)]">${l}</span>
                                    <span class="font-bold ml-auto">${s.durBuckets[i]}</span>
                                </div>`).join('');
                        }

                        const summary = App.dom.get('an-sub-summary');
                        if (summary) {
                            summary.innerHTML = '';
                            if (s.bestSub) {
                                summary.innerHTML += `
                                    <div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-900/30 rounded-xl">
                                        <div class="flex items-center gap-3">
                                            <span class="text-xl">üèÜ</span>
                                            <div><div class="text-[10px] font-bold text-green-700 dark:text-green-500 uppercase tracking-wide">ÊúÄÂº∫ÁßëÁõÆ</div><div class="text-xs text-[var(--text)] font-medium">${s.bestSub}</div></div>
                                        </div>
                                        <span class="font-bold text-lg text-green-600 dark:text-green-400">${s.subjectStats[s.bestSub].acc}%</span>
                                    </div>`;
                            }
                            if (s.worstSub && s.worstSub !== s.bestSub) {
                                summary.innerHTML += `
                                    <div class="flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900/30 rounded-xl mt-3">
                                        <div class="flex items-center gap-3">
                                            <span class="text-xl">üìå</span>
                                            <div><div class="text-[10px] font-bold text-red-600 dark:text-red-500 uppercase tracking-wide">ÈúÄÂä†Âº∫</div><div class="text-xs text-[var(--text)] font-medium">${s.worstSub}</div></div>
                                        </div>
                                        <span class="font-bold text-lg text-red-500 dark:text-red-400">${s.subjectStats[s.worstSub].acc}%</span>
                                    </div>`;
                            }
                            if (!s.bestSub && !s.worstSub) {
                                summary.innerHTML = `<div class="text-xs text-[var(--sub)] p-4 text-center border border-dashed border-[var(--border)] rounded-xl">ÊöÇÊó†Ë∂≥Â§üÁöÑÁªÉ‰π†Êï∞ÊçÆËøõË°åÂàÜÊûê</div>`;
                            }
                        }
                    }
                }
            },
            ui: {
                _importSessionId: 0,
                _importReader: null,
                toggleModal(id) {
                    const el = App.dom.get(`modal-${id}`);
                    if (!el) return;

                    if (el.classList.contains('hidden')) {
                        el.classList.remove('hidden');
                        if (id === 'smart-practice') {
                            const container = App.dom.get('smart-subjects-list');
                            if (container) {
                                container.innerHTML = '';
                                const subs = App.data.getSubjects();
                                if (subs.length === 0) {
                                    container.innerHTML = '<div class="text-xs text-[var(--sub)] italic">ÂΩìÂâçÈ¢òÂ∫ì‰∏∫Á©∫ÔºåËØ∑ÂâçÂæÄÂè≥‰∏äËßíËÆæÁΩÆÂØºÂÖ•Êï∞ÊçÆ„ÄÇ</div>';
                                } else {
                                    subs.forEach(sub => {
                                        const div = document.createElement('div');
                                        const escapedSub = App.utils.escapeHTML(sub);
                                        div.innerHTML = `
                                            <label class="flex items-center gap-2 p-2.5 border border-[var(--border)] rounded-lg cursor-pointer hover:bg-[var(--bg-hover)] bg-[var(--card)] transition-colors">
                                                <input type="checkbox" class="smart-subject-chk accent-primary-600 w-4 h-4" value="${escapedSub}" checked>
                                                <span class="text-xs font-bold text-[var(--text)]">${escapedSub}</span>
                                            </label>
                                        `;
                                        container.appendChild(div);
                                    });
                                }
                            }
                        }
                        setTimeout(() => el.classList.remove('opacity-0', 'pointer-events-none'), 10);
                    } else {
                        this.closeModal(id);
                    }
                },

                closeModal(id) {
                    const el = App.dom.get(`modal-${id}`);
                    if (el && !el.classList.contains('hidden')) {
                        el.classList.add('opacity-0', 'pointer-events-none');
                        setTimeout(() => el.classList.add('hidden'), 200);
                    }
                },

                toggleAIAdvanced() {
                    const panel = App.dom.get('ai-advanced-panel');
                    if (!panel) return;
                    panel.classList.toggle('hidden');
                },

                showAITooltip(event, id) {
                    event.stopPropagation();
                    const existing = document.getElementById('ai-param-tooltip');
                    if (existing) existing.remove();
                    const map = {
                        'ai-tip-temperature': 'ÊéßÂà∂ÈöèÊú∫ÊÄßÔºö0 Êõ¥Ë∞®ÊÖéÔºåÂÄºË∂äÂ§ßÂõûÁ≠îË∂äÂèëÊï£„ÄÇ',
                        'ai-tip-top-p': 'Ê†∏ÈááÊ†∑ÊØî‰æãÔºö‰∏é temperature Á±ª‰ººÔºå‰∏ÄËà¨‰∫åËÄÖÂè™Ë∞É‰∏Ä‰∏™„ÄÇ',
                        'ai-tip-max-tokens': 'ÈôêÂà∂ÂçïÊ¨°ÂõûÂ§çÁöÑÊúÄÂ§ß Token Êï∞ÔºåÈò≤Ê≠¢ÂõûÁ≠îËøáÈïø„ÄÇ',
                        'ai-tip-presence': 'ÈºìÂä±ÊèêÂèäÊñ∞‰∏ªÈ¢òÔºåÂÄºË∂äÂ§ßË∂ä‰∏çÈáçÂ§çÂ∑≤Âá∫Áé∞ÁöÑÂÜÖÂÆπ„ÄÇ',
                        'ai-tip-frequency': 'ÊÉ©ÁΩöÈáçÂ§çËØçÊ±áÔºåÂÄºË∂äÂ§ßË∂äÂ∞ëÂá∫Áé∞ÈáçÂ§çÂè•Â≠ê„ÄÇ',
                        'ai-tip-timeout': 'HTTP ËØ∑Ê±ÇË∂ÖÊó∂Êó∂Èó¥ÔºåÂçï‰ΩçÊØ´ÁßíÔºåÂ°´ 0 Ë°®Á§∫‰∏çË∂ÖÊó∂„ÄÇ'
                    };
                    const text = map[id] || '';
                    if (!text) return;
                    const tip = document.createElement('div');
                    tip.id = 'ai-param-tooltip';
                    tip.className = 'fixed z-50 max-w-xs text-[10px] text-[var(--sub)] bg-[var(--card)] border border-[var(--border)] rounded-lg px-2 py-1 shadow-lg';
                    tip.textContent = text;
                    document.body.appendChild(tip);
                    const rect = event.currentTarget.getBoundingClientRect();
                    const tipRect = tip.getBoundingClientRect();
                    let left = rect.left + rect.width / 2 - tipRect.width / 2;
                    if (left < 8) left = 8;
                    if (left + tipRect.width > window.innerWidth - 8) left = window.innerWidth - tipRect.width - 8;
                    let top = rect.bottom + 6;
                    if (top + tipRect.height > window.innerHeight - 8) top = rect.top - tipRect.height - 6;
                    tip.style.left = left + 'px';
                    tip.style.top = top + 'px';
                    const hide = () => {
                        tip.remove();
                        document.removeEventListener('click', hide, true);
                        window.removeEventListener('scroll', hide, true);
                        window.removeEventListener('resize', hide, true);
                    };
                    setTimeout(() => {
                        document.addEventListener('click', hide, true);
                        window.addEventListener('scroll', hide, true);
                        window.addEventListener('resize', hide, true);
                    }, 0);
                },

                _initGlobalBackTop() {
                    const btn = App.dom.get('global-back-top');
                    if (!btn) return;
                    const THRESHOLD = 200;
                    const update = () => {
                        let show = false;
                        if (window.scrollY > THRESHOLD || document.documentElement.scrollTop > THRESHOLD) {
                            show = true;
                        } else {
                            const scrollers = document.querySelectorAll('.custom-scroll');
                            for (const el of scrollers) {
                                if (el.offsetParent !== null && el.scrollTop > THRESHOLD) {
                                    show = true;
                                    break;
                                }
                            }
                        }
                        btn.classList.toggle('opacity-0', !show);
                        btn.classList.toggle('pointer-events-none', !show);
                    };
                    window.addEventListener('scroll', update, { passive: true });
                    const scrollers = document.querySelectorAll('.custom-scroll');
                    scrollers.forEach(el => {
                        el.addEventListener('scroll', update, { passive: true });
                    });
                    update();
                },

                scrollAllToTop() {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    document.documentElement.scrollTo({ top: 0, behavior: 'smooth' });
                    const scrollers = document.querySelectorAll('.custom-scroll');
                    scrollers.forEach(el => {
                        if (el.offsetParent !== null && el.scrollTop > 0) {
                            el.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                },

                openImportCenter(defaultTab = 'json') {
                    this.toggleModal('import-center');
                    App.ui.switchImportTab(defaultTab);
                    const statusEl = App.dom.get('import-json-status');
                    if (statusEl && defaultTab === 'json') {
                        statusEl.textContent = 'Â∞öÊú™ÈÄâÊã©Êñá‰ª∂';
                    }
                },

                switchImportTab(tab) {
                    const isJson = tab === 'json';
                    const btnJson = App.dom.get('import-tab-btn-json');
                    const btnAi = App.dom.get('import-tab-btn-ai');
                    const tabJson = App.dom.get('import-tab-json');
                    const tabAi = App.dom.get('import-tab-ai');
                    if (btnJson && btnAi) {
                        btnJson.classList.toggle('bg-[var(--card)]', isJson);
                        btnJson.classList.toggle('text-[var(--text)]', isJson);
                        btnJson.classList.toggle('bg-transparent', !isJson);
                        btnJson.classList.toggle('text-[var(--sub)]', !isJson);
                        btnAi.classList.toggle('bg-[var(--card)]', !isJson);
                        btnAi.classList.toggle('text-[var(--text)]', !isJson);
                        btnAi.classList.toggle('bg-transparent', isJson);
                        btnAi.classList.toggle('text-[var(--sub)]', isJson);
                    }
                    if (tabJson && tabAi) {
                        tabJson.classList.toggle('hidden', !isJson);
                        tabAi.classList.toggle('hidden', isJson);
                    }
                },

                handleJsonPreviewUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const statusEl = App.dom.get('import-json-status');
                    const totalEl = App.dom.get('import-json-total');
                    const subEl = App.dom.get('import-json-subjects');
                    const chapEl = App.dom.get('import-json-chapters');
                    const mcqEl = App.dom.get('import-json-mcq');
                    const multiEl = App.dom.get('import-json-multi');
                    const tfEl = App.dom.get('import-json-tf');
                    const structEl = App.dom.get('import-json-struct');
                    const listEl = App.dom.get('import-json-list');
                    const applyBtn = App.dom.get('import-json-apply-btn');

                    if (applyBtn) applyBtn.disabled = true;
                    if (totalEl) totalEl.textContent = '0';
                    if (subEl) subEl.textContent = '0';
                    if (chapEl) chapEl.textContent = '0';
                    if (mcqEl) mcqEl.textContent = '0';
                    if (multiEl) multiEl.textContent = '0';
                    if (tfEl) tfEl.textContent = '0';
                    if (structEl) structEl.innerHTML = '<div class="text-[10px] text-[var(--sub)] italic">Ê≠£Âú®Ëß£ÊûêÊñá‰ª∂‚Ä¶</div>';
                    if (listEl) listEl.innerHTML = '<div class="text-[10px] text-[var(--sub)] italic">Ê≠£Âú®Ëß£ÊûêÊñá‰ª∂‚Ä¶</div>';
                    if (statusEl) statusEl.textContent = `Ê≠£Âú®ËØªÂèñÊñá‰ª∂Ôºö${file.name}`;

                    if (file.size > 5 * 1024 * 1024) {
                        alert("Êñá‰ª∂ËøáÂ§ßÔºåËØ∑‰∏ä‰º† 5MB ‰ª•ÂÜÖÁöÑÈ¢òÂ∫ìÊñá‰ª∂„ÄÇ(File exceeds 5MB limit.)");
                        e.target.value = null;
                        if (statusEl) statusEl.textContent = "‚ùå Êñá‰ª∂ËøáÂ§ßÔºåÂ∑≤ÂèñÊ∂àËß£Êûê„ÄÇ";
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const text = event.target.result;
                            let parsed;
                            try {
                                parsed = JSON.parse(text);
                            } catch (err) {
                                if (statusEl) statusEl.textContent = "‚ùå JSON Ëß£ÊûêÂ§±Ë¥•Ôºö" + (err.message || err.toString());
                                if (structEl) structEl.innerHTML = '<div class="text-[10px] text-[var(--sub)] italic">JSON Ëß£ÊûêÂ§±Ë¥•ÔºåÊó†Ê≥ïÈ¢ÑËßà„ÄÇ</div>';
                                if (listEl) listEl.innerHTML = '<div class="text-[10px] text-[var(--sub)] italic">JSON Ëß£ÊûêÂ§±Ë¥•ÔºåÊó†Ê≥ïÈ¢ÑËßà„ÄÇ</div>';
                                return;
                            }

                            const check = App.data.validateSchema(parsed);
                            if (check !== true) {
                                if (statusEl) statusEl.textContent = "‚ùå ÁªìÊûÑÊ†°È™åÂ§±Ë¥•Ôºö" + check;
                                if (structEl) structEl.innerHTML = '<div class="text-[10px] text-[var(--sub)] italic">ÁªìÊûÑÊ†°È™åÂ§±Ë¥•ÔºåËØ∑Ê†πÊçÆÊ®°ÊùøË∞ÉÊï¥ JSON„ÄÇ</div>';
                                if (listEl) listEl.innerHTML = '<div class="text-[10px] text-[var(--sub)] italic">ÁªìÊûÑÊ†°È™åÂ§±Ë¥•ÔºåÊó†Ê≥ïÁîüÊàêÈ¢ÑËßà„ÄÇ</div>';
                                return;
                            }

                            const sanitized = (window.App && App.ai && typeof App.ai.sanitizeImportedBank === 'function')
                                ? App.ai.sanitizeImportedBank(parsed)
                                : parsed;

                            const flat = [];
                            const subjSet = new Set();
                            const chapSet = new Set();
                            let mcqCount = 0, multiCount = 0, tfCount = 0;

                            for (const sub in sanitized) {
                                const chapDict = sanitized[sub] || {};
                                let subTotal = 0;
                                const chapsInfo = [];
                                for (const chap in chapDict) {
                                    const arr = Array.isArray(chapDict[chap]) ? chapDict[chap] : [];
                                    if (!arr.length) continue;
                                    chapSet.add(`${sub}::${chap}`);
                                    let cMcq = 0, cMulti = 0, cTf = 0;
                                    arr.forEach(q => {
                                        if (!q) return;
                                        const type = q.type;
                                        if (type === 'mcq') { mcqCount++; cMcq++; }
                                        else if (type === 'multi') { multiCount++; cMulti++; }
                                        else if (type === 'tf') { tfCount++; cTf++; }
                                        flat.push({
                                            sub,
                                            chap,
                                            type,
                                            q: q.q || ''
                                        });
                                    });
                                    const chapTotal = arr.length;
                                    subTotal += chapTotal;
                                    chapsInfo.push({ chap, total: chapTotal, mcq: cMcq, multi: cMulti, tf: cTf });
                                }
                                if (chapsInfo.length) {
                                    subjSet.add(sub);
                                }
                            }

                            const total = flat.length;
                            if (totalEl) totalEl.textContent = String(total);
                            if (subEl) subEl.textContent = String(subjSet.size);
                            if (chapEl) chapEl.textContent = String(chapSet.size);
                            if (mcqEl) mcqEl.textContent = String(mcqCount);
                            if (multiEl) multiEl.textContent = String(multiCount);
                            if (tfEl) tfEl.textContent = String(tfCount);

                            if (structEl) {
                                if (!total) {
                                    structEl.innerHTML = '<div class="text-[10px] text-[var(--sub)] italic">Êú™Ê£ÄÊµãÂà∞‰ªª‰ΩïÂçïÈÄâ / Â§öÈÄâ / Âà§Êñ≠È¢ò„ÄÇ</div>';
                                } else {
                                    const blocks = [];
                                    for (const sub of Array.from(subjSet)) {
                                        const chapDict = sanitized[sub] || {};
                                        let subTotal = 0;
                                        const rows = [];
                                        for (const chap in chapDict) {
                                            const arr = Array.isArray(chapDict[chap]) ? chapDict[chap] : [];
                                            if (!arr.length) continue;
                                            const chapTotal = arr.length;
                                            subTotal += chapTotal;
                                            let cMcq = 0, cMulti = 0, cTf = 0;
                                            arr.forEach(q => {
                                                if (q.type === 'mcq') cMcq++;
                                                else if (q.type === 'multi') cMulti++;
                                                else if (q.type === 'tf') cTf++;
                                            });
                                            rows.push(`
                                                <div class="flex items-center gap-2 text-[10px]">
                                                    <span class="truncate flex-1">${App.utils.escapeHTML(chap)}</span>
                                                    <span class="text-[var(--sub)]">${chapTotal} È¢ò ¬∑ ÂçïÈÄâ ${cMcq} ¬∑ Â§öÈÄâ ${cMulti} ¬∑ Âà§Êñ≠ ${cTf}</span>
                                                </div>
                                            `);
                                        }
                                        blocks.push(`
                                            <div class="mb-2 last:mb-0">
                                                <div class="flex items-center justify-between mb-1">
                                                    <div class="text-[10px] font-bold text-[var(--text)]">${App.utils.escapeHTML(sub)}</div>
                                                    <div class="text-[10px] text-[var(--sub)]">${subTotal} È¢ò</div>
                                                </div>
                                                <div class="space-y-0.5">${rows.join('')}</div>
                                            </div>
                                        `);
                                    }
                                    structEl.innerHTML = blocks.join('') || '<div class="text-[10px] text-[var(--sub)] italic">Êú™Ê£ÄÊµãÂà∞‰ªª‰ΩïÈ¢òÁõÆ„ÄÇ</div>';
                                }
                            }

                            if (listEl) {
                                if (!flat.length) {
                                    listEl.innerHTML = '<div class="text-[10px] text-[var(--sub)] italic">ÊöÇÊó†È¢òÁõÆÈ¢ÑËßà„ÄÇ</div>';
                                } else {
                                    const previewItems = flat.slice(0, 50);
                                    listEl.innerHTML = previewItems.map((item, idx) => {
                                        const typeLabel = item.type === 'mcq' ? 'ÂçïÈÄâ' : (item.type === 'multi' ? 'Â§öÈÄâ' : 'Âà§Êñ≠');
                                        const qText = App.utils.escapeHTML(String(item.q || '')).slice(0, 80);
                                        const subEsc = App.utils.escapeHTML(item.sub);
                                        const chapEsc = App.utils.escapeHTML(item.chap);
                                        const idEsc = App.utils.escapeHTML(item.id || '');
                                        return `
                                            <div class="border-b border-[var(--border)] pb-1 last:border-b-0" id="import-json-row-${idx}" data-sub="${subEsc}" data-chap="${chapEsc}" data-qid="${idEsc}">
                                                <div class="flex items-center justify-between gap-1">
                                                    <span class="text-[10px] text-[var(--sub)]">#${idx + 1}</span>
                                                    <span class="text-[10px] text-[var(--sub)] truncate flex-1 text-right">${subEsc} / ${chapEsc}</span>
                                                </div>
                                                <div class="flex items-center justify-between gap-1 mt-0.5">
                                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full border border-[var(--border)] text-[9px] text-[var(--sub)]">${typeLabel}</span>
                                                    <span class="text-[11px] text-[var(--text)] flex-1 text-right">${qText}${String(item.q || '').length > 80 ? '‚Ä¶' : ''}</span>
                                                </div>
                                                <div class="mt-1 flex items-center gap-1 text-[10px] text-[var(--sub)]">
                                                    <span>ÁßëÁõÆ</span>
                                                    <input class="import-json-sub-input flex-1 min-w-[80px] bg-[var(--card)] border border-[var(--border)] rounded px-1 py-0.5 outline-none" value="${subEsc}">
                                                    <span>Á´†ËäÇ</span>
                                                    <input class="import-json-chap-input flex-1 min-w-[80px] bg-[var(--card)] border border-[var(--border)] rounded px-1 py-0.5 outline-none" value="${chapEsc}">
                                                    <button class="px-1.5 py-0.5 border border-[var(--border)] rounded text-[10px] text-primary-600 hover:bg-primary-50"
                                                        onclick="App.ui.applyJsonMetaChange(${idx})">Â∫îÁî®</button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('');
                                }
                            }

                            App.ui._jsonImportPreview = sanitized;
                            App.ui._jsonImportPreviewCount = flat.length;
                            if (applyBtn) applyBtn.disabled = !flat.length;

                            if (statusEl) {
                                statusEl.textContent = flat.length
                                    ? `‚úÖ Ëß£ÊûêÊàêÂäüÔºöÊ£ÄÊµãÂà∞ ${flat.length} ÈÅìÈ¢òÔºàÁßëÁõÆ ${subjSet.size} ‰∏™ÔºåÁ´†ËäÇ ${chapSet.size} ‰∏™Ôºâ„ÄÇ`
                                    : "‚ö†Ô∏è Ëß£ÊûêÂÆåÊàêÔºå‰ΩÜÊú™Ê£ÄÊµãÂà∞‰ªª‰ΩïÁ¨¶ÂêàÊù°‰ª∂ÁöÑÈ¢òÁõÆ„ÄÇ";
                            }
                        } finally {
                            e.target.value = null;
                        }
                    };
                    reader.onerror = () => {
                        if (statusEl) statusEl.textContent = "‚ùå Êñá‰ª∂ËØªÂèñÂ§±Ë¥•„ÄÇ";
                        e.target.value = null;
                    };
                    reader.readAsText(file, 'UTF-8');
                },

                applyJsonPreviewImport() {
                    const data = App.ui._jsonImportPreview;
                    const count = App.ui._jsonImportPreviewCount || 0;
                    const statusEl = App.dom.get('import-json-status');
                    if (!data || !count) {
                        alert("ËØ∑ÂÖàÈÄâÊã© JSON Êñá‰ª∂Âπ∂ÂÆåÊàêÈ¢ÑËßàËß£Êûê„ÄÇ");
                        return;
                    }
                    const ok = confirm(`Âç≥Â∞ÜÊ†πÊçÆÈ¢ÑËßàÁªìÊûúÂØºÂÖ•Á∫¶ ${count} ÈÅìÈ¢òÂà∞ÂΩìÂâçÈ¢òÂ∫ìÔºåÊòØÂê¶ÁªßÁª≠Ôºü`);
                    if (!ok) {
                        if (statusEl) statusEl.textContent = "Â∑≤ÂèñÊ∂àÂØºÂÖ•Êìç‰Ωú„ÄÇ";
                        return;
                    }
                    const report = App.data.importBank(JSON.stringify(data));
                    if (!report) {
                        if (statusEl) statusEl.textContent = "‚ùå ÂØºÂÖ•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü• JSON Ê†ºÂºèÊàñÊéßÂà∂Âè∞ÈîôËØØ‰ø°ÊÅØ„ÄÇ";
                        return;
                    }
                    if (statusEl) statusEl.textContent = "‚úÖ Â∑≤Ê†πÊçÆÈ¢ÑËßà JSON ÊàêÂäüÂØºÂÖ•È¢òÂ∫ì„ÄÇ";
                },

                applyJsonMetaChange(idx) {
                    const row = document.getElementById(`import-json-row-${idx}`);
                    if (!row) return;
                    const subInput = row.querySelector('.import-json-sub-input');
                    const chapInput = row.querySelector('.import-json-chap-input');
                    if (!subInput || !chapInput) return;
                    const newSub = subInput.value.trim();
                    const newChap = chapInput.value.trim();
                    const oldSub = row.dataset.sub || '';
                    const oldChap = row.dataset.chap || '';
                    const qid = row.dataset.qid || '';
                    App.ui.updateJsonPreviewMeta(oldSub, oldChap, qid, newSub, newChap);
                },

                updateJsonPreviewMeta(oldSub, oldChap, qid, newSub, newChap) {
                    newSub = (newSub || '').trim();
                    newChap = (newChap || '').trim();
                    const statusEl = App.dom.get('import-json-status');
                    if (!newSub || !newChap) {
                        alert('ÁßëÁõÆÂíåÁ´†ËäÇ‰∏çËÉΩ‰∏∫Á©∫„ÄÇ');
                        return;
                    }
                    if (!qid) {
                        alert('ÂΩìÂâçÈ¢òÁõÆÁº∫Â∞ë IDÔºåÊó†Ê≥ïË∞ÉÊï¥ÂΩíÂ±û„ÄÇ');
                        return;
                    }
                    const data = App.ui._jsonImportPreview;
                    if (!data) {
                        alert('È¢ÑËßàÊï∞ÊçÆ‰∏çÂ≠òÂú®ÔºåËØ∑ÂÖàÈáçÊñ∞ÈÄâÊã© JSON Êñá‰ª∂„ÄÇ');
                        return;
                    }
                    if (oldSub === newSub && oldChap === newChap) {
                        return;
                    }
                    if (!data[oldSub] || !data[oldSub][oldChap]) {
                        alert('ÂéüÁßëÁõÆ/Á´†ËäÇ‰∏≠Êú™ÊâæÂà∞ËØ•È¢òÔºåÂèØËÉΩÁªìÊûÑÂ∑≤Ë¢´‰øÆÊîπ„ÄÇ');
                        return;
                    }
                    const arr = data[oldSub][oldChap];
                    const idx = arr.findIndex(q => q && q.id === qid);
                    if (idx === -1) {
                        alert('Âú®Âéü‰ΩçÁΩÆÊú™ÊâæÂà∞ÂØπÂ∫îÈ¢òÁõÆÔºåÊó†Ê≥ïË∞ÉÊï¥„ÄÇ');
                        return;
                    }
                    const q = arr[idx];
                    arr.splice(idx, 1);
                    if (!arr.length) delete data[oldSub][oldChap];
                    if (!Object.keys(data[oldSub] || {}).length) delete data[oldSub];

                    if (!data[newSub]) data[newSub] = {};
                    if (!data[newSub][newChap]) data[newSub][newChap] = [];
                    data[newSub][newChap].push(q);

                    App.ui._jsonImportPreview = data;

                    const flat = [];
                    const subjSet = new Set();
                    const chapSet = new Set();
                    let mcqCount = 0, multiCount = 0, tfCount = 0;
                    const totalEl = App.dom.get('import-json-total');
                    const subEl = App.dom.get('import-json-subjects');
                    const chapEl = App.dom.get('import-json-chapters');
                    const mcqEl = App.dom.get('import-json-mcq');
                    const multiEl = App.dom.get('import-json-multi');
                    const tfEl = App.dom.get('import-json-tf');
                    const structEl = App.dom.get('import-json-struct');
                    const listEl = App.dom.get('import-json-list');
                    const applyBtn = App.dom.get('import-json-apply-btn');

                    for (const sub in data) {
                        const chapDict = data[sub] || {};
                        let hasAny = false;
                        for (const chap in chapDict) {
                            const arrQ = Array.isArray(chapDict[chap]) ? chapDict[chap] : [];
                            if (!arrQ.length) continue;
                            hasAny = true;
                            chapSet.add(`${sub}::${chap}`);
                            arrQ.forEach(qItem => {
                                if (!qItem) return;
                                const type = qItem.type;
                                if (type === 'mcq') mcqCount++;
                                else if (type === 'multi') multiCount++;
                                else if (type === 'tf') tfCount++;
                                flat.push({
                                    sub,
                                    chap,
                                    type,
                                    q: qItem.q || '',
                                    id: qItem.id || ''
                                });
                            });
                        }
                        if (hasAny) {
                            subjSet.add(sub);
                        }
                    }

                    const total = flat.length;
                    App.ui._jsonImportPreviewCount = total;
                    if (totalEl) totalEl.textContent = String(total);
                    if (subEl) subEl.textContent = String(subjSet.size);
                    if (chapEl) chapEl.textContent = String(chapSet.size);
                    if (mcqEl) mcqEl.textContent = String(mcqCount);
                    if (multiEl) multiEl.textContent = String(multiCount);
                    if (tfEl) tfEl.textContent = String(tfCount);

                    if (structEl) {
                        if (!total) {
                            structEl.innerHTML = '<div class="text-[10px] text-[var(--sub)] italic">Êú™Ê£ÄÊµãÂà∞‰ªª‰ΩïÂçïÈÄâ / Â§öÈÄâ / Âà§Êñ≠È¢ò„ÄÇ</div>';
                        } else {
                            const blocks = [];
                            for (const sub of Array.from(subjSet)) {
                                const chapDict = data[sub] || {};
                                let subTotal = 0;
                                const rows = [];
                                for (const chap in chapDict) {
                                    const arrQ = Array.isArray(chapDict[chap]) ? chapDict[chap] : [];
                                    if (!arrQ.length) continue;
                                    const chapTotal = arrQ.length;
                                    subTotal += chapTotal;
                                    let cMcq = 0, cMulti = 0, cTf = 0;
                                    arrQ.forEach(qItem => {
                                        if (qItem.type === 'mcq') cMcq++;
                                        else if (qItem.type === 'multi') cMulti++;
                                        else if (qItem.type === 'tf') cTf++;
                                    });
                                    rows.push(`
                                        <div class="flex items-center gap-2 text-[10px]">
                                            <span class="truncate flex-1">${App.utils.escapeHTML(chap)}</span>
                                            <span class="text-[var(--sub)]">${chapTotal} È¢ò ¬∑ ÂçïÈÄâ ${cMcq} ¬∑ Â§öÈÄâ ${cMulti} ¬∑ Âà§Êñ≠ ${cTf}</span>
                                        </div>
                                    `);
                                }
                                blocks.push(`
                                    <div class="mb-2 last:mb-0">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="text-[10px] font-bold text-[var(--text)]">${App.utils.escapeHTML(sub)}</div>
                                            <div class="text-[10px] text-[var(--sub)]">${subTotal} È¢ò</div>
                                        </div>
                                        <div class="space-y-0.5">${rows.join('')}</div>
                                    </div>
                                `);
                            }
                            structEl.innerHTML = blocks.join('') || '<div class="text-[10px] text-[var(--sub)] italic">Êú™Ê£ÄÊµãÂà∞‰ªª‰ΩïÈ¢òÁõÆ„ÄÇ</div>';
                        }
                    }

                    if (listEl) {
                        if (!flat.length) {
                            listEl.innerHTML = '<div class="text-[10px] text-[var(--sub)] italic">ÊöÇÊó†È¢òÁõÆÈ¢ÑËßà„ÄÇ</div>';
                        } else {
                            const previewItems = flat.slice(0, 50);
                            listEl.innerHTML = previewItems.map((item, idx) => {
                                const typeLabel = item.type === 'mcq' ? 'ÂçïÈÄâ' : (item.type === 'multi' ? 'Â§öÈÄâ' : 'Âà§Êñ≠');
                                const qText = App.utils.escapeHTML(String(item.q || '')).slice(0, 80);
                                const subEsc = App.utils.escapeHTML(item.sub);
                                const chapEsc = App.utils.escapeHTML(item.chap);
                                const idEsc = App.utils.escapeHTML(item.id || '');
                                return `
                                    <div class="border-b border-[var(--border)] pb-1 last:border-b-0" id="import-json-row-${idx}" data-sub="${subEsc}" data-chap="${chapEsc}" data-qid="${idEsc}">
                                        <div class="flex items-center justify-between gap-1">
                                            <span class="text-[10px] text-[var(--sub)]">#${idx + 1}</span>
                                            <span class="text-[10px] text-[var(--sub)] truncate flex-1 text-right">${subEsc} / ${chapEsc}</span>
                                        </div>
                                        <div class="flex items-center justify-between gap-1 mt-0.5">
                                            <span class="inline-flex items-center px-1.5 py-0.5 rounded-full border border-[var(--border)] text-[9px] text-[var(--sub)]">${typeLabel}</span>
                                            <span class="text-[11px] text-[var(--text)] flex-1 text-right">${qText}${String(item.q || '').length > 80 ? '‚Ä¶' : ''}</span>
                                        </div>
                                        <div class="mt-1 flex items-center gap-1 text-[10px] text-[var(--sub)]">
                                            <span>ÁßëÁõÆ</span>
                                            <input class="import-json-sub-input flex-1 min-w-[80px] bg-[var(--card)] border border-[var(--border)] rounded px-1 py-0.5 outline-none" value="${subEsc}">
                                            <span>Á´†ËäÇ</span>
                                            <input class="import-json-chap-input flex-1 min-w-[80px] bg-[var(--card)] border border-[var(--border)] rounded px-1 py-0.5 outline-none" value="${chapEsc}">
                                            <button class="px-1.5 py-0.5 border border-[var(--border)] rounded text-[10px] text-primary-600 hover:bg-primary-50"
                                                onclick="App.ui.applyJsonMetaChange(${idx})">Â∫îÁî®</button>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        }
                    }

                    if (applyBtn) applyBtn.disabled = !flat.length;
                    if (statusEl) {
                        statusEl.textContent = flat.length
                            ? `‚úÖ È¢ÑËßàÂ∑≤Êõ¥Êñ∞ÔºöÂΩìÂâçÂ∞ÜÂØºÂÖ• ${flat.length} ÈÅìÈ¢òÔºàÁßëÁõÆ ${subjSet.size} ‰∏™ÔºåÁ´†ËäÇ ${chapSet.size} ‰∏™Ôºâ„ÄÇ`
                            : "‚ö†Ô∏è ÂΩìÂâçÈ¢ÑËßà‰∏≠‰∏çÂÜçÂåÖÂê´‰ªª‰ΩïÈ¢òÁõÆ„ÄÇ";
                    }
                },

                initTheme() {
                    if (localStorage.getItem('dark') === '1') document.documentElement.classList.add('dark');
                },
                toggleTheme() {
                    const isDark = !document.documentElement.classList.contains('dark');
                    document.documentElement.classList.toggle('dark');
                    localStorage.setItem('dark', isDark ? '1' : '0');

                    const currentView = document.querySelector('[id^="view-"]:not(.hidden)');
                    if (currentView) {
                        const viewName = currentView.id.replace('view-', '');
                        if (App.views[viewName] && typeof App.views[viewName].render === 'function') {
                            App.views[viewName].render();
                        }
                    }
                },
                openDrawer(id) {
                    const q = App.data.getQuestionById(id); if (!q) return;
                    const drawer = App.dom.get('insight-drawer');
                    const backdrop = App.dom.get('drawer-backdrop');
                    if (!drawer || !backdrop) return;

                    App.dom.setText('drawer-meta', `${q.sub} ‚Ä¢ ${q.chap}`);
                    App.dom.setText('drawer-q', q.q);
                    const h = App.data.history.filter(x => x.id === id).slice(-5);
                    const dots = App.dom.get('drawer-dots');
                    if (dots) {
                        dots.innerHTML = '';
                        h.forEach(rec => {
                            const d = document.createElement('div');
                            d.className = `w-3 h-3 rounded-full ${rec.r ? 'dot-correct' : 'dot-wrong'}`;
                            dots.appendChild(d);
                        });
                        for (let i = 0; i < (5 - h.length); i++) {
                            const d = document.createElement('div');
                            d.className = `w-3 h-3 rounded-full dot-empty`;
                            dots.appendChild(d);
                        }
                    }

                    App.ai.setContext(q);

                    backdrop.classList.remove('hidden');
                    drawer.classList.remove('translate-x-full');
                    setTimeout(() => backdrop.classList.remove('opacity-0'), 10);
                },
                closeDrawer() {
                    const drawer = App.dom.get('insight-drawer');
                    const backdrop = App.dom.get('drawer-backdrop');
                    if (!drawer || !backdrop) return;

                    drawer.classList.add('translate-x-full');
                    backdrop.classList.add('opacity-0');
                    setTimeout(() => backdrop.classList.add('hidden'), 300);
                },

                handleFileUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    // ‰øÆÂ§ç 4: Â¢ûÂä†Êñá‰ª∂Â§ßÂ∞èÈôêÂà∂ (5MB‰∏äÈôê)ÔºåÈò≤Ê≠¢Â§ßÊñá‰ª∂ÈòªÂ°û‰∏ªÁ∫øÁ®ã (Prevent Main Thread Blocking)
                    if (file.size > 5 * 1024 * 1024) {
                        alert("Êñá‰ª∂ËøáÂ§ßÔºåËØ∑‰∏ä‰º† 5MB ‰ª•ÂÜÖÁöÑÈ¢òÂ∫ìÊñá‰ª∂„ÄÇ(File exceeds 5MB limit.)");
                        e.target.value = null;
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const text = event.target.result;
                        const report = App.data.importBank(text);
                        if (!report) {
                            alert('ÂØºÂÖ•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü• JSON ÂÜÖÂÆπ„ÄÇ');
                        } else {
                            const msgLines = [
                                `È¢òÂ∫ìÂØºÂÖ•ÂÆåÊàêÔºö`,
                                `- Êñ∞Â¢ûÈ¢òÁõÆÔºö${report.added}`,
                                `- Ë¶ÜÁõñÊõ¥Êñ∞Ôºö${report.updated}`,
                                `- ÂÆåÂÖ®ÈáçÂ§çË∑≥ËøáÔºö${report.skippedSame}`,
                                report.similarPairs.length ? `- Áñë‰ººÁõ∏‰ººÈ¢òÁªÑÔºö${report.similarPairs.length} ÁªÑ` : ''
                            ].filter(Boolean);
                            alert(msgLines.join('\n'));
                        }
                    };
                    reader.onerror = () => alert('Êñá‰ª∂ËØªÂèñÂ§±Ë¥• (File read error)');
                    reader.readAsText(file, 'UTF-8');
                    e.target.value = null;
                },

                // AI ÊñáÊ°£ÂØºÂÖ•ÔºöÊ†πÊçÆÊñá‰ª∂Á±ªÂûãÊèêÂèñÁ∫ØÊñáÊú¨Âπ∂Â°´ÂÖÖÂà∞ÊñáÊú¨Ê°Ü‰∏≠
                async handleAIImportFile(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    this._importSessionId += 1;
                    const sessionId = this._importSessionId;
                    if (this._importReader && this._importReader.readyState === 1) {
                        try { this._importReader.abort(); } catch (e) { }
                    }
                    this._importReader = null;

                    const nameEl = App.dom.get('ai-import-file-name');
                    if (nameEl) {
                        const sizeKb = Math.round(file.size / 1024);
                        nameEl.textContent = `${file.name} (${sizeKb} KB)`;
                    }

                    const statusEl = App.dom.get('ai-import-status');
                    const textArea = App.dom.get('ai-import-raw');

                    const setStatus = (msg) => { if (sessionId === this._importSessionId && statusEl) statusEl.textContent = msg; };
                    const setRaw = (txt) => { if (sessionId === this._importSessionId && textArea) textArea.value = txt || ''; };

                    setStatus("Ê≠£Âú®ËØªÂèñÂπ∂Ëß£ÊûêÊñá‰ª∂ÂÜÖÂÆπ‚Ä¶");

                    const ext = file.name.toLowerCase().split('.').pop();

                    try {
                        if (ext === 'txt' || ext === 'md') {
                            const reader = new FileReader();
                            this._importReader = reader;
                            reader.onload = (event) => {
                                if (sessionId !== this._importSessionId) return;
                                setRaw(event.target.result || '');
                                setStatus("ÊñáÊú¨Êñá‰ª∂ËØªÂèñÂÆåÊàêÔºåÂèØ‰ª•ÁÇπÂáª„ÄåAI ËØÜÂà´Âπ∂ÂØºÂÖ•„Äç„ÄÇ");
                            };
                            reader.onerror = () => { if (sessionId === this._importSessionId) setStatus("‚ùå ÊñáÊú¨Êñá‰ª∂ËØªÂèñÂ§±Ë¥•„ÄÇ"); };
                            reader.readAsText(file, 'UTF-8');
                        } else if (ext === 'docx') {
                            if (!window.mammoth) {
                                setStatus("‚ùå Êú™ÊâæÂà∞ DOCX Ëß£ÊûêÂ∫ì mammothÔºåÊó†Ê≥ïËß£Êûê Word ÊñáÊ°£„ÄÇ");
                                return;
                            }
                            const reader = new FileReader();
                            this._importReader = reader;
                            reader.onload = async (event) => {
                                try {
                                    if (sessionId !== this._importSessionId) return;
                                    const arrayBuffer = event.target.result;
                                    const result = await mammoth.extractRawText({ arrayBuffer });
                                    if (sessionId !== this._importSessionId) return;
                                    setRaw(result.value || '');
                                    setStatus("DOCX ÊñáÊ°£Ëß£ÊûêÂÆåÊàêÔºåÂèØ‰ª•ÁÇπÂáª„ÄåAI ËØÜÂà´Âπ∂ÂØºÂÖ•„Äç„ÄÇ");
                                    if (arrayBuffer) {
                                        event.target.result = null;
                                    }
                                } catch (err) {
                                    console.error("DOCX parse error", err);
                                    setStatus("‚ùå Ëß£Êûê DOCX ÊñáÊ°£Â§±Ë¥•ÔºåËØ∑Á°ÆËÆ§Êñá‰ª∂Ê†ºÂºèÊòØÂê¶Ê≠£Á°Æ„ÄÇ");
                                }
                            };
                            reader.onerror = () => { if (sessionId === this._importSessionId) setStatus("‚ùå ËØªÂèñ DOCX Êñá‰ª∂Â§±Ë¥•„ÄÇ"); };
                            reader.readAsArrayBuffer(file);
                        } else if (ext === 'pdf') {
                            const reader = new FileReader();
                            this._importReader = reader;
                            reader.onload = async (event) => {
                                try {
                                    if (window.pdfjsReady) {
                                        await window.pdfjsReady;
                                    }
                                    if (!window.pdfjsLib) {
                                        setStatus("‚ùå Êú™ÊâæÂà∞ PDF Ëß£ÊûêÂ∫ì pdf.jsÔºåÊó†Ê≥ïËß£Êûê PDF ÊñáÊ°£„ÄÇ");
                                        return;
                                    }
                                    if (sessionId !== this._importSessionId) return;
                                    const arrayBuffer = event.target.result;
                                    const uint8Array = new Uint8Array(arrayBuffer);
                                    const loadingTask = window.pdfjsLib.getDocument({ data: uint8Array });
                                    const pdf = await loadingTask.promise;

                                    let text = '';
                                    const batchSize = 10;
                                    for (let i = 1; i <= pdf.numPages; i += batchSize) {
                                        if (sessionId !== this._importSessionId) return;
                                        const end = Math.min(i + batchSize - 1, pdf.numPages);
                                        for (let pageNum = i; pageNum <= end; pageNum++) {
                                            if (sessionId !== this._importSessionId) return;
                                            const page = await pdf.getPage(pageNum);
                                            const content = await page.getTextContent();
                                            const strings = content.items.map(item => item.str);
                                            text += strings.join(' ') + '\n\n';
                                        }
                                        // ÊâπÂ§ÑÁêÜ‰πãÈó¥ËÆ©Âá∫‰∏ªÁ∫øÁ®ãÔºåÈÅøÂÖçÈïøÊó∂Èó¥ÈòªÂ°ûÁïåÈù¢
                                        await new Promise(resolve => setTimeout(resolve, 0));
                                        setStatus(`Ê≠£Âú®Ëß£Êûê PDF Á¨¨ ${end}/${pdf.numPages} È°µ‚Ä¶`);
                                    }

                                    if (sessionId !== this._importSessionId) return;
                                    setRaw(text.trim());
                                    setStatus("PDF ÊñáÊ°£Ëß£ÊûêÂÆåÊàêÔºåÂèØ‰ª•ÁÇπÂáª„ÄåAI ËØÜÂà´Âπ∂ÂØºÂÖ•„Äç„ÄÇ");
                                    text = null;
                                } catch (err) {
                                    console.error("PDF parse error", err);
                                    setStatus("‚ùå Ëß£Êûê PDF ÊñáÊ°£Â§±Ë¥•ÔºåËØ∑Á°ÆËÆ§Êñá‰ª∂Ê†ºÂºèÊòØÂê¶Ê≠£Â∏∏„ÄÇ");
                                }
                            };
                            reader.onerror = () => { if (sessionId === this._importSessionId) setStatus("‚ùå ËØªÂèñ PDF Êñá‰ª∂Â§±Ë¥•„ÄÇ"); };
                            reader.readAsArrayBuffer(file);
                        } else {
                            setStatus("‚ùå ÂΩìÂâç‰ªÖÊîØÊåÅ .txt / .md / .docx / .pdf Êñá‰ª∂Á±ªÂûã„ÄÇ");
                        }
                    } catch (err) {
                        console.error('AI import file handling error', err);
                        setStatus("‚ùå Êñá‰ª∂Â§ÑÁêÜËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØÔºö" + (err.message || 'Êú™Áü•ÈîôËØØ'));
                    } finally {
                        e.target.value = null;
                    }
                },

                downloadTemplate() {
                    const template = {
                        "Subject Example (ÁßëÁõÆÁ§∫‰æã)": {
                            "Chapter 1 (Á´†ËäÇÁ§∫‰æã)": [
                                {
                                    "id": "q1",
                                    "type": "mcq",
                                    "q": "Á§∫‰æãÂçïÈÄâÈ¢ò (Example MCQ Question)",
                                    "o": ["Option A", "Option B", "Option C", "Option D"],
                                    "a": "A"
                                },
                                {
                                    "id": "q2",
                                    "type": "tf",
                                    "q": "Á§∫‰æãÂà§Êñ≠È¢ò (Example True/False)",
                                    "a": "F"
                                },
                                {
                                    "id": "q3",
                                    "type": "multi",
                                    "q": "Á§∫‰æãÂ§öÈÄâÈ¢ò (Example Multi-select)",
                                    "o": ["Option A", "Option B", "Option C"],
                                    "a": "AC"
                                }
                            ]
                        }
                    };
                    const blob = new Blob([JSON.stringify(template, null, 4)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'LMS_Question_Bank_Template.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },

                // ÊâìÂºÄÁñë‰ººÁõ∏‰ººÈ¢òÂÆ°Êü•ÂºπÁ™ó
                openSimilarReview() {
                    const report = App.data._lastImportReport;
                    if (!report || !report.similarPairs || report.similarPairs.length === 0) {
                        alert("ÂΩìÂâçÊ≤°ÊúâÊ£ÄÊµãÂà∞ÈúÄË¶ÅÂÆ°Êü•ÁöÑÁñë‰ººÁõ∏‰ººÈ¢ò„ÄÇËØ∑ÂÖàÈÄöËøáÂØºÂÖ•È¢òÂ∫ìÁîüÊàê„ÄÇ");
                        return;
                    }
                    const modal = App.dom.get('modal-dup-review');
                    const list = App.dom.get('dup-review-list');
                    if (!modal || !list) return;

                    list.innerHTML = '';
                    const pairs = report.similarPairs;

                    pairs.forEach((pair, idx) => {
                        const item = document.createElement('div');
                        item.className = 'mb-3 border border-[var(--border)] rounded-xl p-3 bg-[var(--card)]';
                        const subEsc = App.utils.escapeHTML(pair.sub || '');
                        const chapEsc = App.utils.escapeHTML(pair.chap || '');
                        const existId = App.utils.escapeHTML(pair.existing?.id || '');
                        const incomingId = App.utils.escapeHTML(pair.incoming?.id || '');
                        const existQ = App.utils.escapeHTML(pair.existing?.q || '');
                        const incomingQ = App.utils.escapeHTML(pair.incoming?.q || '');
                        const existA = App.utils.escapeHTML(pair.existing?.a || '-');
                        const incomingA = App.utils.escapeHTML(pair.incoming?.a || '-');
                        item.innerHTML = `
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-[10px] text-[var(--sub)]">
                                    #${idx + 1} [${subEsc} / ${chapEsc}] Áõ∏‰ººÂ∫¶Ôºö<span class="font-bold text-amber-600">${(pair.score * 100).toFixed(0)}%</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <div class="rounded-lg border border-[var(--border)] bg-[var(--bg)] p-2">
                                    <div class="text-[10px] text-[var(--sub)] mb-1">Áé∞ÊúâÈ¢òÔºàÈ¢òÂ∫ì‰∏≠Â∑≤ÊúâÔºâ ‚Ä¢ ID: ${existId}</div>
                                    <div class="text-[11px] font-medium text-[var(--text)] mb-1">${existQ}</div>
                                    <div class="text-[10px] text-[var(--sub)]">Á≠îÊ°àÔºö${existA}</div>
                                </div>
                                <div class="rounded-lg border border-[var(--border)] bg-[var(--bg)] p-2">
                                    <div class="text-[10px] text-[var(--sub)] mb-1">Êñ∞ÂØºÂÖ•È¢ò ‚Ä¢ ID: ${incomingId}</div>
                                    <div class="text-[11px] font-medium text-[var(--text)] mb-1">${incomingQ}</div>
                                    <div class="text-[10px] text-[var(--sub)]">Á≠îÊ°àÔºö${incomingA}</div>
                                </div>
                            </div>
                            <div class="mt-2 flex flex-wrap gap-3 text-[10px]">
                                <label class="flex items-center gap-1">
                                    <input type="radio" name="dup-choice-${idx}" value="keep-both" class="accent-primary-600" checked>
                                    <span>ÈÉΩ‰øùÁïôÔºàÈªòËÆ§Ôºâ</span>
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="radio" name="dup-choice-${idx}" value="keep-old" class="accent-primary-600">
                                    <span>‰øùÁïôÁé∞ÊúâÈ¢òÔºåÂà†Èô§Êñ∞È¢ò</span>
                                </label>
                                <label class="flex items-center gap-1">
                                    <input type="radio" name="dup-choice-${idx}" value="keep-new" class="accent-primary-600">
                                    <span>‰øùÁïôÊñ∞È¢òÔºåÂà†Èô§ÊóßÈ¢ò</span>
                                </label>
                            </div>
                        `;
                        list.appendChild(item);
                    });

                    modal.classList.remove('hidden');
                    setTimeout(() => modal.classList.remove('opacity-0', 'pointer-events-none'), 10);
                },

                // Â∫îÁî®Áñë‰ººÁõ∏‰ººÈ¢òÂÆ°Êü•ÁªìÊûúÔºöÊ†πÊçÆÁî®Êà∑ÈÄâÊã©ËΩØÂà†ÂØπÂ∫îÈ¢òÁõÆ
                applySimilarReview() {
                    const report = App.data._lastImportReport;
                    if (!report || !report.similarPairs || report.similarPairs.length === 0) {
                        alert('ÂΩìÂâçÊ≤°ÊúâÂæÖÂÆ°Êü•ÁöÑÁõ∏‰ººÈ¢ò„ÄÇ');
                        return;
                    }
                    if (!confirm(`Á°ÆËÆ§Ë¶ÅÂ∫îÁî®Ëøô ${report.similarPairs.length} ÁªÑÂÆ°Êü•ÁªìÊûúÂêóÔºü`)) {
                        return;
                    }
                    const toDeleteOld = new Set();
                    const toDeleteNew = new Set();

                    report.similarPairs.forEach((pair, idx) => {
                        const choice = document.querySelector(`input[name="dup-choice-${idx}"]:checked`);
                        const val = choice ? choice.value : 'keep-both';
                        if (val === 'keep-old') {
                            toDeleteNew.add(pair.incoming.id);
                        } else if (val === 'keep-new') {
                            toDeleteOld.add(pair.existing.id);
                        }
                    });

                    if (toDeleteOld.size === 0 && toDeleteNew.size === 0) {
                        App.ui.closeModal('dup-review');
                        return;
                    }

                    if (toDeleteOld.size > 0) {
                        App.data.softDeleteByIds(toDeleteOld, 'duplicate-review-discard-old');
                    }
                    if (toDeleteNew.size > 0) {
                        App.data.softDeleteByIds(toDeleteNew, 'duplicate-review-discard-new');
                    }

                    // ÂÆ°Êü•ÂÆåÊàêÂêéÊ∏ÖÁ©∫Áõ∏‰ººÂØπÔºåÈÅøÂÖçÈáçÂ§çÂ§ÑÁêÜ
                    report.similarPairs = [];
                    App.ui.closeModal('dup-review');
                    // Âà∑Êñ∞ÊÄªÈ¢òÂ∫ìÔºåËÆ©ÂèòÊõ¥Á´ãÂàªÁîüÊïà
                    App.views.library.render(App.views.library.currentMode);
                },

                // ÊâìÂºÄÈ¢òÁõÆÁºñËæëÂô®
                openQuestionEditor(qId) {
                    // ÂÖºÂÆπÊóßËØ≠Ê≥ïÁéØÂ¢ÉÔºöÂú®ÂáΩÊï∞‰ΩìÂÜÖÂ§ÑÁêÜÈªòËÆ§ÂÄº
                    if (typeof qId === 'undefined') qId = null;
                    const modal = App.dom.get('modal-question-editor');
                    if (!modal) return;
                    const titleEl = App.dom.get('qe-title');
                    const idInput = App.dom.get('qe-id');
                    const subSelect = App.dom.get('qe-subject-select');
                    const subInput = App.dom.get('qe-subject-input');
                    const chapSelect = App.dom.get('qe-chapter-select');
                    const chapInput = App.dom.get('qe-chapter-input');
                    const typeSelect = App.dom.get('qe-type');
                    const qText = App.dom.get('qe-q');
                    const errEl = App.dom.get('qe-error');

                    if (errEl) errEl.textContent = '';

                    if (subSelect) {
                        subSelect.innerHTML = '';
                        const subjects = App.data.getSubjects();
                        subjects.forEach(s => {
                            const opt = document.createElement('option');
                            opt.value = s;
                            opt.textContent = s;
                            subSelect.appendChild(opt);
                        });
                    }

                    const filterEl = App.dom.get('lib-filter');
                    const defaultSub = filterEl && filterEl.value !== 'all' ? filterEl.value : (App.data.getSubjects()[0] || '');
                    if (subSelect && defaultSub) subSelect.value = defaultSub;
                    if (subInput) subInput.value = '';

                    const updateChaps = (sub) => {
                        if (!chapSelect) return;
                        chapSelect.innerHTML = '';
                        if (!sub) return;
                        const chaps = App.data.getChapters(sub);
                        chaps.forEach(c => {
                            const opt = document.createElement('option');
                            opt.value = c;
                            opt.textContent = c;
                            chapSelect.appendChild(opt);
                        });
                    };
                    updateChaps(defaultSub);
                    if (chapInput) chapInput.value = '';

                    if (subSelect) {
                        subSelect.onchange = () => updateChaps(subSelect.value);
                    }

                    const optionsBlock = App.dom.get('qe-options-block');
                    const tfBlock = App.dom.get('qe-tf-block');
                    const optList = App.dom.get('qe-options-list');

                    if (!qId) {
                        if (titleEl) titleEl.textContent = 'Êñ∞Â¢ûÈ¢òÁõÆ';
                        if (idInput) idInput.value = '';
                        if (typeSelect) typeSelect.value = 'mcq';
                        if (qText) qText.value = '';
                        if (optionsBlock && optList) {
                            optionsBlock.classList.remove('hidden');
                            tfBlock && tfBlock.classList.add('hidden');
                            optList.innerHTML = '';
                            ['ÈÄâÈ°π A', 'ÈÄâÈ°π B', 'ÈÄâÈ°π C', 'ÈÄâÈ°π D'].forEach(t => App.ui.addQuestionOption(t));
                        }
                        if (tfBlock) {
                            const radios = tfBlock.querySelectorAll('input[name="qe-tf"]');
                            radios.forEach(r => r.checked = false);
                        }
                    } else {
                        const q = App.data.getQuestionById(qId);
                        if (!q) return;
                        if (titleEl) titleEl.textContent = 'ÁºñËæëÈ¢òÁõÆ';
                        if (idInput) idInput.value = q.id;
                        if (qText) qText.value = q.q;
                        if (subSelect) subSelect.value = q.sub;
                        updateChaps(q.sub);
                        if (chapSelect) chapSelect.value = q.chap;
                        if (typeSelect) typeSelect.value = q.type;

                        if (q.type === 'tf') {
                            optionsBlock && optionsBlock.classList.add('hidden');
                            if (tfBlock) {
                                tfBlock.classList.remove('hidden');
                                const radios = tfBlock.querySelectorAll('input[name="qe-tf"]');
                                radios.forEach(r => { r.checked = r.value === q.a; });
                            }
                        } else {
                            if (optionsBlock && optList) {
                                optionsBlock.classList.remove('hidden');
                                tfBlock && tfBlock.classList.add('hidden');
                                optList.innerHTML = '';
                                (q.o || []).forEach(text => App.ui.addQuestionOption(text));
                                const correctSet = new Set((q.a || '').split(''));
                                const rows = optList.querySelectorAll('.qe-opt-row');
                                rows.forEach((row, idx) => {
                                    const chk = row.querySelector('input[type="checkbox"]');
                                    if (!chk) return;
                                    const letter = String.fromCharCode(65 + idx);
                                    chk.checked = correctSet.has(letter);
                                });
                            }
                        }
                    }

                    modal.classList.remove('hidden');
                    setTimeout(() => modal.classList.remove('opacity-0', 'pointer-events-none'), 10);
                },

                onQuestionTypeChange() {
                    const typeEl = App.dom.get('qe-type');
                    const type = typeEl ? typeEl.value : 'mcq';
                    const optionsBlock = App.dom.get('qe-options-block');
                    const tfBlock = App.dom.get('qe-tf-block');
                    const tfRadios = document.querySelectorAll('#qe-tf-block input[name="qe-tf"]');

                    if (type === 'tf') {
                        // ÂàáÊç¢‰∏∫Âà§Êñ≠È¢òÔºöÈöêËóèÈÄâÈ°πÂå∫ÔºåÊ∏ÖÁ©∫ÊâÄÊúâÈÄâÈ°πÂãæÈÄâ
                        const list = App.dom.get('qe-options-list');
                        if (list) {
                            const rows = list.querySelectorAll('.qe-opt-row input[type="checkbox"]');
                            rows.forEach(chk => chk.checked = false);
                        }
                        optionsBlock && optionsBlock.classList.add('hidden');
                        tfBlock && tfBlock.classList.remove('hidden');
                    } else {
                        // ÂàáÊç¢‰∏∫ÈÄâÊã©È¢òÔºöÊòæÁ§∫ÈÄâÈ°πÂå∫ÔºåÊ∏ÖÁ©∫Âà§Êñ≠È¢òÂãæÈÄâ
                        tfRadios.forEach(r => { r.checked = false; });
                        optionsBlock && optionsBlock.classList.remove('hidden');
                        tfBlock && tfBlock.classList.add('hidden');
                    }
                },

                addQuestionOption(initialText = '') {
                    const list = App.dom.get('qe-options-list');
                    if (!list) return;
                    const idx = list.querySelectorAll('.qe-opt-row').length;
                    const letter = String.fromCharCode(65 + idx);
                    const row = document.createElement('div');
                    row.className = 'qe-opt-row flex items-center gap-2';
                    row.innerHTML = `
                        <span class="w-5 text-[11px] font-bold text-[var(--sub)]">${letter}.</span>
                        <input class="flex-1 bg-[var(--card)] border border-[var(--border)] rounded-lg px-2 py-1.5 outline-none text-xs"
                               value="${initialText.replace(/"/g, '&quot;')}"
                               placeholder="ÈÄâÈ°πÂÜÖÂÆπ" />
                        <label class="flex items-center gap-1 text-[10px] text-[var(--sub)]">
                            <input type="checkbox" class="accent-primary-600" />
                            <span>Ê≠£Á°Æ</span>
                        </label>
                        <button class="text-[10px] text-[var(--sub)] hover:text-red-500 p-1"
                                onclick="this.parentElement.remove(); App.ui.renumberQuestionOptions()">
                            ‚úï
                        </button>
                    `;
                    list.appendChild(row);
                },

                renumberQuestionOptions() {
                    const list = App.dom.get('qe-options-list');
                    if (!list) return;
                    const rows = list.querySelectorAll('.qe-opt-row');
                    rows.forEach((row, idx) => {
                        const letter = String.fromCharCode(65 + idx);
                        const span = row.querySelector('span');
                        if (span) span.textContent = `${letter}.`;
                    });
                },

                saveQuestionFromEditor() {
                    const id = App.dom.get('qe-id')?.value || '';
                    const subSelect = App.dom.get('qe-subject-select');
                    const subInput = App.dom.get('qe-subject-input');
                    const chapSelect = App.dom.get('qe-chapter-select');
                    const chapInput = App.dom.get('qe-chapter-input');
                    const typeSelect = App.dom.get('qe-type');
                    const qText = App.dom.get('qe-q');
                    const errEl = App.dom.get('qe-error');

                    const type = typeSelect ? typeSelect.value : 'mcq';
                    const sub = (subInput && subInput.value.trim()) || (subSelect && subSelect.value) || '';
                    const chap = (chapInput && chapInput.value.trim()) || (chapSelect && chapSelect.value) || '';
                    const q = qText ? qText.value.trim() : '';

                    if (errEl) errEl.textContent = '';
                    if (!sub || !chap || !q) {
                        if (errEl) errEl.textContent = 'ÁßëÁõÆ / Á´†ËäÇ / È¢òÂπ≤ ‰∏çËÉΩ‰∏∫Á©∫„ÄÇ';
                        return;
                    }

                    let options = [];
                    let answer = '';

                    if (type === 'tf') {
                        const tfBlock = App.dom.get('qe-tf-block');
                        const radios = tfBlock ? tfBlock.querySelectorAll('input[name="qe-tf"]') : [];
                        let val = '';
                        radios.forEach(r => { if (r.checked) val = r.value; });
                        if (!val) {
                            if (errEl) errEl.textContent = 'ËØ∑‰∏∫Âà§Êñ≠È¢òÈÄâÊã©Ê≠£Á°ÆÁ≠îÊ°à„ÄÇ';
                            return;
                        }
                        answer = val;
                    } else {
                        const list = App.dom.get('qe-options-list');
                        if (!list) return;
                        const rows = list.querySelectorAll('.qe-opt-row');
                        if (rows.length < 2) {
                            if (errEl) errEl.textContent = 'ÂçïÈÄâ / Â§öÈÄâÈ¢òËá≥Â∞ëÈúÄË¶Å‰∏§‰∏™ÈÄâÈ°π„ÄÇ';
                            return;
                        }
                        const ansLetters = [];
                        rows.forEach((row, idx) => {
                            const input = row.querySelector('input[type="text"], input:not([type])');
                            const chk = row.querySelector('input[type="checkbox"]');
                            if (!input) return;
                            const text = input.value.trim();
                            if (!text) return;
                            options.push(text);
                            if (chk && chk.checked) {
                                const letter = String.fromCharCode(65 + idx);
                                ansLetters.push(letter);
                            }
                        });
                        if (!options.length || options.length < 2) {
                            if (errEl) errEl.textContent = 'ÈÄâÈ°πÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫ÔºåÂπ∂‰∏îËá≥Â∞ë‰∏§È°π„ÄÇ';
                            return;
                        }
                        if (!ansLetters.length) {
                            if (errEl) errEl.textContent = 'ËØ∑Ëá≥Â∞ëÂãæÈÄâ‰∏Ä‰∏™Ê≠£Á°ÆÈÄâÈ°π„ÄÇ';
                            return;
                        }
                        answer = ansLetters.sort().join('');
                        if (type === 'mcq' && answer.length !== 1) {
                            if (errEl) errEl.textContent = 'ÂçïÈÄâÈ¢òÂè™ËÉΩÊúâ‰∏Ä‰∏™Ê≠£Á°ÆÈÄâÈ°π„ÄÇ';
                            return;
                        }
                    }

                    // Âü∫Á°ÄÊ∏ÖÊ¥óÔºöÂéªÊéâÈÄâÈ°πÂâçÈù¢ÁöÑ A./1)/‚ë† Á≠âÂâçÁºÄÔºåÈÅøÂÖçÈáçÂ§çÂâçÁºÄ
                    const cleanedOptions = options.map(txt => {
                        return txt.replace(/^[A-Za-z0-9‚ë†-‚ë≥Ôº°-Ôº∫ÔΩÅ-ÔΩöÔºê-Ôºô][\.„ÄÅÔºé:ÔºöÔºâ)\-\s]+/, '').trim();
                    });

                    App.data.upsertQuestion({
                        id,
                        sub,
                        chap,
                        type,
                        q,
                        o: type === 'tf' ? undefined : cleanedOptions,
                        a: answer
                    });

                    if (App.data && typeof App.data.saveToCloudDebounced === 'function') {
                        App.data.saveToCloudDebounced();
                    }

                    App.ui.closeModal('question-editor');
                    App.views.library.render(App.views.library.currentMode);
                },

                openTrashModal() {
                    const modal = App.dom.get('modal-trash');
                    const list = App.dom.get('trash-list');
                    if (!modal || !list) return;

                    if (!list.dataset.bound) {
                        list.addEventListener('click', (e) => {
                            const btn = e.target.closest('button[data-action]');
                            if (!btn) return;
                            const action = btn.dataset.action;
                            const sub = decodeURIComponent(btn.dataset.sub || '');
                            const chap = decodeURIComponent(btn.dataset.chap || '');
                            const id = decodeURIComponent(btn.dataset.id || '');
                            if (action === 'restore') {
                                App.data.restoreFromTrash(sub, chap, id);
                                App.ui.openTrashModal();
                            } else if (action === 'destroy') {
                                if (confirm('Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÈÅìÈ¢òÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                                    App.data.destroyFromTrash(sub, chap, id);
                                    App.ui.openTrashModal();
                                }
                            }
                        });
                        list.dataset.bound = '1';
                    }

                    list.innerHTML = '';
                    const trash = App.data.trash || {};
                    const subs = Object.keys(trash);

                    if (!subs.length) {
                        list.innerHTML = '<div class="text-center text-[var(--sub)] py-8">ÂõûÊî∂Á´ô‰∏∫Á©∫„ÄÇ</div>';
                    } else {
                        subs.forEach(sub => {
                            const chapDict = trash[sub] || {};
                            const chaps = Object.keys(chapDict);
                            chaps.forEach(chap => {
                                const arr = chapDict[chap] || [];
                                if (!arr.length) return;
                                const block = document.createElement('div');
                                block.className = 'mb-4 border border-[var(--border)] rounded-xl p-3 bg-[var(--card)]';
                                block.innerHTML = `
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] font-bold text-primary-600 bg-primary-50 px-1 rounded border border-primary-100">${sub}</span>
                                            <span class="text-[10px] text-[var(--sub)] border border-[var(--border)] px-1 rounded">${chap}</span>
                                        </div>
                                        <span class="text-[10px] text-[var(--sub)]">${arr.length} È¢ò</span>
                                    </div>
                                `;
                                arr.forEach(q => {
                                    const item = document.createElement('div');
                                    item.className = 'mt-2 p-2 rounded-lg border border-dashed border-[var(--border)] bg-[var(--bg)]';
                                    const timeStr = q.deletedAt ? new Date(q.deletedAt).toLocaleString() : '';
                                    const subKey = encodeURIComponent(sub);
                                    const chapKey = encodeURIComponent(chap);
                                    const idKey = encodeURIComponent(q.id || '');
                                    const safeQuestion = App.utils.escapeHTML(q.q || '');
                                    const safeReason = App.utils.escapeHTML(q.reason || 'Êú™Áü•');
                                    const safePathSub = App.utils.escapeHTML(q.originalPath?.sub || sub);
                                    const safePathChap = App.utils.escapeHTML(q.originalPath?.chap || chap);
                                    item.innerHTML = `
                                        <div class="flex justify-between items-center mb-1">
                                            <div class="text-[10px] text-[var(--sub)]">ID: ${q.id}</div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-[10px] text-[var(--sub)]">${timeStr}</span>
                                                <button class="px-2 py-0.5 rounded border border-emerald-200 bg-emerald-50 text-emerald-600 text-[10px] font-bold"
                                                    data-action="restore" data-sub="${subKey}" data-chap="${chapKey}" data-id="${idKey}">
                                                    ÊÅ¢Â§ç
                                                </button>
                                                <button class="px-2 py-0.5 rounded border border-red-200 bg-red-50 text-red-600 text-[10px] font-bold"
                                                    data-action="destroy" data-sub="${subKey}" data-chap="${chapKey}" data-id="${idKey}">
                                                    ÂΩªÂ∫ïÂà†Èô§
                                                </button>
                                            </div>
                                        </div>
                                        <div class="text-[11px] font-medium text-[var(--text)] mb-1">${safeQuestion}</div>
                                        <div class="text-[10px] text-[var(--sub)]">Âà†Èô§ÂéüÂõ†Ôºö${safeReason} / Ë∑ØÂæÑÔºö${safePathSub} - ${safePathChap}</div>
                                    `;
                                    block.appendChild(item);
                                });
                                list.appendChild(block);
                            });
                        });
                    }

                    modal.classList.remove('hidden');
                    setTimeout(() => modal.classList.remove('opacity-0', 'pointer-events-none'), 10);
                },

                openBankManager() {
                    if (typeof this.closeModal === 'function') {
                        this.closeModal('config');
                    }
                    const modal = App.dom.get('modal-bank-manager');
                    if (!modal) return;
                    if (!this._bankMgrBound) {
                        const subList = App.dom.get('bank-manager-subject-list');
                        const chapList = App.dom.get('bank-manager-chapter-list');
                        if (subList) {
                            subList.addEventListener('click', (e) => {
                                const btn = e.target.closest('button[data-action]');
                                if (!btn) return;
                                const action = btn.dataset.action;
                                const sub = btn.dataset.sub ? decodeURIComponent(btn.dataset.sub) : '';
                                if (!sub) return;
                                if (action === 'select-sub') {
                                    this._bankMgrCurrentSubject = sub;
                                    this.renderBankManager();
                                } else if (action === 'rename-sub') {
                                    App.data.renameSubjectInteractive(sub);
                                } else if (action === 'delete-sub') {
                                    App.data.deleteSubjectInteractive(sub);
                                }
                            });
                        }
                        if (chapList) {
                            chapList.addEventListener('click', (e) => {
                                const btn = e.target.closest('button[data-action]');
                                if (!btn) return;
                                const action = btn.dataset.action;
                                const sub = btn.dataset.sub ? decodeURIComponent(btn.dataset.sub) : '';
                                const chap = btn.dataset.chap ? decodeURIComponent(btn.dataset.chap) : '';
                                if (!sub || !chap) return;
                                if (action === 'rename-chap') {
                                    App.data.renameChapterInteractive(sub, chap);
                                } else if (action === 'delete-chap') {
                                    App.data.deleteChapterInteractive(sub, chap);
                                }
                            });
                        }
                        this._bankMgrBound = true;
                    }
                    const subjects = App.data.getSubjects();
                    if (!this._bankMgrCurrentSubject || subjects.indexOf(this._bankMgrCurrentSubject) === -1) {
                        this._bankMgrCurrentSubject = subjects[0] || '';
                    }
                    this.renderBankManager();
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.remove('opacity-0', 'pointer-events-none');
                    }, 10);
                },

                closeBankManager() {
                    const modal = App.dom.get('modal-bank-manager');
                    if (!modal) return;
                    modal.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => modal.classList.add('hidden'), 150);
                },

                renderBankManager() {
                    const subList = App.dom.get('bank-manager-subject-list');
                    const chapList = App.dom.get('bank-manager-chapter-list');
                    const currentLabel = App.dom.get('bank-manager-current-subject');
                    if (!subList || !chapList || !currentLabel) return;
                    const subjects = App.data.getSubjects();
                    if (!subjects.length) {
                        subList.innerHTML = '<div class="text-[10px] text-[var(--sub)] py-4 text-center">ÂΩìÂâçÊ≤°ÊúâÁßëÁõÆÔºåËØ∑ÂÖàÂØºÂÖ•ÊàñÊñ∞Â¢ûÈ¢òÁõÆ„ÄÇ</div>';
                        chapList.innerHTML = '<div class="text-[10px] text-[var(--sub)] py-4 text-center">ÊöÇÊó†Á´†ËäÇ„ÄÇ</div>';
                        currentLabel.textContent = '';
                        return;
                    }
                    const current = this._bankMgrCurrentSubject && subjects.indexOf(this._bankMgrCurrentSubject) !== -1
                        ? this._bankMgrCurrentSubject
                        : subjects[0];
                    this._bankMgrCurrentSubject = current;
                    currentLabel.textContent = current;
                    let subHtml = '';
                    subjects.forEach(sub => {
                        const chaps = App.data.getChapters(sub);
                        const total = chaps.reduce((n, chap) => {
                            const arr = App.data.bank[sub] && App.data.bank[sub][chap];
                            return n + (Array.isArray(arr) ? arr.length : 0);
                        }, 0);
                        const activeClass = sub === current ? 'border-primary-300 bg-primary-50' : 'border-[var(--border)] bg-[var(--card)]';
                        subHtml += `
                            <div class="flex items-center justify-between px-3 py-2 rounded-xl border ${activeClass}">
                                <div class="flex flex-col">
                                    <span class="text-[11px] font-bold text-[var(--text)]">${App.utils.escapeHTML(sub)}</span>
                                    <span class="text-[10px] text-[var(--sub)]">${chaps.length} Á´†ËäÇ ¬∑ ${total} È¢ò</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <button data-action="select-sub" data-sub="${encodeURIComponent(sub)}" class="px-2 py-1 rounded-lg text-[10px] border border-[var(--border)]">Êü•Áúã</button>
                                    <button data-action="rename-sub" data-sub="${encodeURIComponent(sub)}" class="px-2 py-1 rounded-lg text-[10px] border border-blue-200 text-blue-600 bg-blue-50">ÈáçÂëΩÂêç</button>
                                    <button data-action="delete-sub" data-sub="${encodeURIComponent(sub)}" class="px-2 py-1 rounded-lg text-[10px] border border-red-200 text-red-600 bg-red-50">Âà†Èô§</button>
                                </div>
                            </div>
                        `;
                    });
                    subList.innerHTML = subHtml;

                    const chapters = App.data.getChapters(current);
                    if (!chapters.length) {
                        chapList.innerHTML = '<div class="text-[10px] text-[var(--sub)] py-4 text-center">ËØ•ÁßëÁõÆÊöÇÊó†Á´†ËäÇ„ÄÇ</div>';
                        return;
                    }
                    let chapHtml = '';
                    chapters.forEach(chap => {
                        const arr = App.data.bank[current] && App.data.bank[current][chap];
                        const count = Array.isArray(arr) ? arr.length : 0;
                        chapHtml += `
                            <div class="flex items-center justify-between px-3 py-2 rounded-xl border border-[var(--border)] bg-[var(--card)]">
                                <div class="flex flex-col">
                                    <span class="text-[11px] font-bold text-[var(--text)]">${App.utils.escapeHTML(chap)}</span>
                                    <span class="text-[10px] text-[var(--sub)]">${count} È¢ò</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <button data-action="rename-chap" data-sub="${encodeURIComponent(current)}" data-chap="${encodeURIComponent(chap)}" class="px-2 py-1 rounded-lg text-[10px] border border-blue-200 text-blue-600 bg-blue-50">ÈáçÂëΩÂêç</button>
                                    <button data-action="delete-chap" data-sub="${encodeURIComponent(current)}" data-chap="${encodeURIComponent(chap)}" class="px-2 py-1 rounded-lg text-[10px] border border-red-200 text-red-600 bg-red-50">Âà†Èô§</button>
                                </div>
                            </div>
                        `;
                    });
                    chapList.innerHTML = chapHtml;
                },

                _bankMgrBound: false,
                _bankMgrCurrentSubject: ''
            },
            sync: {
                _lastStatus: 'success',
                _realtimeDisconnected: false,
                _lastMessage: '',
                _lastSyncDebug: null,
                render() {
                    const btn = App.dom.get('save-cloud-btn');
                    const icon = document.getElementById('sync-indicator-icon');
                    if (!btn || !icon) return;
                    btn.classList.remove('border-[var(--border)]', 'bg-[var(--card)]', 'border-primary-500', 'border-emerald-400', 'border-red-400', 'border-yellow-400');
                    icon.classList.remove('bg-emerald-500', 'bg-red-500', 'bg-yellow-500', 'text-white');
                    let titleText = '';
                    if (this._lastStatus === 'error') {
                        btn.classList.add('border-red-400');
                        icon.classList.add('bg-red-500', 'text-white');
                        icon.textContent = '!';
                        titleText = 'ÊúÄËøëÂêåÊ≠•ÔºöÂ§±Ë¥•Ôºà' + (this._lastMessage || 'ÂêåÊ≠•Â§±Ë¥•') + 'Ôºâ';
                    } else if (this._lastStatus === 'pending') {
                        btn.classList.add('border-primary-500');
                        icon.textContent = '‚Ä¶';
                        titleText = 'ÂêåÊ≠•‰∏≠...';
                    } else if (this._realtimeDisconnected) {
                        btn.classList.add('border-yellow-400');
                        icon.classList.add('bg-yellow-500', 'text-white');
                        icon.textContent = '!';
                        titleText = 'ÂÆûÊó∂ÈÄöÈÅìÊú™ËøûÊé•' + (this._lastMessage ? 'Ôºà' + this._lastMessage + 'Ôºâ' : '');
                    } else {
                        btn.classList.add('border-emerald-400');
                        icon.classList.add('bg-emerald-500', 'text-white');
                        icon.textContent = '‚úì';
                        titleText = 'ÊúÄËøëÂêåÊ≠•ÔºöÊàêÂäü';
                    }
                    btn.title = titleText;
                },
                setStatus(status, delta, message) {
                    this._lastStatus = status || 'success';
                    this._lastMessage = message || '';
                    this.render();
                },
                setDebug(info) {
                    this._lastSyncDebug = info;
                },
                showSyncStatus(status, delta, message) {
                    this.setStatus(status, delta, message);
                    if (status === 'error') {
                        const toast = document.getElementById('sync-toast');
                        if (toast) {
                            toast.textContent = message || 'ÂêåÊ≠•Â§±Ë¥•';
                            toast.classList.remove('opacity-0');
                            toast.classList.add('opacity-100');
                            if (this._toastTimer) {
                                clearTimeout(this._toastTimer);
                            }
                            this._toastTimer = setTimeout(() => {
                                toast.classList.add('opacity-0');
                                toast.classList.remove('opacity-100');
                            }, 5000);
                        }
                    }
                },
                async openLogPanel() {
                    if (!App.auth || typeof App.auth.getToken !== 'function') return;
                    const token = await App.auth.getToken();
                    if (!token) return;
                    let res;
                    try {
                        res = await fetch((App.apiBase || '') + '/api/sync-logs', {
                            method: 'GET',
                            headers: {
                                Authorization: 'Bearer ' + token
                            }
                        });
                    } catch (e) {
                        console.error('Ëé∑ÂèñÂêåÊ≠•ËÆ∞ÂΩïÂ§±Ë¥•', e);
                        return;
                    }
                    if (!res.ok) {
                        console.error('Ëé∑ÂèñÂêåÊ≠•ËÆ∞ÂΩïÂ§±Ë¥•', res.status);
                        return;
                    }
                    let data;
                    try {
                        data = await res.json();
                    } catch (e) {
                        console.error('Ëß£ÊûêÂêåÊ≠•ËÆ∞ÂΩïÂ§±Ë¥•', e);
                        return;
                    }
                    const list = document.getElementById('sync-log-list');
                    const modal = document.getElementById('sync-log-modal');
                    const debugPanel = document.getElementById('sync-debug-panel');
                    if (!list || !modal) return;
                    if (debugPanel) {
                        const dbg = this._lastSyncDebug;
                        if (!dbg) {
                            debugPanel.innerHTML = '<div class="text-[var(--sub)]">ÊöÇÊó†ËØäÊñ≠‰ø°ÊÅØ</div>';
                        } else {
                            const time = dbg.time ? new Date(dbg.time).toLocaleString() : '';
                            debugPanel.innerHTML = `
                                <div class="flex flex-col gap-1">
                                    <div class="text-[10px] uppercase tracking-wider text-[var(--sub)]">ÂêåÊ≠•ËØäÊñ≠</div>
                                    <div>Êó∂Èó¥Ôºö${App.utils.escapeHTML(time)}</div>
                                    <div>È¢òÂ∫ìÔºö${App.utils.escapeHTML(dbg.name || '')}</div>
                                    <div>questions=${dbg.questionsCount} / history=${dbg.historyCount} / trash=${dbg.trashCount}</div>
                                    <div>skipQuestionsUpdate=${dbg.skipQuestionsUpdate ? 'true' : 'false'} / version=${dbg.version}</div>
                                </div>
                            `;
                        }
                    }
                    list.innerHTML = '';
                    const logs = data && data.ok && Array.isArray(data.logs) ? data.logs : [];
                    if (!logs.length) {
                        list.innerHTML = '<div class="text-[var(--sub)] text-xs py-4 text-center">ÊöÇÊó†ÂêåÊ≠•ËÆ∞ÂΩï</div>';
                    } else {
                        logs.forEach(l => {
                            const line = document.createElement('div');
                            line.className = 'flex flex-col gap-1 px-3 py-2 border-b border-[var(--border)]';
                            const time = l.created_at ? new Date(l.created_at).toLocaleString() : '';
                            const status = l.status || 'unknown';
                            const delta = l.delta || {};
                            const qd = delta.questions || 0;
                            const hd = delta.history || 0;
                            const td = delta.trash || 0;
                            const statusText = status === 'success' ? 'ÊàêÂäü' : status === 'error' ? 'Â§±Ë¥•' : status;
                            const statusColor = status === 'success' ? 'text-emerald-500' : status === 'error' ? 'text-red-500' : 'text-[var(--sub)]';
                            line.innerHTML = `
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-[var(--sub)]">${time}</span>
                                    <span class="${statusColor} font-bold">${statusText}</span>
                                </div>
                                <div class="text-[10px] text-[var(--sub)]">
                                    È¢òÂ∫ìÂèòÂåñ ${qd >= 0 ? '+' : ''}${qd}ÔºåËÆ∞ÂΩïÂèòÂåñ ${hd >= 0 ? '+' : ''}${hd}${td ? `ÔºåÂõûÊî∂Á´ôÂèòÂåñ ${td >= 0 ? '+' : ''}${td}` : ''}
                                </div>
                                ${l.error ? `<div class="text-[10px] text-red-500">ÈîôËØØÔºö${App.utils.escapeHTML(l.error)}</div>` : ''}
                            `;
                            list.appendChild(line);
                        });
                    }
                    modal.classList.remove('hidden');
                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    if (!modal.dataset.bound) {
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) {
                                App.sync.closeLogPanel();
                            }
                        });
                        modal.dataset.bound = '1';
                    }
                },
                closeLogPanel() {
                    const modal = document.getElementById('sync-log-modal');
                    if (!modal) return;
                    modal.classList.add('opacity-0', 'pointer-events-none');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 200);
                },
                startAutoPull(intervalMs) {
                    // Bug #16 fix: ËΩÆËØ¢ÂõûÈÄÄÊú∫Âà∂ÔºåÂΩì WebSocket/Ably ‰∏çÂèØÁî®Êó∂ÂÆöÊúüÊãâÂèñÊõ¥Êñ∞
                    this.stopAutoPull();
                    const interval = intervalMs || 60000; // ÈªòËÆ§ 60 Áßí
                    this._pollTimer = setInterval(() => {
                        if (window.App && App.data && typeof App.data.loadFromCloud === 'function') {
                            App.data.loadFromCloud();
                        }
                    }, interval);
                },
                stopAutoPull() {
                    if (this._pollTimer) {
                        clearInterval(this._pollTimer);
                        this._pollTimer = null;
                    }
                },
                _toastTimer: null,
                _pollTimer: null
            },
            realtime: {
                client: null,
                channel: null,
                ws: null,
                mode: null,
                setup(userId, token) {
                    if (!userId || !token) return;
                    if (this.mode) return;
                    const wsUrl = (window.REALTIME_WS_URL || '').trim();
                    if (wsUrl) {
                        this.mode = 'ws';
                        this._setupWebSocket(wsUrl, userId, token);
                    } else if (window.Ably) {
                        this.mode = 'ably';
                        this._setupAbly(userId, token);
                    }
                },
                _setDisconnected(msg) {
                    if (window.App && App.sync && typeof App.sync.render === "function") {
                        App.sync._realtimeDisconnected = true;
                        App.sync._lastMessage = msg || '';
                        App.sync.render();
                    }
                },
                _setConnected() {
                    if (window.App && App.sync && typeof App.sync.render === "function") {
                        App.sync._realtimeDisconnected = false;
                        App.sync._lastMessage = '';
                        App.sync.render();
                    }
                },
                _wsReconnectDelay: 1000,
                _wsMaxReconnectDelay: 30000,
                _wsReconnectTimer: null,
                _setupWebSocket(baseUrl, userId, token) {
                    // Ê∏ÖÈô§‰πãÂâçÁöÑÈáçËøûËÆ°Êó∂Âô®
                    if (this._wsReconnectTimer) {
                        clearTimeout(this._wsReconnectTimer);
                        this._wsReconnectTimer = null;
                    }
                    try {
                        let url = baseUrl;
                        try {
                            const u = new URL(baseUrl);
                            u.searchParams.set('userId', userId);
                            u.searchParams.set('token', token);
                            url = u.toString();
                        } catch (e) {
                            const sep = baseUrl.includes('?') ? '&' : '?';
                            url = `${baseUrl}${sep}userId=${encodeURIComponent(userId)}&token=${encodeURIComponent(token)}`;
                        }
                        const ws = new WebSocket(url);
                        this.ws = ws;
                        ws.onopen = () => {
                            this._setConnected();
                            // ËøûÊé•ÊàêÂäüÔºåÈáçÁΩÆÈáçËøûÂª∂Ëøü
                            this._wsReconnectDelay = 1000;
                        };
                        ws.onmessage = (evt) => {
                            let data = null;
                            try {
                                data = JSON.parse(evt.data);
                            } catch (e) { }
                            if (!data || typeof data !== 'object') return;
                            if (data.type === 'set-updated') {
                                if (window.App && App.data && typeof App.data.loadFromCloud === "function") {
                                    App.data.loadFromCloud();
                                }
                            }
                        };
                        ws.onclose = () => {
                            this._setDisconnected('');
                            this.ws = null;
                            // Bug #2 fix: ÊåáÊï∞ÈÄÄÈÅøËá™Âä®ÈáçËøû
                            this._scheduleReconnect(baseUrl, userId, token);
                        };
                        ws.onerror = () => {
                            this._setDisconnected('Realtime gateway error');
                        };
                    } catch (e) {
                        this._setDisconnected('ÂàùÂßãÂåñÂÆûÊó∂ËøûÊé•Â§±Ë¥•');
                        this._scheduleReconnect(baseUrl, userId, token);
                    }
                },
                _scheduleReconnect(baseUrl, userId, token) {
                    if (this._wsReconnectTimer) return;
                    const delay = this._wsReconnectDelay;
                    console.log(`[Realtime] WebSocket will reconnect in ${delay}ms`);
                    this._wsReconnectTimer = setTimeout(() => {
                        this._wsReconnectTimer = null;
                        // ÊåáÊï∞ÈÄÄÈÅøÔºöÊØèÊ¨°ÈáçËøûÂ§±Ë¥•ÂêéÂª∂ËøüÁøªÂÄçÔºåÊúÄÂ§ß 30 Áßí
                        this._wsReconnectDelay = Math.min(this._wsReconnectDelay * 2, this._wsMaxReconnectDelay);
                        this._setupWebSocket(baseUrl, userId, token);
                    }, delay);
                },
                _setupAbly(userId, token) {
                    if (!window.Ably) return;
                    try {
                        this.client = new Ably.Realtime({
                            authUrl: (App.apiBase || "") + "/api/ably-auth",
                            authHeaders: { Authorization: "Bearer " + token },
                            transports: ["web_socket", "xhr_streaming", "xhr_polling"],
                            connectTimeout: 15000,
                            tls: true
                        });
                        this.client.connection.on("connected", () => {
                            this._setConnected();
                            this.channel = this.client.channels.get("user:" + userId);
                            this.channel.subscribe("question-set-updated", () => {
                                if (window.App && App.data && typeof App.data.loadFromCloud === "function") {
                                    App.data.loadFromCloud();
                                }
                            });
                        });
                        ["disconnected", "suspended", "closing", "closed", "failed"].forEach((evt) => {
                            this.client.connection.on(evt, (stateChange) => {
                                let reasonMsg = '';
                                if (stateChange && stateChange.reason) {
                                    reasonMsg = stateChange.reason.message || String(stateChange.reason);
                                }
                                this._setDisconnected(reasonMsg);
                            });
                        });
                    } catch (e) {
                        this._setDisconnected('ÂàùÂßãÂåñÂÆûÊó∂ËøûÊé•Â§±Ë¥•');
                    }
                },
                teardown() {
                    if (this.ws) {
                        try {
                            this.ws.close();
                        } catch (e) { }
                        this.ws = null;
                    }
                    if (this.channel) {
                        try {
                            this.channel.unsubscribe();
                        } catch (e) { }
                        this.channel = null;
                    }
                    if (this.client) {
                        try {
                            this.client.close();
                        } catch (e) { }
                        this.client = null;
                    }
                    this.mode = null;
                }
            },

            init() {
                this.data.init();
                this.ui.initTheme();
                this.auth.init();
                this.ai.init();
                this.router.init();
                this.ui._initGlobalBackTop();
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            window.App = App;
            App.init();
            window.addEventListener('storage', (e) => {
                if (!e.key) return;
                // Bug #13 fix: ‰ªÖÂú®Ê†∏ÂøÉÊï∞ÊçÆÈîÆÂèòÊõ¥Êó∂ÂºπÂá∫Á°ÆËÆ§Ê°Ü
                const dataKeys = [
                    App.data && App.data.bankKey,
                    App.data && App.data.historyKey,
                    App.data && App.data.trashKey
                ].filter(Boolean);
                if (!dataKeys.includes(e.key)) return;
                const shouldReload = window.confirm(
                    'Ê£ÄÊµãÂà∞ÂÖ∂‰ªñÊ†áÁ≠æÈ°µ‰øÆÊîπ‰∫ÜÈ¢òÂ∫ìÊï∞ÊçÆ„ÄÇ\n\nÁÇπÂáª‚ÄúÁ°ÆÂÆö‚ÄùÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÊ†áÁ≠æÈ°µÁöÑÊï∞ÊçÆÔºåÁÇπÂáª‚ÄúÂèñÊ∂à‚ÄùÂøΩÁï•Êú¨Ê¨°ÂèòÊõ¥„ÄÇ'
                );
                if (!shouldReload) return;
                if (window.App && App.data && typeof App.data.init === 'function') {
                    App.data.init();
                }
                if (window.App && App.router && typeof App.router.go === 'function') {
                    const view = App.router.currentView || 'dashboard';
                    App.router.go(view);
                }
            });
        });
    </script>
    <script>
        window.SUPABASE_URL = window.SUPABASE_URL || '';
        window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '';
        window.addEventListener("DOMContentLoaded", function () {
            const saveBtn = document.getElementById("save-cloud-btn");
            const overlayLoginBtn = document.getElementById("auth-overlay-login-btn");
            const authBtn = document.getElementById("auth-btn");
            const loginBtn = document.getElementById("auth-login-btn");
            const signupBtn = document.getElementById("auth-signup-btn");
            const emailInput = document.getElementById("auth-email");
            const passwordInput = document.getElementById("auth-password");
            const statusEl = document.getElementById("auth-status");
            const showStatus = (msg) => { if (statusEl) statusEl.textContent = msg || ''; };
            if (saveBtn) {
                saveBtn.addEventListener("contextmenu", function (e) {
                    e.preventDefault();
                    if (window.App && App.sync && typeof App.sync.openLogPanel === "function") {
                        App.sync.openLogPanel();
                    }
                });
            }
            const openAuthModal = () => {
                if (window.App && App.ui && typeof App.ui.toggleModal === "function") {
                    App.ui.toggleModal('auth');
                }
            };
            if (authBtn) {
                authBtn.addEventListener("click", function () {
                    if (window.App && App.auth && App.auth.session) {
                        App.auth.logout();
                    } else {
                        openAuthModal();
                    }
                });
            }
            if (overlayLoginBtn) {
                overlayLoginBtn.addEventListener("click", function () {
                    openAuthModal();
                });
            }
            if (loginBtn) {
                loginBtn.addEventListener("click", async function () {
                    const loginId = emailInput ? emailInput.value.trim() : '';
                    const password = passwordInput ? passwordInput.value : '';
                    if (!loginId || !password) {
                        showStatus('ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å');
                        return;
                    }
                    showStatus('ÁôªÂΩï‰∏≠...');
                    const { error } = await App.auth.login(loginId, password);
                    if (error) {
                        showStatus(error.message || 'ÁôªÂΩïÂ§±Ë¥•');
                        return;
                    }
                    showStatus('ÁôªÂΩïÊàêÂäü');
                    if (window.App && App.ui && typeof App.ui.closeModal === "function") {
                        App.ui.closeModal('auth');
                    }
                });
            }
            if (signupBtn) {
                signupBtn.addEventListener("click", async function () {
                    const loginId = emailInput ? emailInput.value.trim() : '';
                    const password = passwordInput ? passwordInput.value : '';
                    if (!loginId || !password) {
                        showStatus('ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å');
                        return;
                    }
                    showStatus('Ê≥®ÂÜå‰∏≠...');
                    const { error } = await App.auth.signup(loginId, password);
                    if (error) {
                        const msg = /already registered/i.test(error.message || '') ? 'ËØ•Áî®Êà∑ÂêçÂ∑≤Ë¢´Ê≥®ÂÜå' : (error.message || 'Ê≥®ÂÜåÂ§±Ë¥•');
                        showStatus(msg);
                        return;
                    }
                    showStatus('Ê≥®ÂÜåÊàêÂäüÔºåÂèØ‰ª•Áõ¥Êé•‰ΩøÁî®ËØ•Áî®Êà∑ÂêçÁôªÂΩï');
                });
            }
        });
    </script>
</body>

</html>